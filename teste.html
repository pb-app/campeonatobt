<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Beach Tennis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        
        /* Animação de fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-fade-in-sm {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Para esconder elementos */
        .hidden {
            display: none;
        }

        /* Melhorias no Scrollbar (Opcional) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; /* bg-gray-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; /* bg-gray-600 */
        }
    </style>
</head>
<body class="text-white">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 gap-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400 text-center sm:text-left">
                Ranking Beach Tennis
            </h1>
            <div id="header-buttons" class="flex gap-3">
                </div>
        </header>

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto"></div>
            <p class="mt-4 text-gray-300">Carregando dados...</p>
        </div>

        <main id="main-content" class="hidden">
            </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>ID da Liga: <span id="user-id-footer">Conectando...</span></p>
            <p>App de Ranking v2.6 (Admin/Visitante)</p>
            <button id="logout-btn" class="hidden text-red-400 hover:text-red-300 transition-colors mt-2">Sair (Admin)</button>
        </footer>

    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 max-w-sm w-full mx-auto animate-fade-in-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-cyan-400"></h3>
                <button id="modal-close-icon" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <p id="modal-message" class="text-gray-200 text-sm sm:text-base mb-6"></p>
            <button
                id="modal-close-btn"
                class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                Entendi
            </button>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            deleteDoc, 
            query,
            Timestamp,
            getDoc,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* =============================================================================
            Configuração do Firebase (Fornecida pelo usuário)
            ============================================================================= */
        const firebaseConfig = {
            apiKey: "AIzaSyDeS-rk8OJKhghv1djVucmR3-erOa-ppMY",
            authDomain: "campeonato-sortudo.firebaseapp.com",
            projectId: "campeonato-sortudo",
            storageBucket: "campeonato-sortudo.firebasestorage.app",
            messagingSenderId: "706083235199",
            appId: "1:706083235199:web:5eca6041bb817401ee264a"
        };
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); 

        /* =============================================================================
            ID Mestre e Senha de Admin
            ============================================================================= */
        const MESTRE_USER_ID = "campeonato-sortudo-admin";
        
        // NOVO: Senha de Admin
        // TROQUE ESTA SENHA por uma senha segura!
        const ADMIN_PASSWORD = "admin"; 

        /* =============================================================================
            Estado Global do Aplicativo
            ============================================================================= */
        let appState = {
            userId: null, // Será preenchido com o MESTRE_USER_ID
            isAuthReady: false,
            // MODIFICADO: A view inicial agora é 'auth' (login)
            currentView: 'auth', // 'auth', 'loading', 'championshipList', 'championshipView', 'globalRanking'
            currentChampionshipId: null,
            // NOVO: Estado de Admin
            isAdmin: false 
        };

        let championships = []; // Lista de todos os campeonatos
        let globalPlayers = []; // Lista para o ranking global
        let activeChampionship = null; // Dados do campeonato selecionado
        
        // Listeners do Firebase (para poder "desligar" ao trocar de tela)
        let unsubscribeChampionships = () => {}; 
        let unsubscribeGlobalPlayers = () => {}; 
        let unsubscribeActiveChampionship = () => {}; 

        /* =============================================================================
            Referências do DOM
            ============================================================================= */
        const mainContent = document.getElementById('main-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const headerButtons = document.getElementById('header-buttons');
        const userIdFooter = document.getElementById('user-id-footer');
        // NOVO: Botão de Logout
        const logoutBtn = document.getElementById('logout-btn');
        
        // Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');

        /* =============================================================================
            Constantes de Pontuação (Padrão)
            ============================================================================= */
        const DEFAULT_RANKING_POINTS = {
            GOLD_WINNER: 100,
            GOLD_RUNNERUP: 70,
            SILVER_WINNER: 40,
            SILVER_RUNNERUP: 20,
            PARTICIPATION: 5
        };

        /* =============================================================================
            Ícones SVG (Reutilizados)
            ============================================================================= */
        const icons = {
            users: '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            swords: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></line><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"></polyline><line x1="11" y1="5" x2="5" y2="11"></line><line x1="8" y1="8" x2="4" y2="4"></line><line x1="3" y1="5" x2="5" y2="3"></line></svg>',
            trophy: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>',
            shield: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-yellow-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
            shieldOff: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-gray-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>',
            medal: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3 text-white"><path d="M12 16.5l4-2.3 4 2.3-1.5-4.6 3.5-3.4-4.6-.7-2-4.2-2 4.2-4.6.7 3.5 3.4L8 16.5z"></path><path d="M12 15l-4-2.3V7.9l4 2.3 4-2.3v4.8L12 15z"></path></svg>',
            award: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>',
            arrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
            eye: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
        };

        /* =============================================================================
            Funções do Modal
            ============================================================================= */
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        };
        const hideModal = () => modal.classList.add('hidden');
        modalCloseBtn.addEventListener('click', hideModal);
        modalCloseIcon.addEventListener('click', hideModal);
        modal.addEventListener('click', hideModal);
        modal.firstElementChild.addEventListener('click', (e) => e.stopPropagation());

        /* =============================================================================
            Funções de Navegação e Renderização Principal
            ============================================================================= */
        
        // Router Principal
        const render = () => {
            // Garante que ícones sejam recriados após cada renderização
            lucide.createIcons();
            
            // Esconde o spinner global se não estivermos na tela de loading
            if (appState.currentView !== 'loading') {
                loadingSpinner.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                loadingSpinner.classList.remove('hidden');
                mainContent.classList.add('hidden');
                return;
            }

            // MODIFICADO: Só mostra botões do cabeçalho se não estiver na tela de login
            if (appState.currentView !== 'auth') {
                renderHeaderButtons();
            } else {
                headerButtons.innerHTML = ''; // Limpa botões na tela de login
            }
            
            // NOVO: Mostra/esconde o botão de logout
            if (appState.isAdmin) {
                logoutBtn.classList.remove('hidden');
            } else {
                logoutBtn.classList.add('hidden');
            }

            // Renderiza o conteúdo principal baseado na view
            switch (appState.currentView) {
                // NOVO: Case para a tela de autenticação
                case 'auth':
                    renderAuthScreen();
                    break;
                case 'championshipList':
                    renderChampionshipList();
                    break;
                case 'globalRanking':
                    renderGlobalRanking();
                    break;
                case 'championshipView':
                    renderChampionshipView();
                    break;
                default:
                    mainContent.innerHTML = `<p>Estado desconhecido: ${appState.currentView}</p>`;
            }
            // Recria os ícones do Lucide
            lucide.createIcons();
        };

        const navigateTo = (view, champId = null) => {
            appState.currentView = view;
            appState.currentChampionshipId = champId;

            // Desliga listeners antigos
            unsubscribeActiveChampionship();
            activeChampionship = null;

            // Liga novo listener se estivermos entrando em um campeonato
            if (view === 'championshipView' && champId) {
                listenToActiveChampionship(champId);
            } else {
                // Se não estivermos em um torneio, renderiza imediatamente
                render();
            }
        };

        const renderHeaderButtons = () => {
            let html = '';
            if (appState.currentView === 'championshipList') {
                html = `
                <button
                    id="nav-to-ranking"
                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.award}
                    Ranking Geral
                </button>
                `;
            } else if (appState.currentView === 'globalRanking' || appState.currentView === 'championshipView') {
                html = `
                <button
                    id="nav-to-list"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.arrowLeft}
                    Voltar
                </button>
                `;
            }
            headerButtons.innerHTML = html;

            // Adiciona listeners aos botões
            const rankingBtn = document.getElementById('nav-to-ranking');
            if (rankingBtn) rankingBtn.addEventListener('click', () => navigateTo('globalRanking'));

            const listBtn = document.getElementById('nav-to-list');
            if (listBtn) listBtn.addEventListener('click', () => navigateTo('championshipList'));
        };

        /* =============================================================================
            NOVA TELA: Autenticação (Login)
            ============================================================================= */
        
        const renderAuthScreen = () => {
            mainContent.innerHTML = `
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 max-w-md mx-auto animate-fade-in">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Acessar Painel</h2>
                    
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="password-input" class="block text-sm font-medium text-gray-300 mb-1">Senha de Administrador</label>
                            <input
                                type="password"
                                id="password-input"
                                class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            id="login-btn"
                            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 mb-4">
                            Entrar como Admin
                        </button>
                    </form>
                    
                    <button
                        id="visitor-btn"
                        type="button"
                        class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                        ${icons.eye} Ver como Visitante
                    </button>
                </div>
            `;

            // Listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('visitor-btn').addEventListener('click', () => {
                appState.isAdmin = false;
                navigateTo('championshipList');
            });
        };

        const handleLogin = (e) => {
            e.preventDefault();
            const input = document.getElementById('password-input');
            const password = input.value;

            if (password === ADMIN_PASSWORD) {
                appState.isAdmin = true;
                navigateTo('championshipList');
            } else {
                showModal("Erro", "Senha incorreta.");
                input.value = '';
            }
        };

        // NOVO: Função de Logout
        const handleLogout = () => {
            if (confirm("Deseja sair do modo Administrador?")) {
                appState.isAdmin = false;
                navigateTo('auth'); // Volta para a tela de login
            }
        };
        logoutBtn.addEventListener('click', handleLogout);


        /* =============================================================================
            TELA 1: Lista de Campeonatos (Histórico)
            ============================================================================= */
        
        const renderChampionshipList = () => {
            const sortedChampionships = [...championships].sort((a, b) => b.createdAt - a.createdAt);
            
            const championshipsListHtml = sortedChampionships.length === 0
                ? `<p class="text-gray-400 text-center py-4">Nenhum campeonato cadastrado.</p>`
                : sortedChampionships.map(champ => {
                    let statusColor = 'text-yellow-400';
                    let statusText = 'Em andamento';
                    if (champ.status === 'registration') { statusColor = 'text-cyan-400'; statusText = 'Em Inscrição'; }
                    if (champ.status === 'finished') { statusColor = 'text-green-400'; statusText = 'Finalizado'; }

                    return `
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg animate-fade-in-sm gap-3">
                        <div>
                            <span class="text-white font-bold text-lg">${champ.name}</span>
                            <span class="block text-sm ${statusColor}">${statusText}</span>
                            <span class="block text-xs text-gray-400">${new Date(champ.createdAt?.toDate()).toLocaleDateString()}</span>
                        </div>
                        <div class="flex gap-2">
                             <button
                                class="open-champ-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm"
                                data-id="${champ.id}">
                                ${icons.eye} Ver
                            </button>
                            ${appState.isAdmin && champ.status !== 'finished' ? `
                            <button
                                class="delete-champ-btn text-red-400 hover:text-red-300 transition-colors p-2 rounded-lg bg-gray-800"
                                data-id="${champ.id}">
                                ${icons.trash}
                            </button>` : ''}
                        </div>
                    </div>
                    `}).join('');

            // MODIFICADO: Só renderiza o formulário de "Novo Campeonato" se for admin
            const newChampionshipFormHtml = appState.isAdmin ? `
                <form id="add-championship-form">
                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mb-8">
                        <h2 class="text-2xl font-bold text-cyan-400 mb-4">Novo Campeonato</h2>
                        
                        <div class="mb-4">
                            <label for="championship-name-input" class="block text-sm font-medium text-gray-300 mb-1">Nome do Campeonato</label>
                            <input
                                type="text"
                                id="championship-name-input"
                                placeholder="ex: Torneio de Verão"
                                class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                required
                            />
                        </div>

                        <h3 class="text-lg font-semibold text-gray-200 mb-3">Configuração de Pontos</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                            <div>
                                <label for="points-gold-winner" class="block text-xs font-medium text-green-300 mb-1">Campeão Ouro</label>
                                <input type="number" id="points-gold-winner" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_WINNER}"
                                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white">
                            </div>
                            <div>
                                <label for="points-gold-runnerup" class="block text-xs font-medium text-green-400 mb-1">Vice Ouro</label>
                                <input type="number" id="points-gold-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_RUNNERUP}"
                                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white">
                            </div>
                            <div>
                                <label for="points-silver-winner" class="block text-xs font-medium text-yellow-300 mb-1">Campeão Prata</label>
                                <input type="number" id="points-silver-winner" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_WINNER}"
                                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white">
                            </div>
                            <div>
                                <label for="points-silver-runnerup" class="block text-xs font-medium text-yellow-400 mb-1">Vice Prata</label>
                                <input type="number" id="points-silver-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_RUNNERUP}"
                                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white">
                            </div>
                            <div>
                                <label for="points-participation" class="block text-xs font-medium text-gray-400 mb-1">Participação</label>
                                <input type="number" id="points-participation" min="0" value="${DEFAULT_RANKING_POINTS.PARTICIPATION}"
                                       class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-center text-white">
                            </div>
                        </div>

                        <button
                            type="submit"
                            id="add-championship-btn"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            ${icons.plus}
                            <span>Criar Campeonato</span>
                        </button>
                    </div>
                </form>
            ` : ''; // Se não for admin, não mostra nada

            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    ${newChampionshipFormHtml}

                    <div class="bg-gray-800 bg-opacity-50 rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8">
                        <h3 class="text-2xl font-bold mb-5 text-cyan-400">Histórico de Campeonatos</h3>
                        <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-3">
                            ${championshipsListHtml}
                        </div>
                    </div>
                </div>
            `;

            // Listeners
            // MODIFICADO: Só adiciona o listener se o formulário existir (se for admin)
            if (appState.isAdmin) {
                document.getElementById('add-championship-form').addEventListener('submit', handleAddChampionship);
            }
            document.querySelectorAll('.open-champ-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo('championshipView', btn.dataset.id));
            });
            // MODIFICADO: Só adiciona listeners de delete se for admin
            if (appState.isAdmin) {
                document.querySelectorAll('.delete-champ-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeleteChampionship(btn.dataset.id));
                });
            }
        };

        const handleAddChampionship = async (e) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;
            
            e.preventDefault();
            const input = document.getElementById('championship-name-input');
            const button = document.getElementById('add-championship-btn');
            const champName = input.value.trim();
            if (!champName) return;

            button.disabled = true;
            button.lastChild.textContent = "Criando...";
            
            // Coleta os pontos personalizados
            const pointsConfig = {
                goldWinner: parseInt(document.getElementById('points-gold-winner').value) || 0,
                goldRunnerUp: parseInt(document.getElementById('points-gold-runnerup').value) || 0,
                silverWinner: parseInt(document.getElementById('points-silver-winner').value) || 0,
                silverRunnerUp: parseInt(document.getElementById('points-silver-runnerup').value) || 0,
                participation: parseInt(document.getElementById('points-participation').value) || 0
            };

            try {
                const batch = writeBatch(db);
                const champCollectionRef = collection(db, 'users', appState.userId, 'championships');
                const newChampRef = doc(champCollectionRef);
                const champDataRef = doc(db, 'users', appState.userId, 'championships', newChampRef.id, 'data', 'main');

                batch.set(newChampRef, {
                    name: champName,
                    createdAt: Timestamp.now(),
                    status: 'registration',
                    winnerGold: null,
                    winnerSilver: null,
                    pointsConfig: pointsConfig
                });

                batch.set(champDataRef, {
                    players: [],
                    groups: [],
                    goldBracket: [],
                    silverBracket: [],
                    status: 'registration'
                });

                await batch.commit();

                input.value = '';
                showModal("Sucesso!", `Campeonato "${champName}" criado.`);
            } catch (error) {
                console.error("Erro ao criar campeonato:", error);
                showModal("Erro", "Não foi possível criar o campeonato.");
            }
            
            button.disabled = false;
            button.lastChild.textContent = "Criar Campeonato";
        };

        const handleDeleteChampionship = async (champId) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            const champ = championships.find(c => c.id === champId);
            if (window.prompt(`Para confirmar, digite o nome do campeonato: "${champ.name}"`) !== champ.name) {
                showModal("Cancelado", "A exclusão foi cancelada.");
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main'));
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId));
            } catch (error) {
                console.error("Erro ao excluir campeonato:", error);
                showModal("Erro", "Não foi possível excluir o campeonato.");
            }
        };

        /* =============================================================================
            TELA 2: Ranking Global
            ============================================================================= */

        const renderGlobalRanking = () => {
            // Esta tela é somente leitura, então não precisa de travas.
            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);

            const rankingsHtml = sortedPlayers.length === 0
                ? `<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhum jogador no ranking. Participe de um torneio!</td></tr>`
                : sortedPlayers.map((player, index) => `
                    <tr class="border-b border-gray-700 animate-fade-in-sm">
                        <td class="p-3 sm:p-4 font-bold text-lg text-cyan-400">${index + 1}º</td>
                        <td class="p-3 sm:p-4 font-medium text-white">${player.name}</td>
                        <td class="p-3 sm:p-4 font-bold text-xl text-yellow-300">${player.points || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-green-300">${player.goldWins || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-gray-300">${player.silverWins || 0}</td>
                    </tr>
                `).join('');

            mainContent.innerHTML = `
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6 text-cyan-400 flex items-center gap-3">
                        ${icons.award} Ranking Geral
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-3 sm:p-4 rounded-l-lg">Pos.</th>
                                    <th class="p-3 sm:p-4">Jogador</th>
                                    <th class="p-3 sm:p-4">Pontos</th>
                                    <th class="p-3 sm:p-4 text-center">${icons.trophy} Ouro</th>
                                    <th class="p-3 sm:p-4 text-center rounded-r-lg">${icons.trophy} Prata</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                                ${rankingsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        /* =============================================================================
            TELA 3: Visão do Campeonato
            ============================================================================= */
        
        // Função "Router" da tela do campeonato
        const renderChampionshipView = () => {
            if (!activeChampionship) {
                mainContent.innerHTML = `
                <div class="text-center py-20 animate-fade-in">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-400 mx-auto"></div>
                    <p class="mt-4 text-gray-300">Carregando campeonato...</p>
                </div>
                `;
                return;
            }

            const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
            
            // MODIFICADO: Passa `!appState.isAdmin` para o renderKnockoutView
            // Se o torneio terminou OU se for visitante, renderiza no modo "finalizado" (somente leitura)
            if (champInfo?.status === 'finished') {
                renderKnockoutView(true); // 'true' para modo finalizado/leitura
                return;
            }

            switch (activeChampionship.status) {
                case 'groups':
                    renderGroupStage();
                    break;
                case 'knockout':
                    // MODIFICADO: Se for visitante, renderiza a chave em modo leitura
                    renderKnockoutView(!appState.isAdmin);
                    break;
                case 'registration':
                default:
                    renderPlayerRegistration();
                    break;
            }
        };

        // Salva os dados DO CAMPEONATO ATIVO
        const saveActiveChampionship = async (newChampData) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            if (!appState.userId || !appState.currentChampionshipId) return;
            try {
                const champDataRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId, 'data', 'main');
                await setDoc(champDataRef, newChampData);
            } catch (error) {
                console.error("Erro ao salvar campeonato:", error);
                showModal("Erro", "Não foi possível salvar as alterações.");
            }
        };

        // -- Sub-tela: Registro de Jogadores (do Torneio) --
        const renderPlayerRegistration = () => {
            const playersListHtml = activeChampionship.players.length === 0
                ? `<p class="text-gray-400 text-center py-4">Nenhum jogador cadastrado neste torneio.</p>`
                : activeChampionship.players.map(player => `
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg animate-fade-in-sm">
                        <span class="text-white font-medium">${player.name}</span>
                        ${appState.isAdmin ? `
                        <button class="delete-player-btn text-red-400 hover:text-red-300 transition-colors" data-id="${player.id}">
                            ${icons.trash}
                        </button>
                        ` : ''}
                    </div>
                `).join('');

            const validPlayerCounts = [4, 8, 16, 32];
            const playerCount = activeChampionship.players.length;
            const canGenerate = validPlayerCounts.includes(playerCount);

            // MODIFICADO: Só mostra o botão de gerar se for admin
            const generateButtonHtml = appState.isAdmin && playerCount >= 4
                ? `
                <div class="mt-8 text-center">
                    <button
                        id="generate-champ-btn"
                        type="button"
                        ${!canGenerate ? 'disabled' : ''}
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg shadow-xl transition-all flex items-center justify-center gap-3 text-lg mx-auto ${!canGenerate ? 'opacity-50 cursor-not-allowed' : ''}">
                        ${icons.swords}
                        Gerar Grupos
                    </button>
                    ${!canGenerate ? `<p class="text-yellow-400 text-sm mt-3">O campeonato requer 4, 8, 16 ou 32 jogadores. Você tem ${playerCount}.</p>` : ''}
                </div>
                ` : '';
            
            // MODIFICADO: Só mostra o formulário de adicionar se for admin
            const addPlayerFormHtml = appState.isAdmin ? `
                <form id="add-player-form" class="mb-6 flex flex-col sm:flex-row gap-3">
                    <input
                        type="text"
                        id="player-name-input"
                        placeholder="Nome do Jogador"
                        class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                    />
                    <button
                        type="submit"
                        id="add-player-btn"
                        class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                        ${icons.plus}
                        <span>Adicionar</span>
                    </button>
                </form>
            ` : '';

            mainContent.innerHTML = `
                <div class="bg-gray-800 bg-opacity-50 rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in">
                    ${addPlayerFormHtml}

                    <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6">
                        <h3 class="text-xl font-semibold mb-4 text-cyan-400 flex items-center gap-2">
                            ${icons.users}
                            Jogadores Inscritos (${playerCount})
                        </h3>
                        <div class="max-h-96 overflow-y-auto pr-2 space-y-2">
                            ${playersListHtml}
                        </div>
                    </div>
                    
                    ${generateButtonHtml}
                </div>
            `;

            // MODIFICADO: Só adiciona listeners de admin
            if (appState.isAdmin) {
                document.getElementById('add-player-form').addEventListener('submit', handleAddPlayerToChampionship);
                document.querySelectorAll('.delete-player-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeletePlayerFromChampionship(btn.dataset.id));
                });
                if (canGenerate) {
                    document.getElementById('generate-champ-btn').addEventListener('click', handleGenerateChampionship);
                }
            }
        };
        
        // -- Sub-tela: Fase de Grupos --
        const renderGroupStage = () => {
            let allScoresFilled = true;
            const groupsHtml = activeChampionship.groups.map((group, groupIndex) => {
                const rankings = getRankings(group);
                
                const matchesHtml = group.matches.map((match, matchIndex) => {
                    const score1 = match.score[0];
                    const score2 = match.score[1];
                    if (score1 === null || score2 === null) allScoresFilled = false;

                    return `
                    <div class="bg-gray-700 p-3 sm:p-4 rounded-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                            <span class="text-sm text-gray-300 text-center sm:text-left">${match.names[0]}</span>
                            <span class="font-bold text-cyan-300">vs</span>
                            <span class="text-sm text-gray-300 text-center sm:text-right">${match.names[1]}</span>
                        </div>
                        <div class="flex justify-center items-center gap-3 mt-3">
                            <input
                                type="number"
                                min="0"
                                value="${score1 === null ? '' : score1}"
                                class="score-input w-20 bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                data-group-index="${groupIndex}"
                                data-match-index="${matchIndex}"
                                data-score-index="0"
                                ${!appState.isAdmin ? 'disabled' : ''} />
                            <span class="text-gray-400">-</span>
                            <input
                                type="number"
                                min="0"
                                value="${score2 === null ? '' : score2}"
                                class="score-input w-20 bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                data-group-index="${groupIndex}"
                                data-match-index="${matchIndex}"
                                data-score-index="1"
                                ${!appState.isAdmin ? 'disabled' : ''} />
                        </div>
                    </div>
                    `;
                }).join('');

                const rankingsHtml = rankings.map((player, rankIndex) => `
                    <tr class="border-b border-gray-700 ${rankIndex < 2 ? 'text-green-300' : 'text-yellow-300'}">
                        <td class="p-3 font-bold">${rankIndex + 1}º</td>
                        <td class="p-3">${player.name}</td>
                        <td class="p-3 font-bold">${player.gamesWon}</td>
                    </tr>
                `).join('');

                return `
                <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 animate-fade-in">
                    <h3 class="text-2xl font-bold mb-5 text-cyan-400">Grupo ${groupIndex + 1}</h3>
                    <div class="space-y-4 mb-6">${matchesHtml}</div>
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-white">Ranking do Grupo</h4>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-3 rounded-l-lg">Pos.</th>
                                    <th class="p-3">Jogador</th>
                                    <th class="p-3 rounded-r-lg">Games Vencidos</th>
                                </tr>
                            </thead>
                            <tbody>${rankingsHtml}</tbody>
                        </table>
                        <div class="flex justify-between mt-2 text-sm">
                            <span class="text-green-300">▲ Dupla Ouro</span>
                            <span class="text-yellow-300">▼ Dupla Prata</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // MODIFICADO: Só mostra o botão de finalizar se for admin
            const finalizeButtonHtml = appState.isAdmin ? `
                <div class="mt-8 text-center">
                    <button
                        id="finalize-groups-btn"
                        type="button"
                        ${!allScoresFilled ? 'disabled' : ''}
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg shadow-xl transition-all flex items-center justify-center gap-3 text-lg mx-auto disabled:opacity-50 disabled:cursor-not-allowed">
                        ${icons.trophy}
                        ${allScoresFilled ? "Finalizar Grupos e Gerar Chaves" : "Preencha todos os placares"}
                    </button>
                </div>
            ` : '';

            mainContent.innerHTML = `
                <div class="space-y-8 animate-fade-in">
                    ${groupsHtml}
                    ${finalizeButtonHtml}
                </div>
            `;

            // MODIFICADO: Só adiciona listeners de admin
            if (appState.isAdmin) {
                document.querySelectorAll('.score-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const { groupIndex, matchIndex, scoreIndex } = e.target.dataset;
                        handleGroupScoreChange(groupIndex, matchIndex, scoreIndex, e.target.value);
                    });
                });
                if (allScoresFilled) { // Só adiciona listener se o botão existir
                    document.getElementById('finalize-groups-btn').addEventListener('click', handleFinalizeGroups);
                }
            }
        };
        
        // -- Sub-tela: Chaves (Mata-Mata) --
        // MODIFICADO: `isFinished` agora significa "Somente Leitura" (seja por ter acabado ou por ser visitante)
        const renderKnockoutView = (isReadOnly) => {
            const goldHtml = renderBracket('Série Ouro', activeChampionship.goldBracket, 'goldBracket', icons.shield, isReadOnly);
            const silverHtml = renderBracket('Série Prata', activeChampionship.silverBracket, 'silverBracket', icons.shieldOff, isReadOnly);
            
            mainContent.innerHTML = `<div class="animate-fade-in">${goldHtml}${silverHtml}</div>`;
            
            // MODIFICADO: Só adiciona listeners se NÃO for Somente Leitura
            if (!isReadOnly) {
                document.querySelectorAll('.knockout-score-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const { bracketType, matchId, scoreIndex } = e.target.dataset;
                        handleKnockoutScoreChange(bracketType, matchId, scoreIndex, e.target.value);
                    });
                });
            }
        };

        const renderBracket = (title, bracket, bracketType, iconSvg, isReadOnly) => {
            const rounds = {};
            if (!bracket || bracket.length === 0) {
                 return `<div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 mb-8">
                     <h3 class="text-3xl font-bold mb-6 text-cyan-400 flex items-center gap-3">
                         ${iconSvg} ${title}
                     </h3>
                     <p class="text-gray-400">Chave ainda não gerada.</p>
                 </div>`;
            }

            bracket.forEach(match => {
                if (!rounds[match.round]) rounds[match.round] = [];
                rounds[match.round].push(match);
            });
            
            const maxRound = Math.max(...bracket.map(m => m.round));

            const final = bracket.find(m => m.round === maxRound);
            const champion = final?.winner;

            const championHtml = champion ? `
                <div class="bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 text-gray-900 p-6 rounded-lg shadow-2xl mb-8 text-center animate-fade-in">
                    ${icons.medal}
                    <h4 class="text-2xl font-black uppercase tracking-wider">Campeões</h4>
                    <p class="text-3xl font-bold">${champion.name}</p>
                </div>
            ` : '';

            const roundsHtml = Object.keys(rounds).sort((a,b) => a-b).map(roundNum => {
                const roundTitle = Number(roundNum) === maxRound ? 'Final'
                    : Number(roundNum) === maxRound - 1 ? 'Semi-Final'
                    : Number(roundNum) === maxRound - 2 ? 'Quartas de Final'
                    : `Rodada ${roundNum}`;
                
                const matchesHtml = rounds[roundNum].map(match => {
                    const pair1 = match.pairs[0];
                    const pair2 = match.pairs[1];
                    const isPair1Winner = match.winner && pair1 && match.winner.id === pair1.id;
                    const isPair2Winner = match.winner && pair2 && match.winner.id === pair2.id;
                    const score1 = match.score[0];
                    const score2 = match.score[1];
                    
                    // MODIFICADO: A lógica de desabilitar agora inclui `isReadOnly`
                    const isDisabled = `disabled`;
                    const inputDisabledLogic = (!pair1 || !pair2 || isReadOnly || match.winner) ? isDisabled : '';

                    return `
                    <div class="bg-gray-700 rounded-lg shadow-md p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium ${isPair1Winner ? 'text-green-400 font-bold' : isPair2Winner ? 'text-gray-400' : 'text-white'}">
                                ${pair1 ? pair1.name : 'Aguardando...'}
                            </span>
                            <input
                                type="number"
                                min="0"
                                value="${score1 === null ? '' : score1}"
                                class="knockout-score-input w-16 bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-center font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${inputDisabledLogic ? 'opacity-70' : ''}"
                                data-bracket-type="${bracketType}"
                                data-match-id="${match.id}"
                                data-score-index="0"
                                ${inputDisabledLogic}
                            />
                        </div>
                        
                        <div class="flex items-center my-2">
                            <div class="flex-grow border-t border-gray-600"></div>
                            <span class="mx-2 text-xs text-gray-400">vs</span>
                            <div class="flex-grow border-t border-gray-600"></div>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="font-medium ${isPair2Winner ? 'text-green-400 font-bold' : isPair1Winner ? 'text-gray-400' : 'text-white'}">
                                ${pair2 ? pair2.name : 'Aguardando...'}
                            </span>
                            <input
                                type="number"
                                min="0"
                                value="${score2 === null ? '' : score2}"
                                class="knockout-score-input w-16 bg-gray-800 border border-gray-600 text-white rounded-lg p-2 text-center font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${inputDisabledLogic ? 'opacity-70' : ''}"
                                data-bracket-type="${bracketType}"
                                data-match-id="${match.id}"
                                data-score-index="1"
                                ${inputDisabledLogic}
                            />
                        </div>
                    </div>
                    `;
                }).join('');

                return `
                <div class="flex flex-col space-y-6 flex-shrink-0 w-72 sm:w-80">
                    <h4 class="text-xl font-semibold text-white">${roundTitle}</h4>
                    ${matchesHtml}
                </div>
                `;
            }).join('');

            return `
            <div class="bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 mb-8">
                <h3 class="text-3xl font-bold mb-6 text-cyan-400 flex items-center gap-3">
                    ${iconSvg}
                    ${title}
                </h3>
                ${championHtml}
                <div class="flex gap-4 sm:gap-6 pb-4 overflow-x-auto">
                    ${roundsHtml}
                </div>
            </div>
            `;
        };

        /* =============================================================================
            Lógica do Campeonato Ativo
            ============================================================================= */
        
        const handleAddPlayerToChampionship = async (e) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            e.preventDefault();
            const input = document.getElementById('player-name-input');
            const button = document.getElementById('add-player-btn');
            const playerName = input.value.trim();
            if (!playerName) return;

            button.disabled = true;
            button.lastChild.textContent = "Adicionando...";

            const newPlayer = {
                id: crypto.randomUUID(),
                name: playerName
            };
            
            const newChampData = {
                ...activeChampionship,
                players: [...activeChampionship.players, newPlayer]
            };
            
            await saveActiveChampionship(newChampData);
            
            input.value = '';
            button.disabled = false;
            button.lastChild.textContent = "Adicionar";
        };

        const handleDeletePlayerFromChampionship = async (playerId) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            if (!confirm("Tem certeza que deseja remover este jogador DO TORNEIO?")) return;
            
            const newChampData = {
                ...activeChampionship,
                players: activeChampionship.players.filter(p => p.id !== playerId)
            };
            await saveActiveChampionship(newChampData);
        };

        const handleGenerateChampionship = async () => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            const playerCount = activeChampionship.players.length;
            const validPlayerCounts = [4, 8, 16, 32];
            if (!validPlayerCounts.includes(playerCount)) {
                showModal("Número de Jogadores Inválido", `Você precisa de 4, 8, 16 ou 32 jogadores. Você tem ${playerCount}.`);
                return;
            }
            if (!confirm(`Iniciar grupos com ${playerCount} jogadores? Isso criará ${playerCount / 4} grupos.`)) {
                return;
            }

            try {
                const shuffledPlayers = [...activeChampionship.players].sort(() => 0.5 - Math.random());
                const newGroups = [];
                
                for (let i = 0; i < shuffledPlayers.length; i += 4) {
                    const groupPlayers = shuffledPlayers.slice(i, i + 4);
                    const [p1, p2, p3, p4] = groupPlayers;
                    
                    newGroups.push({
                        id: `group_${i / 4 + 1}`,
                        players: groupPlayers,
                        matches: [
                            { id: 1, p: [p1.id, p2.id, p3.id, p4.id], names: [`${p1.name} / ${p2.name}`, `${p3.name} / ${p4.name}`], score: [null, null] },
                            { id: 2, p: [p1.id, p3.id, p2.id, p4.id], names: [`${p1.name} / ${p3.name}`, `${p2.name} / ${p4.name}`], score: [null, null] },
                            { id: 3, p: [p1.id, p4.id, p2.id, p3.id], names: [`${p1.name} / ${p4.name}`, `${p2.name} / ${p3.name}`], score: [null, null] },
                        ]
                    });
                }
                
                const newChampData = {
                    ...activeChampionship,
                    status: 'groups',
                    groups: newGroups
                };
                await saveActiveChampionship(newChampData);
                
                const champRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                await setDoc(champRef, { status: 'groups' }, { merge: true });

            } catch (error) {
                console.error("Erro ao gerar campeonato:", error);
                showModal("Erro", "Não foi possível gerar os grupos.");
            }
        };

        const handleGroupScoreChange = (groupIndex, matchIndex, scoreIndex, value) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            const newChampData = JSON.parse(JSON.stringify(activeChampionship));
            const score = value === '' ? null : parseInt(value, 10);
            newChampData.groups[groupIndex].matches[matchIndex].score[scoreIndex] = isNaN(score) ? null : score;
            saveActiveChampionship(newChampData); // Salva sem esperar
        };

        const handleFinalizeGroups = async () => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            if (!confirm("Finalizar Fase de Grupos? Isso irá gerar as chaves Ouro e Prata e bloquear os grupos.")) return;

            try {
                let goldSeriesPairs = [];
                let silverSeriesPairs = [];
                
                activeChampionship.groups.forEach(group => {
                    const rankings = getRankings(group); // [p1, p2, p3, p4]
                    
                    const goldPair = {
                        id: `${rankings[0].id}_${rankings[1].id}`,
                        name: `${rankings[0].name} / ${rankings[1].name}`,
                        players: [rankings[0], rankings[1]]
                    };
                    goldSeriesPairs.push(goldPair);

                    const silverPair = {
                        id: `${rankings[2].id}_${rankings[3].id}`,
                        name: `${rankings[2].name} / ${rankings[3].name}`,
                        players: [rankings[2], rankings[3]]
                    };
                    silverSeriesPairs.push(silverPair);
                });
                
                const goldBracket = createBracket(goldSeriesPairs);
                const silverBracket = createBracket(silverSeriesPairs);
                
                const newChampData = {
                    ...activeChampionship,
                    status: 'knockout',
                    goldBracket: goldBracket,
                    silverBracket: silverBracket,
                };
                
                await saveActiveChampionship(newChampData);

                const champRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                await setDoc(champRef, { status: 'knockout' }, { merge: true });
                
            } catch (error) {
                console.error("Erro ao finalizar grupos:", error);
                showModal("Erro", "Ocorreu um erro ao gerar as chaves.");
            }
        };

        const handleKnockoutScoreChange = async (bracketType, matchId, scoreIndex, value) => {
            // NOVO: Trava de segurança
            if (!appState.isAdmin) return;

            const newChampData = JSON.parse(JSON.stringify(activeChampionship));
            const bracketToUpdate = newChampData[bracketType];
            const match = bracketToUpdate.find(m => m.id === matchId);
            
            if (match) {
                const score = value === '' ? null : parseInt(value, 10);
                match.score[scoreIndex] = isNaN(score) ? null : score;
                
                const s0 = match.score[0];
                const s1 = match.score[1];
                
                if (s0 !== null && s1 !== null) {
                    if (s0 > s1) match.winner = match.pairs[0];
                    else if (s1 > s0) match.winner = match.pairs[1];
                    else match.winner = null; 
                    
                    if (match.winner && match.nextMatchId) {
                        const nextMatch = bracketToUpdate.find(m => m.id === match.nextMatchId);
                        if (nextMatch) nextMatch.pairs[match.nextMatchSlot] = match.winner;
                    }
                } else {
                    const oldWinner = match.winner;
                    match.winner = null;
                    if (oldWinner && match.nextMatchId) {
                        const nextMatch = bracketToUpdate.find(m => m.id === match.nextMatchId);
                        if (nextMatch && nextMatch.pairs[match.nextMatchSlot]?.id === oldWinner.id) {
                            nextMatch.pairs[match.nextMatchSlot] = null;
                        }
                    }
                }
                
                await saveActiveChampionship(newChampData);

                await checkAndFinalizeChampionship(newChampData);
            }
        };

        /* =============================================================================
            Lógica de Cálculo de Ranking
            ============================================================================= */

        const checkAndFinalizeChampionship = async (champData) => {
            // Esta função é chamada por uma função de admin, então a trava já foi verificada
            if (!champData.goldBracket || !champData.silverBracket || champData.goldBracket.length === 0 || champData.silverBracket.length === 0) {
                return; 
            }

            const maxRoundGold = Math.max(...champData.goldBracket.map(m => m.round));
            const maxRoundSilver = Math.max(...champData.silverBracket.map(m => m.round));
            
            const goldFinal = champData.goldBracket.find(m => m.round === maxRoundGold);
            const silverFinal = champData.silverBracket.find(m => m.round === maxRoundSilver);

            const goldWinner = goldFinal?.winner;
            const silverWinner = silverFinal?.winner;

            if (goldWinner && silverWinner) {
                const champRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                const champDoc = await getDoc(champRef);

                if (champDoc.exists() && champDoc.data().status === 'finished') {
                    return;
                }
                
                showModal("Calculando...", "Finalizando torneio e atualizando o ranking global. Aguarde...");
                
                try {
                    const goldRunnerUp = goldFinal.pairs.find(p => p.id !== goldWinner.id);
                    const silverRunnerUp = silverFinal.pairs.find(p => p.id !== silverWinner.id);
                    const effectivePoints = champDoc.data().pointsConfig || DEFAULT_RANKING_POINTS;

                    await setDoc(champRef, {
                        status: 'finished',
                        winnerGold: goldWinner.name,
                        winnerSilver: silverWinner.name
                    }, { merge: true });

                    await updateGlobalRanking(champData, { goldWinner, goldRunnerUp, silverWinner, silverRunnerUp }, effectivePoints);

                    hideModal();
                    showModal("Sucesso!", `Ranking global atualizado! Campeões Ouro: ${goldWinner.name}. Campeões Prata: ${silverWinner.name}.`);
                
                } catch (error) {
                    console.error("Erro ao finalizar e aplicar ranking:", error);
                    showModal("Erro Crítico", "Não foi possível aplicar o ranking. " + error.message);
                }
            }
        };

        const updateGlobalRanking = async (champData, winners, pointsConfig) => {
            // Esta função é chamada por uma função de admin, então a trava já foi verificada
            await runTransaction(db, async (transaction) => {
                const playerPointsMap = new Map();

                for (const player of champData.players) {
                    playerPointsMap.set(player.id, {
                        name: player.name,
                        points: pointsConfig.participation,
                        goldWins: 0,
                        silverWins: 0
                    });
                }

                if (winners.goldWinner) {
                    for (const player of winners.goldWinner.players) {
                        const p = playerPointsMap.get(player.id);
                        if (p) {
                            p.points += pointsConfig.goldWinner;
                            p.goldWins = 1;
                        }
                    }
                }
                if (winners.goldRunnerUp) {
                    for (const player of winners.goldRunnerUp.players) {
                        const p = playerPointsMap.get(player.id);
                         if (p) p.points += pointsConfig.goldRunnerUp;
                    }
                }
                if (winners.silverWinner) {
                    for (const player of winners.silverWinner.players) {
                        const p = playerPointsMap.get(player.id);
                         if (p) {
                            p.points += pointsConfig.silverWinner;
                            p.silverWins = 1;
                         }
                    }
                }
                if (winners.silverRunnerUp) {
                     for (const player of winners.silverRunnerUp.players) {
                        const p = playerPointsMap.get(player.id);
                         if (p) p.points += pointsConfig.silverRunnerUp;
                    }
                }

                for (const [playerId, data] of playerPointsMap.entries()) {
                    const playerRef = doc(db, 'users', appState.userId, 'global_players', playerId);
                    const playerDoc = await transaction.get(playerRef);

                    if (!playerDoc.exists()) {
                        transaction.set(playerRef, {
                            name: data.name,
                            points: data.points,
                            goldWins: data.goldWins,
                            silverWins: data.silverWins
                        });
                    } else {
                        const oldData = playerDoc.data();
                        transaction.update(playerRef, {
                            name: data.name,
                            points: (oldData.points || 0) + data.points,
                            goldWins: (oldData.goldWins || 0) + data.goldWins,
                            silverWins: (oldData.silverWins || 0) + data.silverWins
                        });
                    }
                }
            });
        };

        /* =============================================================================
            Funções Utilitárias (Cálculos de Grupos e Chaves)
            ============================================================================= */
        
        const getRankings = (group) => {
            const playerStats = {};
            group.players.forEach(p => {
                playerStats[p.id] = { id: p.id, name: p.name, gamesWon: 0 };
            });
            
            group.matches.forEach(match => {
                const [p1, p2, p3, p4] = match.p;
                const [s1, s2] = match.score;
                
                if (s1 !== null && !isNaN(s1)) {
                    playerStats[p1].gamesWon += s1;
                    playerStats[p2].gamesWon += s1;
                }
                if (s2 !== null && !isNaN(s2)) {
                    playerStats[p3].gamesWon += s2;
                    playerStats[p4].gamesWon += s2;
                }
            });
            
            return Object.values(playerStats).sort((a, b) => b.gamesWon - a.gamesWon);
        };

        const createBracket = (bracketPairs) => {
            const shuffledPairs = [...bracketPairs].sort(() => 0.5 - Math.random());
            const bracket = [];
            const numPairs = bracketPairs.length; 
            
            if (numPairs < 2) return [];

            const numRounds = Math.log2(numPairs); 

            for (let r = 1; r <= numRounds; r++) { 
                
                const matchesInRound = numPairs / Math.pow(2, r); 
                
                for (let m = 0; m < matchesInRound; m++) { 
                    const matchId = `R${r}_M${m+1}`;
                    let nextMatchId = null;
                    let nextMatchSlot = null; 

                    if (r < numRounds) { 
                        const nextRoundMatchIndex = Math.floor(m / 2); 
                        nextMatchId = `R${r+1}_M${nextRoundMatchIndex+1}`; 
                        nextMatchSlot = m % 2; 
                    }
                    
                    bracket.push({
                        id: matchId,
                        round: r, 
                        pairs: [null, null],
                        score: [null, null],
                        winner: null,
                        nextMatchId: nextMatchId,
                        nextMatchSlot: nextMatchSlot,
                    });
                }
            }
            
            const round1Matches = bracket.filter(m => m.round === 1);
            round1Matches.forEach((match, index) => {
                match.pairs = [shuffledPairs[index * 2] || null, shuffledPairs[index * 2 + 1] || null];
            });

            return bracket;
        };


        /* =============================================================================
            Inicialização do App (Autenticação e Listeners Globais)
            ============================================================================= */

        const listenToGlobalPlayers = () => {
            unsubscribeGlobalPlayers(); 
            const playersCollectionRef = collection(db, 'users', appState.userId, 'global_players');
            const q = query(playersCollectionRef);
            
            unsubscribeGlobalPlayers = onSnapshot(q, (querySnapshot) => {
                globalPlayers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (appState.currentView === 'globalRanking') {
                    render();
                }
            }, (error) => {
                console.error("Erro ao carregar ranking global:", error);
                showModal("Erro", "Não foi possível carregar o ranking global.");
            });
        };

        const listenToChampionships = () => {
            unsubscribeChampionships();
            const champCollectionRef = collection(db, 'users', appState.userId, 'championships');
            const q = query(champCollectionRef);
            
            unsubscribeChampionships = onSnapshot(q, (querySnapshot) => {
                championships = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (appState.currentView === 'championshipList') {
                    render();
                }
            }, (error) => {
                console.error("Erro ao carregar campeonatos:", error);
                showModal("Erro", "Não foi possível carregar o histórico de campeonatos.");
            });
        };

        const listenToActiveChampionship = (champId) => {
            unsubscribeActiveChampionship();
            const champDataRef = doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main');
            
            unsubscribeActiveChampionship = onSnapshot(champDataRef, (docSnap) => {
                if (docSnap.exists()) {
                    activeChampionship = { id: docSnap.id, ...docSnap.data() };
                    const oldStatus = appState.currentStatus;
                    appState.currentStatus = activeChampionship.status;
                    if (oldStatus !== activeChampionship.status) {
                        render();
                    }
                } else {
                    showModal("Erro", "Não foi possível carregar os dados deste campeonato. (O doc 'data/main' não foi encontrado).");
                    navigateTo('championshipList');
                }
                render(); // Renderiza para atualizar os dados (ex: placares)
            }, (error) => {
                console.error("Erro ao carregar campeonato ativo:", error);
                showModal("Erro", "Não foi possível carregar este campeonato. Verifique as regras do Firestore.");
                navigateTo('championshipList');
            });
        };
        
        // Ponto de entrada da aplicação
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Erro na autenticação anônima:", error);
                    let errorMessage = "Não foi possível conectar ao Firebase. Verifique sua conexão.";
                    if (error.code === 'auth/configuration-not-found') {
                        errorMessage = "Erro de Autenticação: O 'Login Anônimo' (Anonymous) não está ATIVADO no seu painel do Firebase.";
                    }
                    showModal("Erro de Autenticação", errorMessage);
                    return;
                }
            }
            
            if (user && !appState.isAuthReady) {
                
                const effectiveUserId = MESTRE_USER_ID; 
                
                appState = { ...appState, userId: effectiveUserId, isAuthReady: true };
                userIdFooter.textContent = effectiveUserId;
                
                listenToGlobalPlayers();
                listenToChampionships();
                
                // MODIFICADO: A tela inicial agora é 'auth' (login), que já está definida no appState.
                // A navegação para 'championshipList' ocorrerá *após* o login.
                render(); // Renderiza a tela de login ('auth')
            }
        });

    </script>
</body>
</html>
