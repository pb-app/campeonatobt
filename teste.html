<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Beach Tennis</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* (Seus estilos CSS permanecem os mesmos) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F7F7; /* Fundo Quase Branco (Light Gray) */
            color: #1F2937; /* Cor do Texto Principal (Gray-800) */
        }
        @keyframes fadeIn { /* ... */ }
        .animate-fade-in { /* ... */ }
        .animate-fade-in-sm { /* ... */ }
        .hidden { display: none; }
        ::-webkit-scrollbar { /* ... */ }
        ::-webkit-scrollbar-track { /* ... */ }
        ::-webkit-scrollbar-thumb { /* ... */ }
        ::-webkit-scrollbar-thumb:hover { /* ... */ }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 gap-4 bg-white p-4 rounded-xl shadow-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 text-center sm:text-left">
                Ranking Beach Tennis
            </h1>
            <div id="header-buttons" class="flex gap-3">
                </div>
        </header>

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-500">Carregando dados...</p>
        </div>

        <main id="main-content" class="hidden">
            </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Usuário: <span id="user-id-footer">Conectando...</span></p>
            <p>App de Ranking v5.0 (Multi-Admin)</p>
        </footer>

    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-sm w-full mx-auto animate-fade-in-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-blue-600"></h3>
                <button id="modal-close-icon" class="text-gray-500 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-message" class="text-gray-700 text-sm sm:text-base mb-6 max-h-60 overflow-y-auto"></div>
            <button
                id="modal-close-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Entendi
            </button>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // =================================================================
        // === MUDANÇA: Importando os módulos de Autenticação (Email/Senha E Anônimo)
        // =================================================================
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInAnonymously // Mantido para o Modo Telão
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            deleteDoc, 
            query,
            Timestamp,
            getDoc,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* =============================================================================
            Configuração do Firebase (Fornecida pelo usuário)
           ============================================================================= */
        const firebaseConfig = {
            apiKey: "AIzaSyDeS-rk8OJKhghv1djVucmR3-erOa-ppMY",
            authDomain: "campeonato-sortudo.firebaseapp.com",
            projectId: "campeonato-sortudo",
            storageBucket: "campeonato-sortudo.firebasestorage.app",
            messagingSenderId: "706083235199",
            appId: "1:706083235199:web:5eca6041bb817401ee264a"
        };
        
        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug'); // Descomente se precisar depurar

        /* =============================================================================
            ID Mestre e Senha de Admin (REMOVIDOS)
           ============================================================================= */
        // const MESTRE_USER_ID = "campeonato-sortudo-admin"; // REMOVIDO
        // const ADMIN_PASSWORD = "mudar123"; // REMOVIDO

        /* =============================================================================
            Estado Global do Aplicativo
           ============================================================================= */
        let appState = {
            // MUDANÇA: userId agora é dinâmico, baseado no login.
            userId: null, 
            
            // MUDANÇA: isAdmin foi removido. Se você está logado, você é o "admin" dos *seus* dados.
            // isAuthReady: false, // Simplificado e removido, onAuthStateChanged é o novo "ready"
            isTelaoMode: false,
            
            // MUDANÇA: A view inicial é 'loading', o onAuthStateChanged decide para onde ir.
            currentView: 'loading', // 'loading', 'auth', 'championshipList', 'championshipView', 'globalRanking', 'telaoView'
            currentChampionshipId: null,
            currentRankingId: null,
        };

        // (O resto do estado global permanece o mesmo)
        let allRankings = []; 
        let championships = []; 
        let globalPlayers = []; 
        let activeChampionship = null; 

        let unsubscribeRankingsList = () => {}; 
        let unsubscribeChampionships = () => {}; 
        let unsubscribeGlobalPlayers = () => {}; 
        let unsubscribeActiveChampionship = () => {}; 

        /* =============================================================================
            Referências do DOM (sem alterações)
           ============================================================================= */
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const headerButtons = document.getElementById('header-buttons');
        const userIdFooter = document.getElementById('user-id-footer');
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');

        /* =============================================================================
            Constantes e Ícones (sem alterações)
           ============================================================================= */
        const DEFAULT_RANKING_POINTS = { /* ... (mesmos valores) ... */ };
        const icons = { /* ... (mesmos ícones) ... */ };

        /* =============================================================================
            Funções do Modal (sem alterações)
           ============================================================================= */
        const showModal = (title, message) => { /* ... (mesma função) ... */ };
        const hideModal = () => { /* ... (mesma função) ... */ };
        modalCloseBtn.addEventListener('click', hideModal);
        modalCloseIcon.addEventListener('click', hideModal);
        modal.addEventListener('click', hideModal);
        modal.firstElementChild.addEventListener('click', (e) => e.stopPropagation());

        /* =============================================================================
            Funções de Navegação e Renderização Principal
           ============================================================================= */

        // Router Principal
        const render = () => {
            if (appState.currentView === 'loading') {
                loadingSpinner.classList.remove('hidden');
                mainContent.classList.add('hidden');
                headerButtons.innerHTML = '';
                return;
            }
            
            loadingSpinner.classList.add('hidden');
            mainContent.classList.remove('hidden');

            if (!appState.isTelaoMode) {
                renderHeaderButtons();
            }

            // MUDANÇA: 'login' foi substituído por 'auth'
            switch (appState.currentView) {
                case 'auth':
                    renderAuthScreen(); // Nova tela de login/registro
                    break;
                case 'championshipList':
                    renderChampionshipList();
                    break;
                case 'globalRanking':
                    renderGlobalRanking();
                    break;
                case 'championshipView':
                    renderChampionshipView();
                    break;
                case 'telaoView':
                    renderTelaoView();
                    break;
                default:
                    mainContent.innerHTML = `<p>Estado desconhecido: ${appState.currentView}</p>`;
            }
        };

        const navigateTo = (view, champId = null) => {
            // MUDANÇA: Trava de segurança. Se não há userId, só pode ir para 'auth' ou 'loading' (ou 'telaoView' se for o caso)
            if (!appState.userId && view !== 'auth' && view !== 'loading' && view !== 'telaoView') {
                console.warn("Tentativa de navegar sem login. Redirecionando para 'auth'.");
                view = 'auth';
            }
            
            // MUDANÇA: 'login' agora é 'auth'
            if (view === 'auth') {
                appState.isAdmin = false; // Removido, mas mantendo a lógica de reset se houver
            }

            appState.currentView = view;
            appState.currentChampionshipId = champId;

            unsubscribeActiveChampionship();
            activeChampionship = null;

            if ((view === 'championshipView' || view === 'telaoView') && champId) {
                // ... (Lógica de `MapsTo` para `championshipView` e `telaoView` permanece a mesma) ...
                // ... (Ela já usa `appState.userId` dinamicamente, o que é correto) ...
                const champ = championships.find(c => c.id === champId);
                if (champ && champ.rankingId) {
                    if (appState.currentRankingId !== champ.rankingId) {
                        appState.currentRankingId = champ.rankingId;
                        listenToGlobalPlayers(); 
                    }
                }
                listenToActiveChampionship(champId);
            } else if (view === 'globalRanking') {
                listenToGlobalPlayers();
                render();
            } else {
                render();
            }
        };

        const renderHeaderButtons = () => {
            let navHtml = ''; // Botões de Navegação (Voltar/Ranking)
            let authHtml = ''; // Botões de Autenticação (Sair)

            // Lógica de Navegação (sem alteração)
            if (appState.currentView === 'championshipList') {
                navHtml = `
                <button
                    id="nav-to-ranking"
                    class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.award}
                    Ranking Geral
                </button>
                `;
            } else if (appState.currentView === 'globalRanking' || appState.currentView === 'championshipView') {
                navHtml = `
                <button
                    id="nav-to-list"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.arrowLeft}
                    Voltar
                </button>
                `;
            }

            // =================================================================
            // === MUDANÇA: Lógica de Autenticação (Botão de Sair)
            // =================================================================
            if (appState.userId && appState.currentView !== 'auth') {
                authHtml = `
                <button
                    id="logout-btn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.logOut}
                    Sair
                </button>
                `;
            }

            headerButtons.innerHTML = navHtml + authHtml; 

            // Adiciona listeners aos botões
            const rankingBtn = document.getElementById('nav-to-ranking');
            if (rankingBtn) rankingBtn.addEventListener('click', () => navigateTo('globalRanking'));

            const listBtn = document.getElementById('nav-to-list');
            if (listBtn) listBtn.addEventListener('click', () => navigateTo('championshipList'));

            // MUDANÇA: Listener do botão de logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        };
        
        // MUDANÇA: Nova função de Logout
        const handleLogout = async () => {
            if (confirm("Deseja realmente sair?")) {
                await signOut(auth);
                // O onAuthStateChanged vai lidar com a limpeza e navegação para 'auth'
            }
        };


        /* =============================================================================
            TELA 0: Autenticação (Substituindo a Tela de Login)
           ============================================================================= */

        // MUDANÇA: `renderLogin` foi substituída por `renderAuthScreen`
        const renderAuthScreen = () => {
            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto animate-fade-in">
                    
                    <form id="login-form" class="">
                        <h2 class="text-3xl font-bold text-center text-blue-600 mb-8">Login</h2>
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="login-email" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3" required />
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                            <input type="password" id="login-password" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3" required />
                        </div>
                        <button type="submit" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg disabled:opacity-50">
                            Entrar
                        </button>
                        <p class="text-center text-sm text-gray-500 mt-4">
                            Não tem uma conta? 
                            <button type="button" id="toggle-to-register" class="font-medium text-blue-600 hover:text-blue-500">Registre-se</button>
                        </p>
                    </form>

                    <form id="register-form" class="hidden">
                        <h2 class="text-3xl font-bold text-center text-blue-600 mb-8">Criar Conta</h2>
                        <div class="mb-4">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3" required />
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3" required />
                        </div>
                        <button type="submit" id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg disabled:opacity-50">
                            Criar Conta
                        </button>
                        <p class="text-center text-sm text-gray-500 mt-4">
                            Já tem uma conta? 
                            <button type="button" id="toggle-to-login" class="font-medium text-blue-600 hover:text-blue-500">Faça o Login</button>
                        </p>
                    </form>
                </div>
            `;

            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            // Listeners
            document.getElementById('toggle-to-register').addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });
            document.getElementById('toggle-to-login').addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const button = document.getElementById('login-btn');
            button.disabled = true;
            button.textContent = "Entrando...";

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai lidar com a navegação
            } catch (error) {
                console.error("Erro de Login:", error.code, error.message);
                showModal("Erro de Login", "Email ou senha incorretos.");
                button.disabled = false;
                button.textContent = "Entrar";
            }
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const button = document.getElementById('register-btn');
            button.disabled = true;
            button.textContent = "Criando...";

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged vai lidar com a navegação
            } catch (error) {
                console.error("Erro de Registro:", error.code, error.message);
                let msg = "Não foi possível criar a conta.";
                if (error.code === 'auth/weak-password') {
                    msg = "Senha muito fraca. Use pelo menos 6 caracteres.";
                } else if (error.code === 'auth/email-already-in-use') {
                    msg = "Este email já está em uso.";
                }
                showModal("Erro de Registro", msg);
                button.disabled = false;
                button.textContent = "Criar Conta";
            }
        };

        /* =============================================================================
            TELA 1: Lista de Campeonatos (Histórico)
           ============================================================================= */

        const renderChampionshipList = () => {
            const sortedChampionships = [...championships].sort((a, b) => b.createdAt - a.createdAt);

            const championshipsListHtml = sortedChampionships.length === 0
                ? `<p class="text-gray-500 text-center py-4">Nenhum campeonato cadastrado.</p>`
                : sortedChampionships.map(champ => {
                    // ... (lógica de status e cores sem alteração) ...
                    let statusColor = 'text-yellow-600';
                    let statusText = 'Em andamento';
                    if (champ.status === 'registration') { statusColor = 'text-blue-600'; statusText = 'Em Inscrição'; }
                    if (champ.status === 'finished') { statusColor = 'text-green-600'; statusText = 'Finalizado'; }

                    const ranking = allRankings.find(r => r.id === champ.rankingId);
                    const rankingHtml = ranking ? `<span class="block text-xs text-yellow-600">${ranking.name}</span>` : '';

                    // =================================================================
                    // === MUDANÇA: Botão de deletar agora aparece sempre (pois está logado)
                    // =================================================================
                    const deleteButtonHtml = `
                    <button
                        class="delete-champ-btn text-red-600 hover:text-red-700 transition-colors p-2 rounded-lg bg-gray-100"
                        data-id="${champ.id}">
                        ${icons.trash}
                    </button>`;

                    return `
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-white border border-gray-200 p-4 rounded-xl shadow-sm animate-fade-in-sm gap-3">
                        <div>
                            <span class="text-gray-800 font-bold text-lg">${champ.name}</span>
                            <span class="block text-sm ${statusColor}">${statusText}</span>
                            ${rankingHtml}
                            <span class="block text-xs text-gray-500">${new Date(champ.createdAt?.toDate()).toLocaleDateString()}</span>
                        </div>
                        <div class="flex gap-2">
                             <button
                                class="open-champ-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm"
                                data-id="${champ.id}">
                                ${icons.eye} Ver
                            </button>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                    `}).join('');

            const rankingsOptions = allRankings.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            // =================================================================
            // === MUDANÇA: Formulário de "Novo Campeonato" agora aparece sempre (pois está logado)
            // =================================================================
            const newChampionshipFormHtml = `
            <form id="add-championship-form">
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mb-8 border border-gray-200">
                    <h2 class="text-2xl font-bold text-blue-600 mb-4">Novo Campeonato</h2>
                    
                    <div class="mb-4">
                        <label for="championship-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nome do Campeonato</label>
                        <input
                            type="text"
                            id="championship-name-input"
                            placeholder="ex: Torneio de Verão"
                            class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        />
                    </div>
                    
                    <div class="mb-4">
                        <label for="ranking-select" class="block text-sm font-medium text-gray-700 mb-1">Vincular ao Ranking</label>
                        <div class="flex gap-2">
                            <select id="ranking-select" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking encontrado...</option>'}
                            </select>
                            <button type="button" id="add-new-ranking-btn" class="flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg shadow-md transition-all">
                                ${icons.plus}
                            </button>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Configuração de Pontos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        </div>

                    <button
                        type="submit"
                        id="add-championship-btn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                        ${icons.plus}
                        <span>Criar Campeonato</span>
                    </button>
                </div>
            </form>
            `; 

            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    ${newChampionshipFormHtml}

                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 border border-gray-200">
                        <h3 class="text-2xl font-bold mb-5 text-blue-600">Histórico de Campeonatos</h3>
                        <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-3">
                            ${championshipsListHtml}
                        </div>
                    </div>
                </div>
            `;

            // =================================================================
            // === MUDANÇA: Listeners agora são sempre adicionados
            // =================================================================
            const addForm = document.getElementById('add-championship-form');
            if (addForm) addForm.addEventListener('submit', handleAddChampionship);

            const addRankingBtn = document.getElementById('add-new-ranking-btn');
            if (addRankingBtn) addRankingBtn.addEventListener('click', handleAddNewRanking);

            document.querySelectorAll('.delete-champ-btn').forEach(btn => {
                btn.addEventListener('click', () => handleDeleteChampionship(btn.dataset.id));
            });

            document.querySelectorAll('.open-champ-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo('championshipView', btn.dataset.id));
            });
        };

        // (handleAddChampionship, handleDeleteChampionship, handleAddNewRanking - sem alterações)
        // Elas já usam `appState.userId` que agora é dinâmico.
        const handleAddChampionship = async (e) => { /* ... (mesma função) ... */ };
        const handleDeleteChampionship = async (champId) => { /* ... (mesma função) ... */ };
        const handleAddNewRanking = async () => { /* ... (mesma função) ... */ };

        /* =============================================================================
            TELA 2: Ranking Global
           ============================================================================= */

        const renderGlobalRanking = () => {
            // ... (lógica de sortedPlayers e rankingsHtml sem alteração) ...
            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);
            const rankingsHtml = sortedPlayers.length === 0 ? `<tr>...</tr>` : sortedPlayers.map(/*...*/).join('');
            
            const rankingsOptions = allRankings.map(r => 
                `<option value="${r.id}" ${r.id === appState.currentRankingId ? 'selected' : ''}>
                    ${r.name}
                </option>`
            ).join('');

            // =================================================================
            // === MUDANÇA: Botão de gerenciar agora aparece sempre (pois está logado)
            // =================================================================
            const manageButtonHtml = `
            <button id="manage-rankings-btn" class="flex-shrink-0 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerenciar Rankings">
                ${icons.settings}
            </button>
            `;

            // Botão Gerar PDF (sem alteração)
            const printButtonHtml = `
                <button id="print-ranking-pdf-btn" class="flex-shrink-0 bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerar PDF do Ranking">
                    ${icons.fileDown}
                </button>
            `;

            const rankingSelectorHtml = `
                <div class="mb-6">
                    <label for="ranking-view-select" class="block text-sm font-medium text-gray-700 mb-1">Visualizando Ranking:</label>
                    <div class="flex gap-2">
                        <select id="ranking-view-select" class="w-full bg-white border border-gray-300 text-gray-800 rounded-lg p-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking...</option>'}
                        </select>
                        ${manageButtonHtml}
                        ${printButtonHtml}
                    </div>
                </div>
            `;
            
            // ... (resto do HTML da tela de Ranking sem alteração) ...
            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl ...">
                    ...
                    ${rankingSelectorHtml}
                    ...
                    <tbody class="divide-y divide-gray-200">
                        ${rankingsHtml}
                    </tbody>
                    ...
                </div>
            `;

            // =================================================================
            // === MUDANÇA: Listeners agora são sempre adicionados
            // =================================================================
            const rankingViewSelect = document.getElementById('ranking-view-select');
            if (rankingViewSelect) rankingViewSelect.addEventListener('change', handleViewRankingChange);

            const manageRankingsBtn = document.getElementById('manage-rankings-btn');
            if (manageRankingsBtn) manageRankingsBtn.addEventListener('click', renderRankingManagementModal);

            const printRankingBtn = document.getElementById('print-ranking-pdf-btn');
            if (printRankingBtn) printRankingBtn.addEventListener('click', handlePrintRankingPDF);
        };
        
        // (renderRankingManagementModal, handleDeleteRanking, handleViewRankingChange - sem alterações)
        const renderRankingManagementModal = () => { /* ... (mesma função) ... */ };
        const handleDeleteRanking = async (rankingId, rankingName) => { /* ... (mesma função) ... */ };
        const handleViewRankingChange = (e) => { /* ... (mesma função) ... */ };

        /* =============================================================================
            TELA 3: Visão do Campeonato
           ============================================================================= */

        const renderChampionshipView = () => {
            if (!activeChampionship) {
                // ... (spinner de carregamento, sem mudança) ...
                return;
            }

            let html = '';
            const champInfo = championships.find(c => c.id === appState.currentChampionshipId);

            // =================================================================
            // === MUDANÇA: Botões do topo (Telão, PDF) agora aparecem sempre
            // =================================================================
            let pdfButtonHtml = '';
            if (champInfo?.status === 'finished') {
                pdfButtonHtml = `
                    <button id="print-champ-pdf-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                        ${icons.fileDown}
                        Gerar PDF
                    </button>
                `;
            }

            const telaoButtonHtml = `
                <button id="launch-telao-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                    ${icons.tv}
                    Abrir Telão
                </button>
            `;

            const topButtonsHtml = `
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8 animate-fade-in border border-gray-200">
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    ${telaoButtonHtml}
                    ${pdfButtonHtml}
                </div>
            </div>
            `;
            
            // =================================================================
            // === MUDANÇA: Lógica de renderização simplificada (sem `isAdmin`)
            // =================================================================
            // Passa `isReadOnly` para as funções
            const isFinished = champInfo?.status === 'finished';

            if (isFinished) {
                // Se finalizado, mostra grupos e chaves, ambos no modo "leitura"
                html = topButtonsHtml + renderGroupStage(true) + renderKnockoutView(true);
            } else if (activeChampionship.status === 'knockout') {
                // Se no mata-mata, mostra grupos (leitura) e chaves (edição)
                html = topButtonsHtml + renderGroupStage(true) + renderKnockoutView(false);
            } else if (activeChampionship.status === 'groups') {
                // Se nos grupos, mostra grupos (edição)
                html = topButtonsHtml + renderGroupStage(false);
            } else { // 'registration'
                // Se no registro, mostra registro (edição)
                html = topButtonsHtml + renderPlayerRegistration();
            }

            mainContent.innerHTML = html;

            // =================================================================
            // === MUDANÇA: Re-attach de TODOS os listeners (sem `isAdmin`)
            // =================================================================

            // Listeners de Registro
            if (activeChampionship.status === 'registration') {
                const addExistingForm = document.getElementById('add-existing-player-form');
                if (addExistingForm) addExistingForm.addEventListener('submit', handleAddExistingPlayerToChampionship);

                const addNewForm = document.getElementById('add-new-player-form');
                if (addNewForm) addNewForm.addEventListener('submit', handleAddNewPlayerToChampionship);

                document.querySelectorAll('.delete-player-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeletePlayerFromChampionship(btn.dataset.id));
                });

                const generateBtn = document.getElementById('generate-champ-btn');
                if (generateBtn) generateBtn.addEventListener('click', handleGenerateChampionship);
            }

            // Listeners da Fase de Grupos
            if (activeChampionship.status === 'groups' || activeChampionship.status === 'knockout' || isFinished) {
                
                // Listener de Impressão (para todos, mesmo telão se acessado por admin)
                document.querySelectorAll('.print-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => handlePrintGroup(e.currentTarget.dataset.groupIndex));
                });

                // Listeners de Admin (Confirmação de placar)
                document.querySelectorAll('.confirm-group-score-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { groupIndex, matchIndex } = e.currentTarget.dataset;
                        handleConfirmGroupScore(groupIndex, matchIndex);
                    });
                });

                if (activeChampionship.status === 'groups' && !isFinished) {
                    const finalizeBtn = document.getElementById('finalize-groups-btn');
                    if (finalizeBtn) finalizeBtn.addEventListener('click', handleFinalizeGroups);
                }
            }

            // Listeners do Mata-Mata
            if (activeChampionship.status === 'knockout' || isFinished) {
                document.querySelectorAll('.confirm-knockout-score-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { bracketType, matchId } = e.currentTarget.dataset;
                        handleConfirmKnockoutScore(bracketType, matchId);
                    });
                });
            }

            // Listeners dos Botões do Topo (PDF e Telão)
            const launchTelaoBtn = document.getElementById('launch-telao-btn');
            if (launchTelaoBtn) launchTelaoBtn.addEventListener('click', handleLaunchTelao);

            if (isFinished) {
                const printChampBtn = document.getElementById('print-champ-pdf-btn');
                if (printChampBtn) printChampBtn.addEventListener('click', handlePrintChampionshipPDF);
            }
        };

        const saveActiveChampionship = async (newChampData) => {
            if (!appState.userId || !appState.currentChampionshipId) return;
            
            // =================================================================
            // === MUDANÇA: Trava de `isAdmin` REMOVIDA. A segurança é feita nas Regras do Firestore.
            // =================================================================
            // if (!appState.isAdmin) { ... } // REMOVIDO
            
            try {
                const champDataRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId, 'data', 'main');
                await setDoc(champDataRef, newChampData);
            } catch (error) {
                console.error("Erro ao salvar campeonato:", error);
                showModal("Erro", "Não foi possível salvar as alterações. Verifique sua conexão e as regras do Firebase.");
            }
        };

        // (ADMIN) -- Sub-tela: Registro de Jogadores --
        const renderPlayerRegistration = () => {
            // =================================================================
            // === MUDANÇA: Lógica de `deleteButton` e `addPlayerFormHtml` simplificada (sem `isAdmin`)
            // =================================================================
            const playersListHtml = activeChampionship.players.length === 0
                ? `<p ...>Nenhum jogador...</p>`
                : activeChampionship.players.map(player => {
                    const deleteButton = `
                    <button class="delete-player-btn text-red-600 hover:text-red-700 transition-colors" data-id="${player.id}">
                        ${icons.trash}
                    </button>`;

                    return `
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg animate-fade-in-sm border border-gray-200">
                        <span class="text-gray-800 font-medium">${player.name}</span>
                        ${deleteButton}
                    </div>
                    `
                }).join('');

            // ... (lógica de `canGenerate` e `generateButtonHtml` sem alteração, já não usava `isAdmin`) ...
            const playerCount = activeChampionship.players.length;
            const isMultipleOfFour = playerCount % 4 === 0;
            const minPlayersForGroups = 4;
            const canGenerate = playerCount >= minPlayersForGroups && isMultipleOfFour;

            const generateButtonHtml = playerCount >= minPlayersForGroups
                ? `
                <div class="mt-8 text-center">
                    <button id="generate-champ-btn" ... ${!canGenerate ? 'disabled' : ''}>
                        ...
                    </button>
                    ${!canGenerate ? `<p class="text-red-600 ...">O campeonato requer um número de jogadores múltiplo de 4...</p>` : ''}
                </div>
                ` : `<p ...>Mínimo de ${minPlayersForGroups} jogadores...</p>`;

            // ... (lógica de `availablePlayersFromRanking` e `existingPlayersOptions` sem alteração) ...
            const playersInTournamentIds = new Set(activeChampionship.players.map(p => p.id));
            const availablePlayersFromRanking = globalPlayers.filter(p => !playersInTournamentIds.has(p.id));
            const existingPlayersOptions = availablePlayersFromRanking.length > 0 ? /*...*/ : '...';

            const addPlayerFormHtml = `
            <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <form id="add-existing-player-form">
                    </form>
                <form id="add-new-player-form">
                    </form>
            </div>
            `;

            return `
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in border border-gray-200">
                    ${addPlayerFormHtml}
                    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 border border-gray-200">
                        <h3 ...>Jogadores Inscritos (${playerCount})</h3>
                        <div ...>${playersListHtml}</div>
                    </div>
                    ${generateButtonHtml}
                </div>
            `;
        };

        // (ADMIN) -- Sub-tela: Fase de Grupos --
        // =================================================================
        // === MUDANÇA: `renderGroupStage` agora aceita `isReadOnly`
        // =================================================================
        const renderGroupStage = (isReadOnly) => {
            let allScoresFilled = true;
            const isDisabled = isReadOnly ? 'disabled' : ''; // Usado nos inputs
            const isHidden = isReadOnly ? 'hidden' : ''; // Usado nos botões de confirmar

            const groupsHtml = activeChampionship.groups.map((group, groupIndex) => {
                const rankings = getRankings(group);

                const matchesHtml = group.matches.map((match, matchIndex) => {
                    const score1 = match.score[0];
                    const score2 = match.score[1];
                    if (score1 === null || score2 === null) allScoresFilled = false;

                    return `
                    <div class="bg-gray-100 p-3 sm:p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-center items-center gap-3 mt-3">
                            <input
                                type="number"
                                ...
                                value="${score1 === null ? '' : score1}"
                                id="g-${groupIndex}-m-${matchIndex}-s0" 
                                class="... ${isDisabled ? 'opacity-70' : ''}"
                                ${isDisabled}
                            />
                            <span class="text-gray-500">-</span>
                            <input
                                type="number"
                                ...
                                value="${score2 === null ? '' : score2}"
                                id="g-${groupIndex}-m-${matchIndex}-s1"
                                class="... ${isDisabled ? 'opacity-70' : ''}"
                                ${isDisabled}
                            />
                            <button 
                                class="confirm-group-score-btn ... ${isHidden}"
                                data-group-index="${groupIndex}"
                                data-match-index="${matchIndex}"
                                title="Confirmar Placar">
                                ${icons.check}
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');

                const rankingsHtml = rankings.map(/* ... */).join('');
                const printButton = `...`; // (sem alteração)

                return `
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 animate-fade-in border border-gray-200">
                    <div class="space-y-4 mb-6">${matchesHtml}</div>
                    <div>
                        </div>
                </div>
                `;
            }).join('');
            
            // =================================================================
            // === MUDANÇA: Botão de finalizar agora verifica `isReadOnly`
            // =================================================================
            const finalizeButtonHtml = (!isReadOnly && activeChampionship.status === 'groups') ? `
            <div class="mt-8 text-center">
                <button
                    id="finalize-groups-btn"
                    type="button"
                    ${!allScoresFilled ? 'disabled' : ''}
                    class="bg-green-600 hover:bg-green-700 text-white ... disabled:opacity-50">
                    ${icons.trophy}
                    ${allScoresFilled ? "Finalizar Grupos e Gerar Chaves" : "Preencha todos os placares"}
                </button>
            </div>
            ` : '';

            return `
                <div class="space-y-8 animate-fade-in">
                    ${groupsHtml}
                    ${finalizeButtonHtml}
                </div>
            `;
        };

        // (ADMIN) -- Sub-tela: Chaves (Mata-Mata) --
        const renderKnockoutView = (isFinished) => {
            // MUDANÇA: `isFinished` agora é o único controlador de "leitura"
            const goldHtml = renderBracket('Série Ouro', activeChampionship.goldBracket, 'goldBracket', isFinished);
            const silverHtml = renderBracket('Série Prata', activeChampionship.silverBracket, 'silverBracket', isFinished);
            
            // ... (lógica do Coveiro sem alteração) ...
            let coveiroHtml = ''; 
            // ...
            return `<div class="animate-fade-in">${goldHtml}${silverHtml}${coveiroHtml}</div>`;
        };

        // (ADMIN) -- Helper: Renderiza uma Chave (Bracket) --
        const renderBracket = (title, bracket, bracketType, isFinished) => {
            // ... (lógica de `rounds`, `maxRound`, `championHtml` sem alteração) ...
            const rounds = {};
            if (!bracket || bracket.length === 0) { /* ... (retorna msg 'chave não gerada') ... */ }
            bracket.forEach(match => { /* ... */ });
            const maxRound = Math.max(...bracket.map(m => m.round));
            const final = bracket.find(m => m.round === maxRound);
            const champion = final?.winner; 
            const championHtml = champion ? `...` : ''; // (HTML do campeão sem alteração)


            const roundsHtml = Object.keys(rounds).sort((a,b) => a-b).map(roundNum => {
                // ... (lógica de `roundTitle` sem alteração) ...
                const roundTitle = /* ... */;

                const matchesHtml = rounds[roundNum].map(match => {
                    const pair1 = match.pairs[0]; 
                    const pair2 = match.pairs[1]; 
                    // ... (lógica de `isPair1Winner`, `score1`, etc. sem alteração) ...
                    
                    // =================================================================
                    // === MUDANÇA: Lógica de 'disabled' simplificada (sem `isAdmin`)
                    // =================================================================
                    const isDisabled = (!pair1 || !pair2 || isFinished || match.winner) ? 'disabled' : '';
                    const isHidden = (!pair1 || !pair2 || isFinished || match.winner) ? 'hidden' : '';

                    return `
                    <div class="bg-gray-100 rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex justify-between items-center mb-2">
                            <input
                                type="number" ...
                                id="k-${match.id}-s0"
                                class="... ${isDisabled ? 'opacity-70' : ''}"
                                ${isDisabled}
                            />
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <input
                                type="number" ...
                                id="k-${match.id}-s1"
                                class="... ${isDisabled ? 'opacity-70' : ''}"
                                ${isDisabled}
                            />
                        </div>
                        
                        <div class="text-center mt-3 ${isHidden}">
                            <button 
                                class="confirm-knockout-score-btn ..."
                                data-bracket-type="${bracketType}"
                                data-match-id="${match.id}">
                                ${icons.check}
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');

                return `
                <div class="flex flex-col space-y-6 flex-shrink-0 w-72 sm:w-80">
                    <h4 class="text-xl font-semibold text-gray-800">${roundTitle}</h4>
                    ${matchesHtml}
                </div>
                `;
            }).join('');
            
            // ... (resto do HTML de `renderBracket` sem alteração) ...
            return `
            <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8 border border-gray-200">
                <h3 ...>${title}</h3>
                ${championHtml}
                <div class="flex gap-4 sm:gap-6 pb-4 overflow-x-auto">
                    ${roundsHtml}
                </div>
            </div>
            `;
        };

        /* =============================================================================
            TELA 4: Visão do Telão (READ-ONLY)
           ============================================================================= */
        
        // (Todas as funções `renderTelaoView`, `renderPlayerRegistration_ReadOnly`, 
        // `renderGroupStage_ReadOnly`, e `renderBracket_ReadOnly` permanecem as mesmas.
        // Elas já eram "read-only" e não dependiam de `appState.isAdmin`.)
        const renderTelaoView = () => { /* ... (mesma função) ... */ };
        const renderPlayerRegistration_ReadOnly = () => { /* ... (mesma função) ... */ };
        const renderGroupStage_ReadOnly = () => { /* ... (mesma função) ... */ };
        const renderKnockoutView_ReadOnly = (isFinished) => { /* ... (mesma função) ... */ };
        const renderBracket_ReadOnly = (title, bracket, bracketType, isFinished) => { /* ... (mesma função) ... */ };


        /* =============================================================================
            Lógica do Campeonato Ativo (Ações de Admin)
           ============================================================================= */

        // =================================================================
        // === MUDANÇA: `handleLaunchTelao` agora envia o `userId` na URL
        // =================================================================
        const handleLaunchTelao = () => {
            const champId = appState.currentChampionshipId;
            const userId = appState.userId; // O ID do usuário logado
            
            if (!champId || !userId) {
                showModal("Erro", "ID do campeonato ou do usuário não encontrado.");
                return;
            }

            // Constrói a URL para o modo telão com o userId
            const url = `${window.location.origin}${window.location.pathname}?telao=true&userId=${userId}&champId=${champId}`;
            window.open(url, '_blank');
        };

        // (Todas as funções `handle...` de admin abaixo permanecem as mesmas)
        // Elas já usam `saveActiveChampionship` ou `setDoc` com `appState.userId`,
        // que agora é o UID dinâmico do usuário logado. As travas `isAdmin` já
        // estavam nos `render...` (que removemos) ou em `saveActiveChampionship` (que removemos).
        const handleAddNewPlayerToChampionship = async (e) => { /* ... (mesma função) ... */ };
        const handleAddExistingPlayerToChampionship = async (e) => { /* ... (mesma função) ... */ };
        const handleDeletePlayerFromChampionship = async (playerId) => { /* ... (mesma função) ... */ };
        const handleGenerateChampionship = async () => { /* ... (mesma função) ... */ };
        const handleConfirmGroupScore = (groupIndex, matchIndex) => { /* ... (mesma função) ... */ };
        const handlePrintGroup = (groupIndex) => { /* ... (mesma função) ... */ };
        const handleFinalizeGroups = async () => { /* ... (mesma função) ... */ };
        const handleConfirmKnockoutScore = async (bracketType, matchId) => { /* ... (mesma função) ... */ };

        /* =============================================================================
            Lógica de Cálculo de Ranking (sem alterações)
           ============================================================================= */
        // (Funções `checkAndFinalizeChampionship`, `updateGlobalRanking`, `getRankings`, 
        // `getGlobalTournamentStats`, e `createBracket` permanecem as mesmas.
        // Elas já estão parametrizadas para usar o `appState.userId` dinâmico.)
        const checkAndFinalizeChampionship = async (champData) => { /* ... (mesma função) ... */ };
        const updateGlobalRanking = async (champData, winners, pointsConfig, rankingId) => { /* ... (mesma função) ... */ };
        const getRankings = (group) => { /* ... (mesma função) ... */ };
        const getGlobalTournamentStats = (champData) => { /* ... (mesma função) ... */ };
        const createBracket = (bracketPairs) => { /* ... (mesma função) ... */ };

        /* =============================================================================
            Funções de PDF (sem alterações)
           ============================================================================= */
        // (Funções `handlePrintRankingPDF` e `handlePrintChampionshipPDF` permanecem as mesmas)
        const handlePrintRankingPDF = () => { /* ... (mesma função) ... */ };
        const handlePrintChampionshipPDF = () => { /* ... (mesma função) ... */ };


        /* =============================================================================
            Inicialização do App (Autenticação e Listeners Globais)
            MUDANÇA RADICAL AQUI
           ============================================================================= */

        // (Os 4 listeners abaixo estão PERFEITOS como estão. Eles já leem
        // `appState.userId` e `appState.currentRankingId` dinamicamente.
        // Não precisamos mudar nada neles, apenas QUANDO eles são chamados.)
        const listenToGlobalPlayers = () => { /* ... (mesma função) ... */ };
        const listenToChampionships = () => { /* ... (mesma função) ... */ };
        const listenToActiveChampionship = (champId) => { /* ... (mesma função) ... */ };
        const listenToRankingsList = () => { /* ... (mesma função) ... */ };

        
        // =================================================================
        // === MUDANÇA: Novo Ponto de Entrada da Aplicação
        // =================================================================
        
        // 1. Verifica os parâmetros da URL ANTES de tudo
        const urlParams = new URLSearchParams(window.location.search);
        const telaoChampId = urlParams.get('champId');
        const telaoUserId = urlParams.get('userId'); // O ID do dono da liga

        if (urlParams.has('telao') && telaoChampId && telaoUserId) {
            
            // --- FLUXO 1: MODO TELÃO ---
            
            appState.isTelaoMode = true;
            appState.isAdmin = false; // Telão nunca é admin
            appState.userId = telaoUserId; // Configura o app para LER os dados deste UserId
            
            // Ajusta a UI para o modo telão
            const telaoStyles = document.createElement('style');
            telaoStyles.innerHTML = `
                body { background-color: #F7F7F7; }
                #app-container { max-width: 100%; padding: 1rem 2rem; }
                header, footer { display: none !important; }
            `;
            document.head.appendChild(telaoStyles);

            // Loga anonimamente para ter permissão de LEITURA
            signInAnonymously(auth).catch(error => {
                console.error("Erro no login anônimo do Telão:", error);
                showModal("Erro de Conexão", "Não foi possível conectar ao modo Telão.");
            });
            
            // O listener de auth do Telão
            onAuthStateChanged(auth, (user) => {
                if (user && user.isAnonymous) { // Espera o login anônimo funcionar
                    console.log("Modo Telão ativado. Lendo dados de:", telaoUserId);
                    userIdFooter.textContent = `Observando Liga: ${telaoUserId}`;
                    
                    // Inicia os listeners para LER os dados do dono da liga
                    listenToChampionships();
                    listenToRankingsList(); // Isso vai chamar listenToGlobalPlayers()
                    
                    // Navega para a tela do telão
                    navigateTo('telaoView', telaoChampId);
                }
            });

        } else {
            
            // --- FLUXO 2: MODO ADMIN (NORMAL) ---
            
            appState.isTelaoMode = false;
            
            onAuthStateChanged(auth, (user) => {
                
                if (user && !user.isAnonymous) {
                    // --- Usuário está LOGADO (com Email/Senha) ---
                    appState.userId = user.uid; // ID dinâmico do usuário
                    userIdFooter.textContent = user.email; // Mostra o email
                    
                    // Inicia os listeners para os dados DESTE usuário
                    listenToChampionships();
                    listenToRankingsList(); // Isso vai chamar listenToGlobalPlayers()

                    // Navega para o app
                    if (appState.currentView === 'loading' || appState.currentView === 'auth') {
                        navigateTo('championshipList');
                    } else {
                        render(); // Apenas renderiza (ex: F5 na página)
                    }

                } else {
                    // --- Usuário está DESLOGADO ---
                    
                    // Se o usuário era anônimo (do telão) e saiu, ou se o login falhou
                    if (user && user.isAnonymous) {
                        signOut(auth); // Desloga o anônimo se ele cair aqui por engano
                    }
                    
                    appState.userId = null;
                    userIdFooter.textContent = "Desconectado";
                    
                    // Para todos os listeners e limpa dados locais
                    unsubscribeChampionships();
                    unsubscribeGlobalPlayers();
                    unsubscribeActiveChampionship();
                    unsubscribeRankingsList();
                    championships = [];
                    globalPlayers = [];
                    allRankings = [];
                    activeChampionship = null;

                    // Força a ida para a tela de login/registro
                    navigateTo('auth');
                }
            });
        }

    </script>
</body>
</html>
