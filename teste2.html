<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Beach Tennis üéæ</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0891B2"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ranking BT">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #installBanner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0891B2; /* Cor 'Mar' (cyan-600) */
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #installBanner button {
            background-color: white;
            color: #0891B2; /* Cor 'Mar' (cyan-600) */
            border: none;
            padding: 6px 12px;
            margin-left: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        #installBanner button:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-amber-50 min-h-screen"> <div id="installBanner">
        Instale o aplicativo para ter acesso r√°pido na tela inicial!
        <button id="installBtn">Instalar</button>
    </div>

    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js') // Certifique-se que o nome √© 'sw.js'
                .then(() => console.log('‚úÖ Service Worker registrado com sucesso!'))
                .catch(err => console.log('‚ùå Erro ao registrar o Service Worker:', err));
        }

        // Banner de instala√ß√£o PWA
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // impede o prompt autom√°tico
            deferredPrompt = e;
            installBanner.style.display = 'block'; // mostra o banner
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt(); // mostra o prompt
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('‚úÖ Usu√°rio aceitou instalar');
            } else {
                console.log('‚ùå Usu√°rio recusou instalar');
            }
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            /* Cor de fundo agora controlada pelo Tailwind no <body> */
            color: #1F2937; /* Cor do Texto Principal (Gray-800) */
        }

        /* Anima√ß√£o de fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-fade-in-sm {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Para esconder elementos */
        .hidden {
            display: none;
        }

        /* Melhorias no Scrollbar (Mant√©m escuro para contraste) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FEF3C7; /* bg-amber-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF; /* bg-gray-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="text-gray-900"> <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 gap-4 bg-white p-4 rounded-xl shadow-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-600 text-center sm:text-left">
                üèñÔ∏è Ranking Beach Tennis
            </h1>
            <div id="header-buttons" class="flex gap-3">
                </div>
        </header>

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"></div>
            <p class="mt-4 text-gray-500">Carregando dados...</p>
        </div>

        <main id="main-content" class="hidden">
            </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>ID da Liga: <span id="user-id-footer">Conectando...</span></p>
            <p>App de Ranking v4.0.4 (Final)</p>
        </footer>

    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-sm w-full mx-auto animate-fade-in-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-cyan-600"></h3>
                <button id="modal-close-icon" class="text-gray-500 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-message" class="text-gray-700 text-sm sm:text-base mb-6 max-h-60 overflow-y-auto"></div>
            
            <div id="modal-buttons" class="flex gap-3 justify-end">
                <button
                    id="modal-close-btn"
                    class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                    Entendi
                </button>
                </div>
            
        </div>
    </div>
    <script type="module">
        // Importa√ß√µes do Firebase SDK
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            deleteDoc, 
            query,
            Timestamp,
            getDoc,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* =============================================================================
           Configura√ß√£o do Firebase (Fornecida pelo usu√°rio)
           ============================================================================= */
        const firebaseConfig = {
          apiKey: "AIzaSyDeS-rk8OJKhghv1djVucmR3-erOa-ppMY",
          authDomain: "campeonato-sortudo.firebaseapp.com",
          projectId: "campeonato-sortudo",
          storageBucket: "campeonato-sortudo.firebasestorage.app",
          messagingSenderId: "706083235199",
          appId: "1:706083235199:web:5eca6041bb817401ee264a"
        };

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); 

        /* =============================================================================
           ID Mestre e Senha de Admin
           ============================================================================= */
        const MESTRE_USER_ID = "campeonato-sortudo-admin";

        // ==========================================
        // === MUDE SUA SENHA DE ADMIN AQUI ===
        // ==========================================
        const ADMIN_PASSWORD = "adm2025"; 

        /* =============================================================================
           Estado Global do Aplicativo
           ============================================================================= */
        let appState = {
            userId: null, // Ser√° preenchido com o MESTRE_USER_ID
            isAuthReady: false,
            isAdmin: false, 
            isTelaoMode: false,
            currentView: 'loading', // 'loading', 'login', 'championshipList', 'championshipView', 'globalRanking', 'telaoView'
            currentChampionshipId: null,
            currentRankingId: null, // ID do ranking sendo visualizado/editado
        };

        let allRankings = []; // Lista de todos os rankings (ex: [{id: 'geral', name: 'Ranking Geral'}])
        let championships = []; // Lista de todos os campeonatos
        let globalPlayers = []; // Lista de jogadores DO RANKING ATUALMENTE SELECIONADO (appState.currentRankingId)
        let activeChampionship = null; // Dados do campeonato selecionado

        // Listeners do Firebase (para poder "desligar" ao trocar de tela)
        let unsubscribeRankingsList = () => {}; 
        let unsubscribeChampionships = () => {}; 
        let unsubscribeGlobalPlayers = () => {}; 
        let unsubscribeActiveChampionship = () => {}; 

        /* =============================================================================
           Refer√™ncias do DOM
           ============================================================================= */
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const headerButtons = document.getElementById('header-buttons');
        const userIdFooter = document.getElementById('user-id-footer');

        // Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        // CORRE√á√ÉO: Refer√™ncia ao novo DIV de bot√µes
        const modalButtons = document.getElementById('modal-buttons');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');

        /* =============================================================================
           Constantes de Pontua√ß√£o (Padr√£o)
           ============================================================================= */
        // Usado como fallback e valores padr√£o dos inputs
        const DEFAULT_RANKING_POINTS = {
            GOLD_WINNER: 100,
            GOLD_RUNNERUP: 70,
            SILVER_WINNER: 40,
            SILVER_RUNNERUP: 20,
            PARTICIPATION: 5
        };
        
        /* =============================================================================
           √çcones SVG (Reutilizados)
           ============================================================================= */
        const icons = {
            users: '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            swords: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></polyline><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"></polyline><line x1="11" y1="5" x2="5" y2="11"></line><line x1="8" y1="8" x2="4" y2="4"></line><line x1="3" y1="5" x2="5" y2="3"></line></svg>',
            trophy: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>',
            shield: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-yellow-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
            shieldOff: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-gray-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>',
            // √çcone "medal" removido (n√£o usado)
            award: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>',
            arrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
            eye: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
            logIn: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>',
            logOut: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            check: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
            shovel: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3 text-red-600"><path d="M2 22v-5l5-5 5 5v5H2z"></path><path d="M9.5 17H14a5 5 0 0 0 5-5V7A2 2 0 0 0 17 5H7a2 2 0 0 0-2 2v5a5 5 0 0 0 5 5z"></path><path d="M9.5 17v5"></path></svg>', 
            shovelSmall: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22v-5l5-5 5 5v5H2z"></path><path d="M9.5 17H14a5 5 0 0 0 5-5V7A2 2 0 0 0 17 5H7a2 2 0 0 0-2 2v5a5 5 0 0 0 5 5z"></path><path d="M9.5 17v5"></path></svg>',
            printer: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>',
            fileDown: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            tv: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>',
            // NOVO √çCONE (PARA EDI√á√ÉO)
            edit: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>'
        };

        /* =============================================================================
           Fun√ß√µes do Modal (ATUALIZADA)
           ============================================================================= */
        
        // ATUALIZADA: Limpa bot√µes extras
        const showModal = (title, message, buttons = null) => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            
            // Limpa bot√µes antigos e mostra o padr√£o
            modalButtons.innerHTML = '';
            modalCloseBtn.style.display = 'block';
            modalButtons.appendChild(modalCloseBtn);

            if (buttons) {
                // Se bot√µes customizados forem passados, esconde o padr√£o
                modalCloseBtn.style.display = 'none';
                buttons.forEach(btn => {
                    const buttonEl = document.createElement('button');
                    buttonEl.id = btn.id;
                    buttonEl.className = btn.className;
                    buttonEl.textContent = btn.text;
                    buttonEl.onclick = btn.handler;
                    modalButtons.appendChild(buttonEl);
                });
            }
            
            modal.classList.remove('hidden');
        };
        const hideModal = () => modal.classList.add('hidden');
        modalCloseBtn.addEventListener('click', hideModal);
        modalCloseIcon.addEventListener('click', hideModal);
        modal.addEventListener('click', hideModal);
        modal.firstElementChild.addEventListener('click', (e) => e.stopPropagation());

        /* =============================================================================
           Fun√ß√µes de Navega√ß√£o e Renderiza√ß√£o Principal
           ============================================================================= */

        // Router Principal
        const render = () => {

            // Esconde o spinner global se n√£o estivermos na tela de loading
            if (appState.currentView !== 'loading') {
                loadingSpinner.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                loadingSpinner.classList.remove('hidden');
                mainContent.classList.add('hidden');
                return;
            }

            // N√£o renderiza cabe√ßalho no Modo Tel√£o
            if (!appState.isTelaoMode) {
                renderHeaderButtons();
            }

            // Renderiza o conte√∫do principal baseado na view
            switch (appState.currentView) {
                case 'login': 
                    renderLogin();
                    break;
                case 'championshipList':
                    renderChampionshipList();
                    break;
                case 'globalRanking':
                    renderGlobalRanking();
                    break;
                case 'championshipView':
                    renderChampionshipView();
                    break;
                case 'telaoView':
                    renderTelaoView();
                    break;
                default:
                    mainContent.innerHTML = `<p>Estado desconhecido: ${appState.currentView}</p>`;
            }
        };

        const navigateTo = (view, champId = null) => {
            if (view === 'login') {
                appState.isAdmin = false;
            }

            appState.currentView = view;
            appState.currentChampionshipId = champId;

            // Desliga listeners antigos
            unsubscribeActiveChampionship();
            activeChampionship = null;

            // Se estamos abrindo um campeonato OU um tel√£o, precisamos garantir
            // que o listener global de players esteja olhando o ranking *correto*.
            if ((view === 'championshipView' || view === 'telaoView') && champId) {
                const champ = championships.find(c => c.id === champId);
                if (champ && champ.rankingId) {
                    // Se o ranking do app n√£o for o do camp, troca e re-escuta
                    if (appState.currentRankingId !== champ.rankingId) {
                        appState.currentRankingId = champ.rankingId;
                        listenToGlobalPlayers(); // Isso vai carregar globalPlayers com a lista certa
                    }
                } else if (championships.length > 0 && !champ) {
                    // Pode acontecer se os listeners n√£o estiverem prontos
                    console.warn("Navegando para o tel√£o, mas a lista de campeonatos ainda n√£o tem o ID:", champId);
                    // Tentaremos carregar mesmo assim.
                }
                listenToActiveChampionship(champId); // Isso vai carregar o camp e chamar o render()

            } else if (view === 'globalRanking') {
                // Garante que o listener de players est√° ligado ao ranking selecionado
                listenToGlobalPlayers();
                render();
            } else {
                // Para outras telas (login, champList), renderiza imediatamente
                render();
            }
        };

        const renderHeaderButtons = () => {
            let navHtml = ''; // Bot√µes de Navega√ß√£o (Voltar/Ranking)
            let authHtml = ''; // Bot√µes de Autentica√ß√£o (Login/Sair)

            // L√≥gica de Navega√ß√£o
            if (appState.currentView === 'championshipList') {
                navHtml = `
                <button
                    id="nav-to-ranking"
                    class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    üèÜ ${icons.award}
                    Ranking Geral
                </button>
                `;
            } else if (appState.currentView === 'globalRanking' || appState.currentView === 'championshipView') {
                navHtml = `
                <button
                    id="nav-to-list"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.arrowLeft}
                    Voltar
                </button>
                `;
            }

            // L√≥gica de Autentica√ß√£o
            if (appState.currentView !== 'login') {
                if (appState.isAdmin) {
                    authHtml = `
                    <button
                        id="nav-to-login"
                        class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                        ${icons.logOut}
                        Sair (Admin)
                    </button>
                    `;
                } else {
                    authHtml = `
                    <button
                        id="nav-to-login"
                        class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                        ${icons.logIn}
                        Login (Admin)
                    </button>
                    `;
                }
            }

            headerButtons.innerHTML = navHtml + authHtml; // Concatena os bot√µes

            // Adiciona listeners aos bot√µes
            const rankingBtn = document.getElementById('nav-to-ranking');
            if (rankingBtn) rankingBtn.addEventListener('click', () => navigateTo('globalRanking'));

            const listBtn = document.getElementById('nav-to-list');
            if (listBtn) listBtn.addEventListener('click', () => navigateTo('championshipList'));

            const loginBtn = document.getElementById('nav-to-login');
            if (loginBtn) loginBtn.addEventListener('click', () => navigateTo('login'));
        };

        /* =============================================================================
           TELA 0: Login
           ============================================================================= */

        const renderLogin = () => {
            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto animate-fade-in">
                    <h2 class="text-3xl font-bold text-center text-cyan-600 mb-8">Bem-vindo(a) üéæ</h2>
                    
                    <div class="space-y-4">
                        <button
                            id="visitor-login-btn"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 px-6 rounded-lg shadow-sm transition-all flex items-center justify-center gap-3 text-lg">
                            ${icons.eye}
                            Modo Visitante
                        </button>
                        
                        <button
                            id="admin-login-btn"
                            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-3 text-lg">
                            ${icons.logIn}
                            Modo Administrador
                        </button>
                    </div>
                </div>
            `;

            // Listeners
            document.getElementById('visitor-login-btn').addEventListener('click', () => {
                appState.isAdmin = false;
                navigateTo('championshipList');
            });

            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const password = prompt("Digite a senha de administrador:");
                if (password === ADMIN_PASSWORD) {
                    appState.isAdmin = true;
                    navigateTo('championshipList');
                } else if (password !== null) { // S√≥ mostra erro se o usu√°rio n√£o clicou em "Cancelar"
                    showModal("Acesso Negado", "Senha incorreta.");
                }
            });
        };

        /* =============================================================================
           TELA 1: Lista de Campeonatos (Hist√≥rico)
           ============================================================================= */

        const renderChampionshipList = () => {
            const sortedChampionships = [...championships].sort((a, b) => b.createdAt - a.createdAt);

            const championshipsListHtml = sortedChampionships.length === 0
                ? `<p class="text-gray-500 text-center py-4">Nenhum campeonato cadastrado.</p>`
                : sortedChampionships.map(champ => {
                    let statusColor = 'text-yellow-600';
                    let statusText = 'Em andamento';
                    if (champ.status === 'registration') { statusColor = 'text-cyan-600'; statusText = 'Em Inscri√ß√£o'; }
                    if (champ.status === 'finished') { statusColor = 'text-emerald-600'; statusText = 'Finalizado üèÖ'; }

                    const ranking = allRankings.find(r => r.id === champ.rankingId);
                    // Cor 'Acento' (orange-500)
                    const rankingHtml = ranking ? `<span class="block text-xs text-orange-600 font-medium">${ranking.name}</span>` : '';

                    const deleteButtonHtml = appState.isAdmin ? `
                    <button
                        class="delete-champ-btn text-rose-600 hover:text-rose-700 transition-colors p-2 rounded-lg bg-gray-100"
                        data-id="${champ.id}">
                        ${icons.trash}
                    </button>` : '';

                    return `
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-white border border-gray-200 p-4 rounded-xl shadow-sm animate-fade-in-sm gap-3">
                        <div>
                            <span class="text-gray-800 font-bold text-lg">${champ.name}</span>
                            <span class="block text-sm ${statusColor}">${statusText}</span>
                            ${rankingHtml}
                            <span class="block text-xs text-gray-500">${new Date(champ.createdAt?.toDate()).toLocaleDateString()}</span>
                        </div>
                        <div class="flex gap-2">
                             <button
                                class="open-champ-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm"
                                data-id="${champ.id}">
                                ${icons.eye} Ver
                            </button>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                    `}).join('');

            const rankingsOptions = allRankings.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            const newChampionshipFormHtml = appState.isAdmin ? `
            <form id="add-championship-form">
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mb-8 border border-gray-200">
                    <h2 class="text-2xl font-bold text-cyan-600 mb-4">üéæ Novo Campeonato</h2>
                    
                    <div class="mb-4">
                        <label for="championship-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nome do Campeonato</label>
                        <input
                            type="text"
                            id="championship-name-input"
                            placeholder="ex: Torneio de Ver√£o"
                            class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            required
                        />
                    </div>
                    
                    <div class="mb-4">
                        <label for="ranking-select" class="block text-sm font-medium text-gray-700 mb-1">Vincular ao Ranking</label>
                        <div class="flex gap-2">
                            <select id="ranking-select" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                                ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking encontrado...</option>'}
                            </select>
                            <button type="button" id="add-new-ranking-btn" class="flex-shrink-0 bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-lg shadow-md transition-all">
                                ${icons.plus}
                            </button>
                        </div>
                    </div>


                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Configura√ß√£o de Pontos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div>
                            <label for="points-gold-winner" class="block text-xs font-medium text-emerald-600 mb-1">Campe√£o Ouro ü•á</label>
                            <input type="number" id="points-gold-winner" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_WINNER}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-gold-runnerup" class="block text-xs font-medium text-emerald-700 mb-1">Vice Ouro</label>
                            <input type="number" id="points-gold-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_RUNNERUP}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-silver-winner" class="block text-xs font-medium text-gray-600 mb-1">Campe√£o Prata ü•à</label>
                            <input type="number" id="points-silver-winner" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_WINNER}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-silver-runnerup" class="block text-xs font-medium text-gray-700 mb-1">Vice Prata</label>
                            <input type="number" id="points-silver-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_RUNNERUP}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-participation" class="block text-xs font-medium text-gray-500 mb-1">Participa√ß√£o</label>
                            <input type="number" id="points-participation" min="0" value="${DEFAULT_RANKING_POINTS.PARTICIPATION}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                    </div>

                    <button
                        type="submit"
                        id="add-championship-btn"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                        ${icons.plus}
                        <span>Criar Campeonato</span>
                    </button>
                </div>
            </form>
            ` : ''; // Se n√£o for admin, n√£o mostra nada

            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    ${newChampionshipFormHtml}

                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 border border-gray-200">
                        <h3 class="text-2xl font-bold mb-5 text-cyan-600">Hist√≥rico de Campeonatos</h3>
                        <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-3">
                            ${championshipsListHtml}
                        </div>
                    </div>
                </div>
            `;

            // Listeners (s√≥ adiciona se o elemento existir)
            if (appState.isAdmin) {
                const addForm = document.getElementById('add-championship-form');
                if (addForm) addForm.addEventListener('submit', handleAddChampionship);

                // NOVO: Listener para criar ranking
                const addRankingBtn = document.getElementById('add-new-ranking-btn');
                if (addRankingBtn) addRankingBtn.addEventListener('click', handleAddNewRanking);

                document.querySelectorAll('.delete-champ-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeleteChampionship(btn.dataset.id));
                });
            }

            document.querySelectorAll('.open-champ-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo('championshipView', btn.dataset.id));
            });
        };

        const handleAddChampionship = async (e) => {
            e.preventDefault();
            // Esta fun√ß√£o s√≥ √© chamada se o formul√°rio existir (isAdmin = true)
            const input = document.getElementById('championship-name-input');
            const button = document.getElementById('add-championship-btn');
            const champName = input.value.trim();
            if (!champName) return;

            // =================================================================
            // === MUDAN√áA (REQUEST 3): Pega o ID do ranking selecionado ===
            // =================================================================
            const rankingId = document.getElementById('ranking-select').value;
            if (!rankingId) {
                showModal("Erro", "Nenhum ranking foi selecionado. Crie um ranking primeiro.");
                return;
            }

            button.disabled = true;
            button.lastChild.textContent = "Criando...";

            // Coleta os pontos personalizados
            const pointsConfig = {
                goldWinner: parseInt(document.getElementById('points-gold-winner').value) || 0,
                goldRunnerUp: parseInt(document.getElementById('points-gold-runnerup').value) || 0,
                silverWinner: parseInt(document.getElementById('points-silver-winner').value) || 0,
                silverRunnerUp: parseInt(document.getElementById('points-silver-runnerup').value) || 0,
                participation: parseInt(document.getElementById('points-participation').value) || 0
            };

            try {
                const batch = writeBatch(db);

                // 1. Cria a refer√™ncia para o NOVO doc de campeonato
                const champCollectionRef = collection(db, 'users', appState.userId, 'championships');
                const newChampRef = doc(champCollectionRef);

                // 2. Cria a refer√™ncia para o doc de dados aninhado
                const champDataRef = doc(db, 'users', appState.userId, 'championships', newChampRef.id, 'data', 'main');

                // 3. Adiciona os dados ao batch
                batch.set(newChampRef, {
                    name: champName,
                    createdAt: Timestamp.now(),
                    status: 'registration',
                    winnerGold: null,
                    winnerSilver: null,
                    pointsConfig: pointsConfig, // Salva os pontos personalizados
                    rankingId: rankingId, // NOVO: Salva o ID do ranking
                    finalPointsAwarded: null // NOVO (Feature Edi√ß√£o): Inicia como nulo
                });

                batch.set(champDataRef, {
                    players: [],
                    groups: [],
                    goldBracket: [],
                    silverBracket: [],
                    status: 'registration'
                });

                // 4. Executa o batch
                await batch.commit();

                input.value = '';
                showModal("Sucesso!", `Campeonato "${champName}" criado e vinculado ao ranking.`);
            } catch (error) {
                console.error("Erro ao criar campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel criar o campeonato.");
            }

            button.disabled = false;
            button.lastChild.textContent = "Criar Campeonato";
        };

        const handleDeleteChampionship = async (champId) => {
            // Esta fun√ß√£o s√≥ √© chamada se o bot√£o existir (isAdmin = true)
            const champ = championships.find(c => c.id === champId);
            if (window.prompt(`Para confirmar, digite o nome do campeonato: "${champ.name}"`) !== champ.name) {
                showModal("Cancelado", "A exclus√£o foi cancelada.");
                return;
            }
            
            // PERIGO: Esta exclus√£o n√£o remove os pontos do ranking global.
            // A funcionalidade de "recalcular" (Feature 2) ajudar√° a corrigir isso
            // se um admin excluir e recriar um camp, mas por enquanto √© uma exclus√£o simples.
            // Idealmente, dever√≠amos rodar um "applyRankingDiff" reverso aqui.

            try {
                // Deleta o documento de dados
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main'));
                // Deleta o documento principal
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId));
            } catch (error) {
                console.error("Erro ao excluir campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel excluir o campeonato.");
            }
        };

        // =================================================================
        // === NOVA FUN√á√ÉO: Para criar um novo ranking (temporada, etc)
        // =================================================================
        const handleAddNewRanking = async () => {
            const name = prompt("Nome do novo ranking (ex: Temporada 2025):");
            if (!name || name.trim() === '') return;

            // Cria um ID seguro para o banco de dados
            const id = name.trim().toLowerCase()
                .replace(/\s+/g, '-') // substitui espa√ßos por -
                .replace(/[^a-z0-9-]/g, ''); // remove caracteres n√£o-alfanum√©ricos (exceto -)

            if (!id) {
                showModal("Erro", "Nome inv√°lido. Use letras e n√∫meros.");
                return;
            }

            // Verifica se o ID ou Nome j√° existem
            if (allRankings.find(r => r.id === id || r.name.toLowerCase() === name.trim().toLowerCase())) {
                showModal("Erro", "Um ranking com esse nome ou ID j√° existe.");
                return;
            }

            const newRanking = { id, name: name.trim() };
            const newList = [...allRankings, newRanking];

            try {
                // Salva a lista atualizada no documento 'rankings'
                await setDoc(doc(db, 'users', appState.userId, 'app_data', 'rankings'), { list: newList });
                showModal("Sucesso!", `Ranking "${name.trim()}" foi criado.`);
                // O listener 'listenToRankingsList' vai atualizar a UI automaticamente
            } catch (error) {
                console.error("Erro ao criar ranking:", error);
                showModal("Erro", "N√£o foi poss√≠vel salvar o novo ranking.");
            }
        };

        /* =============================================================================
           TELA 2: Ranking Global
           ============================================================================= */

        const renderGlobalRanking = () => {
            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);

            const rankingsHtml = sortedPlayers.length === 0
                ? `<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum jogador neste ranking.</td></tr>`
                : sortedPlayers.map((player, index) => `
                    <tr class="border-b border-amber-100 animate-fade-in-sm">
                        <td class="p-3 sm:p-4 font-bold text-lg text-cyan-600">${index + 1}¬∫</td>
                        <td class="p-3 sm:p-4 font-medium text-gray-800">${player.name}</td>
                        <td class="p-3 sm:p-4 font-bold text-xl text-orange-600">${player.points || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-emerald-600">${player.goldWins || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-gray-600">${player.silverWins || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-rose-600">${player.coveiroWins || 0}</td>
                    </tr>
                `).join('');

            const rankingsOptions = allRankings.map(r => 
                `<option value="${r.id}" ${r.id === appState.currentRankingId ? 'selected' : ''}>
                    ${r.name}
                </option>`
            ).join('');

            const manageButtonHtml = appState.isAdmin ? `
                <button id="manage-rankings-btn" class="flex-shrink-0 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerenciar Rankings">
                    ${icons.settings}
                </button>
            ` : '';

            // Bot√£o Gerar PDF
            const printButtonHtml = `
                <button id="print-ranking-pdf-btn" class="flex-shrink-0 bg-rose-600 hover:bg-rose-700 text-white font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerar PDF do Ranking">
                    ${icons.fileDown}
                </button>
            `;

            const rankingSelectorHtml = `
                <div class="mb-6">
                    <label for="ranking-view-select" class="block text-sm font-medium text-gray-700 mb-1">Visualizando Ranking:</label>
                    <div class="flex gap-2">
                        <select id="ranking-view-select" class="w-full bg-white border border-gray-300 text-gray-800 rounded-lg p-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking...</option>'}
                        </select>
                        ${manageButtonHtml}
                        ${printButtonHtml}
                    </div>
                </div>
            `;

            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in border border-gray-200">
                    <h2 class="text-3xl font-bold mb-6 text-cyan-600 flex items-center gap-3">
                        üèÜ ${icons.award} Ranking Geral
                    </h2>
                    
                    ${rankingSelectorHtml}

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="bg-amber-100"> <th class="p-3 sm:p-4 rounded-tl-lg text-gray-600">Pos.</th>
                                    <th class="p-3 sm:p-4 text-gray-600">Jogador</th>
                                    <th class="p-3 sm:p-4 text-gray-600">Pontos</th>
                                    <th class="p-3 sm:p-4 text-center text-gray-600">ü•á Ouro</th>
                                    <th class="p-3 sm:p-4 text-center text-gray-600">ü•à Prata</th>
                                    <th class="p-3 sm:p-4 text-center rounded-tr-lg text-gray-600">üëª ${icons.shovelSmall}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-amber-100"> ${rankingsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const rankingViewSelect = document.getElementById('ranking-view-select');
            if (rankingViewSelect) rankingViewSelect.addEventListener('change', handleViewRankingChange);
            
            const manageRankingsBtn = document.getElementById('manage-rankings-btn');
            if (manageRankingsBtn) manageRankingsBtn.addEventListener('click', renderRankingManagementModal);

            const printRankingBtn = document.getElementById('print-ranking-pdf-btn');
            if (printRankingBtn) printRankingBtn.addEventListener('click', handlePrintRankingPDF);
        };
        const renderRankingManagementModal = () => {
                const rankingsHtml = allRankings.map(r => {
                    const inUse = championships.find(c => c.rankingId === r.id);
                    const deleteBtn = inUse ? 
                        `<span class="text-xs text-gray-500" title="Em uso pelo camp: ${inUse.name}">Em uso</span>` :
                        `<button class="delete-ranking-btn text-rose-600 hover:text-rose-700" data-id="${r.id}" data-name="${r.name}">${icons.trash}</button>`;

                    return `
                    <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                        <span class="text-gray-800 font-medium">${r.name}</span>
                        ${deleteBtn}
                    </div>
                    `;
                }).join('');

                const modalContent = `
                    <p class="text-sm text-gray-500 mb-4">Voc√™ s√≥ pode excluir rankings que n√£o est√£o sendo usados por nenhum campeonato.</p>
                    <div class="space-y-2">
                        ${rankingsHtml.length > 0 ? rankingsHtml : '<p>Nenhum ranking criado.</p>'}
                    </div>
                `;

                showModal("Gerenciar Rankings", modalContent);

                document.querySelectorAll('.delete-ranking-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const name = e.currentTarget.dataset.name;
                        handleDeleteRanking(id, name);
                    });
                });
            };

            const handleDeleteRanking = async (rankingId, rankingName) => {
                if (!confirm(`Tem certeza que deseja excluir o ranking "${rankingName}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                    return;
                }

                const inUse = championships.find(c => c.rankingId === rankingId);
                if (inUse) {
                    showModal("Erro", `N√£o √© poss√≠vel excluir. Este ranking est√° em uso pelo campeonato "${inUse.name}".`);
                    return;
                }

                const newList = allRankings.filter(r => r.id !== rankingId);

                try {
                    await setDoc(doc(db, 'users', appState.userId, 'app_data', 'rankings'), { list: newList });
                    hideModal();
                } catch (error) {
                    console.error("Erro ao excluir ranking:", error);
                    showModal("Erro", "N√£o foi poss√≠vel excluir o ranking.");
                }
            };


            const handleViewRankingChange = (e) => {
                const newRankingId = e.target.value;
                appState.currentRankingId = newRankingId;
                globalPlayers = []; 

                render(); 
                listenToGlobalPlayers();
            };

            /* =============================================================================
               TELA 3: Vis√£o do Campeonato (ADMIN)
               ============================================================================= */

            // Fun√ß√£o "Router" da tela do campeonato (ADMIN)
            const renderChampionshipView = () => {
                if (!activeChampionship) {
                    mainContent.innerHTML = `
                    <div class="text-center py-20 animate-fade-in">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-600 mx-auto"></div>
                        <p class="mt-4 text-gray-500">Carregando campeonato...</p>
                    </div>
                    `;
                    return;
                }

                let html = '';
                const champInfo = championships.find(c => c.id === appState.currentChampionshipId);

                // Bot√µes PDF (se finalizado) e Tel√£o (sempre)
                let topButtonsHtml = '';
                if (appState.isAdmin) { // S√≥ admin v√™ esses bot√µes
                    let pdfButtonHtml = '';
                    if (champInfo?.status === 'finished') {
                        pdfButtonHtml = `
                            <button id="print-champ-pdf-btn" class="w-full sm:w-auto bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                                ${icons.fileDown}
                                Gerar PDF
                            </button>
                        `;
                    }

                    const telaoButtonHtml = `
                        <button id="launch-telao-btn" class="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                            ${icons.tv}
                            Abrir Tel√£o
                        </button>
                    `;

                    topButtonsHtml = `
                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8 animate-fade-in border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            ${telaoButtonHtml}
                            ${pdfButtonHtml}
                        </div>
                    </div>
                    `;
                }

                // Define o conte√∫do baseado no status
                if (champInfo?.status === 'finished') {
                    html = topButtonsHtml + renderGroupStage() + renderKnockoutView(true);
                } else if (activeChampionship.status === 'knockout') {
                    html = topButtonsHtml + renderGroupStage() + renderKnockoutView(false);
                } else if (activeChampionship.status === 'groups') {
                    html = topButtonsHtml + renderGroupStage();
                } else { // 'registration'
                    html = topButtonsHtml + renderPlayerRegistration();
                }

                // Injeta o HTML de todas as se√ß√µes de uma vez
                mainContent.innerHTML = html;

                // ===========================================
                // === RE-ATTACH ALL LISTENERS (ADMIN) ===
                // ===========================================

                // Listeners de Registro
                if (appState.isAdmin && activeChampionship.status === 'registration') {
                    const addExistingForm = document.getElementById('add-existing-player-form');
                    if (addExistingForm) addExistingForm.addEventListener('submit', handleAddExistingPlayerToChampionship);

                    const addNewForm = document.getElementById('add-new-player-form');
                    if (addNewForm) addNewForm.addEventListener('submit', handleAddNewPlayerToChampionship);

                    document.querySelectorAll('.delete-player-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleDeletePlayerFromChampionship(btn.dataset.id));
                    });

                    const generateBtn = document.getElementById('generate-champ-btn');
                    if (generateBtn) generateBtn.addEventListener('click', handleGenerateChampionship);
                }

                // Listeners da Fase de Grupos
                if (activeChampionship.status === 'groups' || activeChampionship.status === 'knockout' || champInfo?.status === 'finished') {

                    // Listener de Impress√£o (para todos)
                    document.querySelectorAll('.print-group-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const groupIndex = e.currentTarget.dataset.groupIndex;
                            handlePrintGroup(groupIndex);
                        });
                    });

                    // Listeners de Admin
                    if (appState.isAdmin) {
                        // BOT√ÉO DE CONFIRMAR (Check ‚úÖ)
                        document.querySelectorAll('.confirm-group-score-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const { groupIndex, matchIndex } = e.currentTarget.dataset;
                                handleConfirmGroupScore(groupIndex, matchIndex);
                            });
                        });
                        
                        // NOVO: BOT√ÉO DE EDITAR (L√°pis ‚úèÔ∏è)
                        document.querySelectorAll('.edit-group-score-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const { groupIndex, matchIndex } = e.currentTarget.dataset;
                                handleEditGroupScore(groupIndex, matchIndex); // <- Nova fun√ß√£o
                            });
                        });

                        if (activeChampionship.status === 'groups') {
                            const finalizeBtn = document.getElementById('finalize-groups-btn');
                            if (finalizeBtn) finalizeBtn.addEventListener('click', handleFinalizeGroups);
                        }
                    }
                }


                // Listeners do Mata-Mata
                if (appState.isAdmin && (activeChampionship.status === 'knockout' || champInfo?.status === 'finished')) {
                     // BOT√ÉO DE CONFIRMAR (Check ‚úÖ)
                     document.querySelectorAll('.confirm-knockout-score-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const { bracketType, matchId } = e.currentTarget.dataset;
                            handleConfirmKnockoutScore(bracketType, matchId);
                        });
                    });
                    
                    // NOVO: BOT√ÉO DE EDITAR (L√°pis ‚úèÔ∏è)
                    document.querySelectorAll('.edit-knockout-score-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const { bracketType, matchId } = e.currentTarget.dataset;
                            handleEditKnockoutScore(bracketType, matchId); // <- Nova fun√ß√£o
                        });
                    });
                }

                // Listeners dos Bot√µes do Topo (PDF e Tel√£o)
                if (appState.isAdmin) {
                    const launchTelaoBtn = document.getElementById('launch-telao-btn');
                    if (launchTelaoBtn) launchTelaoBtn.addEventListener('click', handleLaunchTelao);

                    if (champInfo?.status === 'finished') {
                        const printChampBtn = document.getElementById('print-champ-pdf-btn');
                        if (printChampBtn) printChampBtn.addEventListener('click', handlePrintChampionshipPDF);
                    }
                }
            };

            // Salva os dados DO CAMPEONATO ATIVO
            const saveActiveChampionship = async (newChampData) => {
                if (!appState.userId || !appState.currentChampionshipId) return;
                if (!appState.isAdmin) {
                    console.warn("Modo Visitante: Altera√ß√µes n√£o foram salvas.");
                    return;
                }
                try {
                    const champDataRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId, 'data', 'main');
                    await setDoc(champDataRef, newChampData);
                } catch (error) {
                    console.error("Erro ao salvar campeonato:", error);
                    showModal("Erro", "N√£o foi poss√≠vel salvar as altera√ß√µes. Se este erro persistir, pode ser um problema de regras do Firestore.");
                }
            };

            // (ADMIN) -- Sub-tela: Registro de Jogadores --
            const renderPlayerRegistration = () => {
                const playersListHtml = activeChampionship.players.length === 0
                    ? `<p class="text-gray-500 text-center py-4">Nenhum jogador cadastrado neste torneio.</p>`
                    : activeChampionship.players.map(player => {
                        const deleteButton = appState.isAdmin ? `
                        <button class="delete-player-btn text-rose-600 hover:text-rose-700 transition-colors" data-id="${player.id}">
                            ${icons.trash}
                        </button>` : '';

                        return `
                        <div class="flex justify-between items-center bg-amber-50 p-3 rounded-lg animate-fade-in-sm border border-amber-200">
                            <span class="text-gray-800 font-medium">${player.name}</span>
                            ${deleteButton}
                        </div>
                        `
                    }).join('');

                const validPlayerCounts = [4, 8, 16, 32];
                const playerCount = activeChampionship.players.length;

                // A valida√ß√£o agora exige m√∫ltiplo de 4
                const isMultipleOfFour = playerCount % 4 === 0;
                const minPlayersForGroups = 4;
                const canGenerate = playerCount >= minPlayersForGroups && isMultipleOfFour;

                const generateButtonHtml = playerCount >= minPlayersForGroups
                    ? `
                    <div class="mt-8 text-center">
                        <button
                            id="generate-champ-btn"
                            type="button"
                            ${!canGenerate ? 'disabled' : ''}
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-8 rounded-lg shadow-xl transition-all flex items-center justify-center gap-3 text-lg mx-auto disabled:opacity-50 disabled:cursor-not-allowed">
                            ${icons.swords}
                            Gerar Grupos
                        </button>
                        ${!canGenerate ? `<p class="text-rose-600 text-sm mt-3">O campeonato requer um n√∫mero de jogadores m√∫ltiplo de 4 para grupos de 4 (ex: 4, 8, 12...). Voc√™ tem ${playerCount}.</p>` : ''}
                    </div>
                    ` : `<p class="text-gray-500 text-sm mt-3 text-center">M√≠nimo de ${minPlayersForGroups} jogadores para come√ßar.</p>`;

                const playersInTournamentIds = new Set(activeChampionship.players.map(p => p.id));
                const availablePlayersFromRanking = globalPlayers.filter(p => !playersInTournamentIds.has(p.id));

                const existingPlayersOptions = availablePlayersFromRanking.length > 0
                    ? availablePlayersFromRanking.map(p => `<option value="${p.id}">${p.name}</option>`).join('')
                  : '<option disabled>Nenhum jogador dispon√≠vel no ranking</option>';


                // Formul√°rio de adicionar jogador (s√≥ para admin)
                const addPlayerFormHtml = appState.isAdmin ? `
                <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <form id="add-existing-player-form">
                        <label for="existing-player-select" class="block text-sm font-medium text-gray-700 mb-1">Adicionar do Ranking</label>
                        <div class="flex gap-2">
                            <select id="existing-player-select" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" ${availablePlayersFromRanking.length === 0 ? 'disabled' : ''}>
                                ${existingPlayersOptions}
                            </select>
                            <button
                                type="submit"
                                id="add-existing-player-btn"
                                class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition-all flex items-center justify-center gap-2 disabled:opacity-50"
                                ${availablePlayersFromRanking.length === 0 ? 'disabled' : ''}>
                                ${icons.plus}
                            </button>
                        </div>
                    </form>

                    <form id="add-new-player-form">
                        <label for="new-player-name-input" class="block text-sm font-medium text-gray-700 mb-1">Adicionar Novo Jogador</label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="new-player-name-input"
                                placeholder="Nome do Novo Jogador"
                                class="flex-grow bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            />
                            <button
                                type="submit"
                                id="add-new-player-btn"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                                ${icons.plus}
                            </button>
                        </div>
                    </form>
                </div>
                ` : '';

                return `
                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in border border-gray-200">
                        
                        ${addPlayerFormHtml}

                        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 border border-gray-200">
                            <h3 class="text-xl font-semibold mb-4 text-cyan-600 flex items-center gap-2">
                                ${icons.users}
                                Jogadores Inscritos (${playerCount})
                            </h3>
                            <div class="max-h-96 overflow-y-auto pr-2 space-y-2">
                                ${playersListHtml}
                            </div>
                        </div>
                        
                        ${appState.isAdmin ? generateButtonHtml : ''}
                    </div>
                `;
            };

            // (ADMIN) -- Sub-tela: Fase de Grupos --
            const renderGroupStage = () => {
                let allScoresFilled = true;
                const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
                const isFinished = champInfo?.status === 'finished';

                // NOVO: Desabilita inputs se N√ÉO for admin
                // (Mas permite edi√ß√£o se for admin, mesmo que finalizado)
                const isDisabled = !appState.isAdmin ? 'disabled' : '';
                const adminButtonsClass = appState.isAdmin ? '' : 'hidden';

                const groupsHtml = activeChampionship.groups.map((group, groupIndex) => {
                    const rankings = getRankings(group);

                    const matchesHtml = group.matches.map((match, matchIndex) => {
                        const score1 = match.score[0];
                        const score2 = match.score[1];
                        if (score1 === null || score2 === null) allScoresFilled = false;

                        // NOVO: Bot√£o de Edi√ß√£o (‚úèÔ∏è)
                        // Aparece se o jogo J√Å tiver placar, ou se o torneio estiver finalizado
                        const showEditButton = (score1 !== null || isFinished);
                        const showConfirmButton = !showEditButton;

                        return `
                        <div class="bg-amber-50 p-3 sm:p-4 rounded-lg border border-amber-200">
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                                <span class="text-sm text-gray-700 text-center sm:text-left">${match.names[0]}</span>
                                <span class="font-bold text-cyan-600">vs</span>
                                <span class="text-sm text-gray-700 text-center sm:text-right">${match.names[1]}</span>
                            </div>
                            <div class="flex justify-center items-center gap-3 mt-3">
                                <input
                                    type="number"
                                    min="0"
                                    value="${score1 === null ? '' : score1}"
                                    id="g-${groupIndex}-m-${matchIndex}-s0" 
                                    class="w-20 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${isDisabled ? 'opacity-70' : ''}"
                                    ${isDisabled}
                                />
                                <span class="text-gray-500">-</span>
                                <input
                                    type="number"
                                    min="0"
                                    value="${score2 === null ? '' : score2}"
                                    id="g-${groupIndex}-m-${matchIndex}-s1"
                                    class="w-20 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${isDisabled ? 'opacity-70' : ''}"
                                    ${isDisabled}
                                />
                                
                                <button 
                                    class="confirm-group-score-btn p-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-md transition-all ${adminButtonsClass} ${showConfirmButton ? '' : 'hidden'}"
                                    data-group-index="${groupIndex}"
                                    data-match-index="${matchIndex}"
                                    title="Confirmar Placar">
                                    ${icons.check}
                                </button>
                                
                                <button 
                                    class="edit-group-score-btn p-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg shadow-md transition-all ${adminButtonsClass} ${showEditButton ? '' : 'hidden'}"
                                    data-group-index="${groupIndex}"
                                    data-match-index="${matchIndex}"
                                    title="Editar Placar">
                                    ${icons.edit}
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('');

                    const rankingsHtml = rankings.map((player, rankIndex) => `
                        <tr class="border-b border-gray-200 ${rankIndex < 2 ? 'text-emerald-600' : 'text-orange-600'}">
                            <td class="p-3 font-bold">${rankIndex + 1}¬∫</td>
                            <td class="p-3 text-gray-800">${player.name}</td>
                            <td class="p-3 font-bold">${player.gamesWon}</td>
                        </tr>
                    `).join('');

                    // Bot√£o de Impress√£o (para ficha)
                    const printButton = `
                        <button class="print-group-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg shadow-sm transition-all flex items-center gap-2 text-sm" data-group-index="${groupIndex}">
                            ${icons.printer}
                        </button>
                    `;

                    return `
                    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 animate-fade-in border border-gray-200">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-2xl font-bold text-cyan-600">Grupo ${groupIndex + 1}</h3>
                            ${printButton}
                        </div>
                        <div class="space-y-4 mb-6">${matchesHtml}</div>
                        <div>
                            <h4 class="text-lg font-semibold mb-3 text-gray-800">Ranking do Grupo</h4>
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-amber-100">
                                        <th class="p-3 rounded-l-lg text-gray-600">Pos.</th>
                                        <th class="p-3 text-gray-600">Jogador</th>
                                        <th class="p-3 rounded-r-lg text-gray-600">Games Vencidos</th>
                                    </tr>
                                </thead>
                                <tbody>${rankingsHtml}</tbody>
                            </table>
                            <div class="flex justify-between mt-2 text-sm">
                                <span class="text-emerald-600">‚ñ≤ Dupla Ouro ü•á</span>
                                <span class="text-orange-600">‚ñº Dupla Prata ü•à</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Bot√£o de finalizar S√ì aparece para admin E S√ì na fase de grupos
                const finalizeButtonHtml = (appState.isAdmin && activeChampionship.status === 'groups') ? `
                <div class="mt-8 text-center">
                    <button
                        id="finalize-groups-btn"
                        type="button"
                        ${!allScoresFilled ? 'disabled' : ''}
                        class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-8 rounded-lg shadow-xl transition-all flex items-center justify-center gap-3 text-lg mx-auto disabled:opacity-50 disabled:cursor-not-allowed">
                        ${icons.trophy}
                        ${allScoresFilled ? "Finalizar Grupos e Gerar Chaves" : "Preencha todos os placares"}
                    </button>
                </div>
                ` : '';

                return `
                    <div class="space-y-8 animate-fade-in">
                        ${groupsHtml}
                        ${finalizeButtonHtml}
                    </div>
                `;
            };

            // (ADMIN) -- Sub-tela: Chaves (Mata-Mata) --
            const renderKnockoutView = (isFinished) => {
                // Chamadas de renderBracket sem o √≠cone nos par√¢metros (apenas o t√≠tulo)
                const goldHtml = renderBracket('S√©rie Ouro ü•á', activeChampionship.goldBracket, 'goldBracket', isFinished);
                const silverHtml = renderBracket('S√©rie Prata ü•à', activeChampionship.silverBracket, 'silverBracket', isFinished);

                // L√≥gica do Coveiro
                let coveiroHtml = '';
                if (activeChampionship.groups && activeChampionship.groups.length > 0) {
                    const stats = getGlobalTournamentStats(activeChampionship);

                    if (stats.length > 0) {
                        const minGames = stats[0].gamesWon;
                        const coveiros = stats.filter(p => p.gamesWon === minGames); // Pega todos que empataram em √∫ltimo
                        const coveiroNames = coveiros.map(c => c.name).join(' / ');

                        coveiroHtml = `
                        <div class="bg-white text-gray-800 p-6 rounded-lg shadow-xl mt-8 text-center animate-fade-in border border-gray-200">
                            <h4 class="text-2xl font-black uppercase tracking-wider text-rose-600">üëª Pr√™mio Coveiro</h4>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${coveiroNames}</p>
                            <p class="text-sm text-gray-500">Com apenas ${minGames} games marcados no torneio.</p>
                        </div>
                        `;
                    }
                }
                return `<div class="animate-fade-in">${goldHtml}${silverHtml}${coveiroHtml}</div>`;
            };

            // =================================================================
            // === MODIFICADA (BYE): Atualizada para t√≠tulos din√¢micos ===
            // =================================================================
            const renderBracket = (title, bracket, bracketType, isFinished) => {
                const rounds = {};
                if (!bracket || bracket.length === 0) {
                     return `<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8 border border-gray-200">
                         <h3 class="text-3xl font-bold mb-6 text-cyan-600 flex items-center gap-3">
                             ${title}
                         </h3>
                         <p class="text-gray-500">Chave ainda n√£o gerada.</p>
                      </div>`;
                }

                bracket.forEach(match => {
                    if (!rounds[match.round]) rounds[match.round] = [];
                    rounds[match.round].push(match);
                });

                // Encontra a rodada mais alta (a Final)
                const maxRound = Math.max(...bracket.map(m => m.round));
                const final = bracket.find(m => m.round === maxRound);
                const champion = final?.winner; 

                const isGold = bracketType === 'goldBracket';
                // Fundo do Card de Campe√£o
                const cardStyle = isGold 
                    ? 'bg-gradient-to-r from-yellow-300 via-orange-400 to-orange-500 text-white' // Gold/Orange Style
                    : 'bg-gradient-to-r from-gray-300 via-gray-400 to-gray-500 text-gray-900'; // Silver Style

                // Destaque do Nome do Campe√£o
                const championNameStyle = isGold ? 'text-4xl font-extrabold text-white' : 'text-4xl font-extrabold text-gray-800';

                const championHtml = champion ? `
                <div class="${cardStyle} p-6 rounded-lg shadow-2xl mb-8 text-center animate-fade-in">
                    <h4 class="text-xl font-black uppercase tracking-wider ${isGold ? 'text-white' : 'text-gray-800'}">Campe√µes</h4>
                    <p class="${championNameStyle}">${champion.name}</p>
                </div>
                ` : '';

                const roundsHtml = Object.keys(rounds).sort((a,b) => a-b).map(roundNum => {
                    const round = Number(roundNum);
                    
                    // L√≥gica de T√≠tulos Din√¢micos
                    let roundTitle = `Rodada ${round}`;
                    if (round === 0) roundTitle = 'Preliminar';
                    else if (round === maxRound) roundTitle = 'Final';
                    else if (round === maxRound - 1) roundTitle = 'Semi-Final';
                    else if (round === maxRound - 2) roundTitle = 'Quartas de Final';
                    else if (round === maxRound - 3) roundTitle = 'Oitavas de Final';

                    const matchesHtml = rounds[roundNum].map(match => {
                        const pair1 = match.pairs[0]; 
                        const pair2 = match.pairs[1]; 
                        const isPair1Winner = match.winner && pair1 && match.winner.id === pair1.id;
                        const isPair2Winner = match.winner && pair2 && match.winner.id === pair2.id;
                        const score1 = match.score[0];
                        const score2 = match.score[1];
                        const hasScore = score1 !== null && score2 !== null;

                        // NOVO: Verifica se √© um Bye
                        const isBye = match.isBye === true;

                        // NOVO: Desabilita inputs se N√ÉO for admin
                        const isDisabled = !appState.isAdmin ? 'disabled' : '';
                        const adminButtonsClass = appState.isAdmin ? '' : 'hidden';

                        // NOVO: Bot√£o de Edi√ß√£o (‚úèÔ∏è)
                        const showEditButton = (hasScore || isFinished) && !isBye;
                        const showConfirmButton = !showEditButton && pair1 && pair2 && !isBye; // S√≥ mostra check se tiver 2 duplas e n√£o for Bye

                        // NOVO: L√≥gica de exibi√ß√£o do nome (para Byes)
                        let pair1Name = 'Aguardando...';
                        if (pair1) pair1Name = pair1.name;
                        
                        let pair2Name = 'Aguardando...';
                        if (pair2) pair2Name = pair2.name;
                        
                        // Se for um Bye, a dupla 2 √© "Bye" e a 1 avan√ßa
                        if (isBye) {
                             pair2Name = '(Bye)';
                             // Se o vencedor j√° foi populado (deveria ser autom√°tico), marca como vencedor
                             if (match.winner) pair1Name = `<span class="text-emerald-600 font-bold">${pair1.name}</span>`;
                        }

                        return `
                        <div class="bg-amber-50 rounded-lg shadow-sm border border-amber-200 p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-sm ${isPair1Winner ? 'text-emerald-600 font-bold' : 'text-gray-800'}">
                                    ${pair1Name}
                                </span>
                                <input
                                    type="number"
                                    min="0"
                                    value="${score1 === null ? '' : score1}"
                                    id="k-${match.id}-s0"
                                    class="w-16 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${isDisabled || isBye ? 'opacity-70' : ''}"
                                    ${isDisabled || isBye ? 'disabled' : ''}
                                />
                            </div>
                            
                            <div class="flex items-center my-2">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="mx-2 text-xs text-gray-500">vs</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="font-medium text-sm ${isPair2Winner ? 'text-emerald-600 font-bold' : 'text-gray-800'}">
                                    ${pair2Name}
                                </span>
                                <input
                                    type="number"
                                    min="0"
                                    value="${score2 === null ? '' : score2}"
                                    id="k-${match.id}-s1"
                                    class="w-16 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 ${isDisabled || isBye ? 'opacity-70' : ''}"
                                    ${isDisabled || isBye ? 'disabled' : ''}
                                />
                            </div>
                            
                            <div class="text-center mt-3 ${adminButtonsClass}">
                                <button 
                                    class="confirm-knockout-score-btn p-2 w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-md transition-all ${showConfirmButton ? '' : 'hidden'}"
                                    data-bracket-type="${bracketType}"
                                    data-match-id="${match.id}"
                                    title="Confirmar Placar">
                                    ${icons.check}
                                </button>
                                
                                <button 
                                    class="edit-knockout-score-btn p-2 w-full bg-orange-500 hover:bg-orange-600 text-white rounded-lg shadow-md transition-all ${showEditButton ? '' : 'hidden'}"
                                    data-bracket-type="${bracketType}"
                                    data-match-id="${match.id}"
                                    title="Editar Placar">
                                    ${icons.edit}
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('');

                    return `
                    <div class="flex flex-col space-y-6 flex-shrink-0 w-72 sm:w-80">
                        <h4 class="text-xl font-semibold text-gray-800">${roundTitle}</h4>
                        ${matchesHtml}
                    </div>
                    `;
                }).join('');

                return `
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8 border border-gray-200">
                    <h3 class="text-3xl font-bold mb-6 text-cyan-600">
                        ${title}
                    </h3>
                    ${championHtml}
                    <div class="flex gap-4 sm:gap-6 pb-4 overflow-x-auto">
                        ${roundsHtml}
                    </div>
                </div>
                `;
            };

            /* =============================================================================
               TELA 4: Vis√£o do Tel√£o (READ-ONLY)
               ============================================================================= */

            // Fun√ß√£o "Router" da tela do TEL√ÉO (READ-ONLY)
            const renderTelaoView = () => {
                 if (!activeChampionship) {
                    mainContent.innerHTML = `
                    <div class="text-center py-20 animate-fade-in">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-600 mx-auto"></div>
                        <p class="mt-4 text-gray-500">Aguardando dados do torneio...</p>
                    </div>
                    `;
                    return;
                }

                const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
                const champName = champInfo ? champInfo.name : "Campeonato";

                // T√≠tulo do Tel√£o
                let html = `<h1 class="text-4xl sm:text-6xl font-bold text-center text-cyan-600 my-8 animate-fade-in">üèñÔ∏è ${champName} üéæ</h1>`;

                // Define o conte√∫do baseado no status
                let contentHtml = '';
                if (champInfo?.status === 'finished') {
                    contentHtml = renderGroupStage_ReadOnly() + renderKnockoutView_ReadOnly(true);
                } else if (activeChampionship.status === 'knockout') {
                    contentHtml = renderGroupStage_ReadOnly() + renderKnockoutView_ReadOnly(false);
                } else if (activeChampionship.status === 'groups') {
                    contentHtml = renderGroupStage_ReadOnly();
                } else { // 'registration'
                    contentHtml = renderPlayerRegistration_ReadOnly();
                }

                if (activeChampionship.status !== 'registration') {
                    html += `
                    <div class="flex flex-wrap justify-center gap-6 animate-fade-in">
                        ${contentHtml}
                    </div>
                    `;
                } else {
                    html += contentHtml;
                }

                mainContent.innerHTML = html;

                // Ajuste do fundo para o modo tel√£o (definido no body global)
                if (appState.isTelaoMode) {
                     document.body.style.backgroundColor = '#FFFAF0'; // bg-amber-50
                }
            };

            // (TEL√ÉO) -- Sub-tela: Registro de Jogadores (Read-Only) --
            const renderPlayerRegistration_ReadOnly = () => {
                const playerCount = activeChampionship.players.length;

                const playersListHtml = playerCount === 0
                    ? `<p class="text-gray-500 text-center py-4 text-2xl">Aguardando inscri√ß√£o dos jogadores...</p>`
                    : activeChampionship.players.map(player => `
                        <div class="bg-white p-4 rounded-lg animate-fade-in-sm border border-gray-200 shadow-sm">
                            <span class="text-gray-800 font-medium text-2xl">${player.name}</span>
                        </div>
                    `).join('');

                return `
                    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-12 animate-fade-in max-w-4xl mx-auto border border-gray-200">
                        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200">
                            <h3 class="text-3xl sm:text-4xl font-semibold mb-6 text-cyan-600 flex items-center gap-3">
                                ${icons.users}
                                Jogadores Inscritos (${playerCount})
                            </h3>
                            <div class="max-h-[70vh] overflow-y-auto pr-2 space-y-3">
                                ${playersListHtml}
                            </div>
                        </div>
                    </div>
                `;
            };

            // (TEL√ÉO) -- Sub-tela: Fase de Grupos (Read-Only) --
            const renderGroupStage_ReadOnly = () => {
                const groupsHtml = activeChampionship.groups.map((group, groupIndex) => {
                    const rankings = getRankings(group);

                    const matchesHtml = group.matches.map((match, matchIndex) => {
                        const score1 = match.score[0];
                        const score2 = match.score[1];

                        return `
                        <div class="bg-amber-100 p-3 sm:p-4 rounded-lg border border-amber-200">
                            <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
                                <span class="text-base text-gray-700 text-center sm:text-left">${match.names[0]}</span>
                                <span class="font-bold text-cyan-600">vs</span>
                                <span class="text-base text-gray-700 text-center sm:text-right">${match.names[1]}</span>
                            </div>
                            <div class="flex justify-center items-center gap-3 mt-3">
                                <span class="w-20 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-2xl font-bold opacity-70">
                                    ${score1 === null ? '-' : score1}
                                </span>
                                <span class="text-gray-500 text-xl">-</span>
                                 <span class="w-20 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-2xl font-bold opacity-70">
                                    ${score2 === null ? '-' : score2}
                                </span>
                            </div>
                        </div>
                        `;
                    }).join('');

                    const rankingsHtml = rankings.map((player, rankIndex) => `
                        <tr class="border-b border-gray-200 ${rankIndex < 2 ? 'text-emerald-600' : 'text-orange-600'}">
                            <td class="p-3 font-bold text-lg">${rankIndex + 1}¬∫</td>
                            <td class="p-3 text-lg text-gray-800">${player.name}</td>
                            <td class="p-3 font-bold text-lg">${player.gamesWon}</td>
                        </tr>
                    `).join('');

                    return `
                    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 animate-fade-in w-full sm:max-w-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-5">
                            <h3 class="text-3xl font-bold text-cyan-600">Grupo ${groupIndex + 1}</h3>
                        </div>
                        <div class="space-y-4 mb-6">${matchesHtml}</div>
                        <div>
                            <h4 class="text-xl font-semibold mb-3 text-gray-800">Ranking do Grupo</h4>
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-amber-100">
                                        <th class="p-3 rounded-l-lg text-base text-gray-600">Pos.</th>
                                        <th class="p-3 text-base text-gray-600">Jogador</th>
                                        <th class="p-3 rounded-r-lg text-base text-gray-600">Games Vencidos</th>
                                    </tr>
                                </thead>
                                <tbody>${rankingsHtml}</tbody>
                            </table>
                            <div class="flex justify-between mt-2 text-base">
                                <span class="text-emerald-600">‚ñ≤ Dupla Ouro ü•á</span>
                                <span class="text-orange-600">‚ñº Dupla Prata ü•à</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                return groupsHtml; // Retorna a string de cards diretamente
            };

            // (TEL√ÉO) -- Sub-tela: Chaves (Mata-Mata) (Read-Only) --
            const renderKnockoutView_ReadOnly = (isFinished) => {
                // Chamadas de renderBracket_ReadOnly sem o √≠cone nos par√¢metros (apenas o t√≠tulo)
                const goldHtml = renderBracket_ReadOnly('S√©rie Ouro ü•á', activeChampionship.goldBracket, 'goldBracket', isFinished);
                const silverHtml = renderBracket_ReadOnly('S√©rie Prata ü•à', activeChampionship.silverBracket, 'silverBracket', isFinished);

                let coveiroHtml = '';
                if (activeChampionship.groups && activeChampionship.groups.length > 0) {
                    const stats = getGlobalTournamentStats(activeChampionship);

                    if (stats.length > 0) {
                        const minGames = stats[0].gamesWon;
                        const coveiros = stats.filter(p => p.gamesWon === minGames);
                        const coveiroNames = coveiros.map(c => c.name).join(' / ');

                        coveiroHtml = `
                        <div class="bg-white text-gray-800 p-6 rounded-lg shadow-xl text-center animate-fade-in w-full sm:max-w-sm border border-gray-200">
                            <h4 class="text-2xl font-black uppercase tracking-wider text-rose-600">üëª Pr√™mio Coveiro</h4>
                            <p class="text-4xl font-extrabold text-gray-900 mt-2">${coveiroNames}</p>
                            <p class="text-sm text-gray-500">Com apenas ${minGames} games marcados no torneio.</p>
                        </div>
                        `;
                    }
                }

                return goldHtml + silverHtml + coveiroHtml; // Retorna a string de cards diretamente
            };

            // =================================================================
            // === MODIFICADA (BYE): Atualizada para t√≠tulos din√¢micos ===
            // =================================================================
            const renderBracket_ReadOnly = (title, bracket, bracketType, isFinished) => {
                const rounds = {};
                if (!bracket || bracket.length === 0) {
                     return `<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8 w-full sm:max-w-sm border border-gray-200">
                         <h3 class="text-3xl font-bold mb-6 text-cyan-600">
                             ${title}
                         </h3>
                         <p class="text-gray-500">Chave ainda n√£o gerada.</p>
                      </div>`;
                }

                bracket.forEach(match => {
                    if (!rounds[match.round]) rounds[match.round] = [];
                    rounds[match.round].push(match);
                });

                const maxRound = Math.max(...bracket.map(m => m.round));
                const final = bracket.find(m => m.round === maxRound);
                const champion = final?.winner; 

                const isGold = bracketType === 'goldBracket';
                // Fundo do Card de Campe√£o
                const cardStyle = isGold 
                    ? 'bg-gradient-to-r from-yellow-300 via-orange-400 to-orange-500 text-white' // Gold/Orange Style
                    : 'bg-gradient-to-r from-gray-300 via-gray-400 to-gray-500 text-gray-900'; // Silver Style

                // Destaque do Nome do Campe√£o
                const championNameStyle = isGold ? 'text-4xl font-extrabold text-white' : 'text-4xl font-extrabold text-gray-800';

                const championHtml = champion ? `
                <div class="${cardStyle} p-6 rounded-lg shadow-2xl mb-8 text-center animate-fade-in">
                    <h4 class="text-xl font-black uppercase tracking-wider ${isGold ? 'text-white' : 'text-gray-800'}">Campe√µes</h4>
                    <p class="${championNameStyle}">${champion.name}</p>
                </div>
                ` : '';

                const roundsHtml = Object.keys(rounds).sort((a,b) => a-b).map(roundNum => {
                    const round = Number(roundNum);
                    
                    // L√≥gica de T√≠tulos Din√¢micos
                    let roundTitle = `Rodada ${round}`;
                    if (round === 0) roundTitle = 'Preliminar';
                    else if (round === maxRound) roundTitle = 'Final';
                    else if (round === maxRound - 1) roundTitle = 'Semi-Final';
                    else if (round === maxRound - 2) roundTitle = 'Quartas de Final';
                    else if (round === maxRound - 3) roundTitle = 'Oitavas de Final';


                    const matchesHtml = rounds[roundNum].map(match => {
                        const pair1 = match.pairs[0]; 
                        const pair2 = match.pairs[1]; 
                        const isPair1Winner = match.winner && pair1 && match.winner.id === pair1.id;
                        const isPair2Winner = match.winner && pair2 && match.winner.id === pair2.id;
                        const score1 = match.score[0];
                        const score2 = match.score[1];
                        
                        // NOVO: Verifica se √© um Bye
                        const isBye = match.isBye === true;

                        const winnerClass1 = isPair1Winner ? 'text-emerald-600 font-bold' : 'text-gray-800';
                        const winnerClass2 = isPair2Winner ? 'text-emerald-600 font-bold' : 'text-gray-800';
                        
                        // NOVO: L√≥gica de exibi√ß√£o do nome (para Byes)
                        let pair1Name = 'Aguardando...';
                        if (pair1) pair1Name = pair1.name;
                        
                        let pair2Name = 'Aguardando...';
                        if (pair2) pair2Name = pair2.name;
                        
                        if (isBye) {
                             pair2Name = '(Bye)';
                             if (match.winner) pair1Name = `<span class="text-emerald-600 font-bold">${pair1.name}</span>`;
                        }

                        return `
                        <div class="bg-amber-100 rounded-lg shadow-sm border border-amber-200 p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-lg ${winnerClass1}">
                                    ${pair1Name}
                                </span>
                                <span class="w-16 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-xl font-bold opacity-70">
                                    ${score1 === null ? '-' : score1}
                                </span>
                            </div>
                            
                            <div class="flex items-center my-2">
                                <div class="flex-grow border-t border-gray-300"></div>
                                <span class="mx-2 text-sm text-gray-500">vs</span>
                                <div class="flex-grow border-t border-gray-300"></div>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="font-medium text-lg ${winnerClass2}">
                                    ${pair2Name}
                                </span>
                                <span class="w-16 bg-white border border-gray-300 text-gray-800 rounded-lg p-2 text-center text-xl font-bold opacity-70">
                                    ${score2 === null ? '-' : score2}
                                </span>
                            </div>
                        </div>
                        `;
                    }).join('');

                    return `
                    <div class="flex flex-col space-y-6 w-full max-w-xs">
                        <h4 class="text-xl font-semibold text-gray-800">${roundTitle}</h4>
                        ${matchesHtml}
                    </div>
                    `;
                }).join('');

                return `
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-8 w-full sm:max-w-sm border border-gray-200">
                    <h3 class="text-3xl font-bold mb-6 text-cyan-600">
                        ${title}
                    </h3>
                    ${championHtml}
                    <div class="flex flex-wrap justify-center gap-4 sm:gap-6 pb-4">
                        ${roundsHtml}
                    </div>
                </div>
                `;
            };


            /* =============================================================================
               L√≥gica do Campeonato Ativo (A√ß√µes de Admin)
               ============================================================================= */

            // (ADMIN) -- Abrir o Tel√£o
            const handleLaunchTelao = () => {
                const champId = appState.currentChampionshipId;
                if (!champId) {
                    showModal("Erro", "ID do campeonato n√£o encontrado.");
                    return;
                }

                // Constr√≥i a URL para o modo tel√£o
                const url = `${window.location.origin}${window.location.pathname}?telao=true&champId=${champId}`;

                // Abre em uma nova aba
                window.open(url, '_blank');
            };

            const handleAddNewPlayerToChampionship = async (e) => {
                e.preventDefault();
                const input = document.getElementById('new-player-name-input');
                const button = document.getElementById('add-new-player-btn');
                const playerName = input.value.trim();
                if (!playerName) return;

                // 1. VERIFICA DUPLICIDADE NO RANKING (OPCIONAL, J√Å FEITO)
                const existingPlayerInRanking = globalPlayers.find(p => p.name.toLowerCase() === playerName.toLowerCase());
                if (existingPlayerInRanking) {
                    showModal("Jogador J√° Existe", `Um jogador chamado "${playerName}" j√° existe no ranking. Use o menu "Adicionar do Ranking" para adicion√°-lo.`);
                    return;
                }

                // 2. VERIFICA DUPLICIDADE NO TORNEIO ATUAL (NOVO REQUISITO)
                const alreadyInTournament = activeChampionship.players.some(
                    p => p.name.toLowerCase() === playerName.toLowerCase()
                );
                if (alreadyInTournament) {
                    showModal("Duplicidade Detectada", `O jogador "${playerName}" j√° est√° inscrito neste torneio.`);
                    return;
                }

                button.disabled = true;

                const newPlayer = {
                    id: crypto.randomUUID(), // Novo ID, pois √© um novo jogador
                    name: playerName
                };

                const newChampData = {
                    ...activeChampionship,
                    players: [...activeChampionship.players, newPlayer]
                };

                await saveActiveChampionship(newChampData);

                input.value = '';
                button.disabled = false;
            };

            const handleAddExistingPlayerToChampionship = async (e) => {
                e.preventDefault();
                const select = document.getElementById('existing-player-select');
                const button = document.getElementById('add-existing-player-btn');
                const playerId = select.value;

                if (!playerId) {
                    showModal("Erro", "Nenhum jogador selecionado.");
                    return;
                }

                const player = globalPlayers.find(p => p.id === playerId);
                if (!player) {
                    showModal("Erro", "Jogador n√£o encontrado. Tente atualizar a p√°gina.");
                    return;
                }

                // NOVO REQUISITO: Verifica se o ID j√° est√° no torneio
                const alreadyInTournament = activeChampionship.players.some(
                    p => p.id === playerId
                );
                if (alreadyInTournament) {
                    showModal("Duplicidade Detectada", `O jogador "${player.name}" j√° est√° inscrito neste torneio.`);
                    return;
                }


                button.disabled = true;

                const newChampData = {
                    ...activeChampionship,
                    players: [...activeChampionship.players, { id: player.id, name: player.name }]
                };

                await saveActiveChampionship(newChampData);

                button.disabled = false;
            };

            const handleDeletePlayerFromChampionship = async (playerId) => {
                if (!confirm("Tem certeza que deseja remover este jogador DO TORNEIO?")) return;

                const newChampData = {
                    ...activeChampionship,
                    players: activeChampionship.players.filter(p => p.id !== playerId)
                };
                await saveActiveChampionship(newChampData);
            };

            // ==========================================================
            // === FUN√á√ÉO ATUALIZADA (BYE): Remove trava de pot√™ncia de 2
            // ==========================================================
            const handleGenerateChampionship = async () => {
                const playerCount = activeChampionship.players.length;
                const isMultypleOfFour = playerCount % 4 === 0;

                if (playerCount < 4 || !isMultypleOfFour) {
                    showModal("N√∫mero de Jogadores Inv√°lido", `O campeonato requer um n√∫mero de jogadores m√∫ltiplo de 4 para grupos de 4 (ex: 4, 8, 12...). Voc√™ tem ${playerCount}.`);
                    return;
                }
                
                const numGroups = playerCount / 4;
                // const numDuplas = numGroups * 2; // (jogadores/4 grupos) * 2 duplas por grupo
                
                // ==========================================================
                // === REMOVIDO (BYE): Esta trava n√£o √© mais necess√°ria ===
                // ==========================================================
                // if (![2, 4, 8, 16, 32].includes(numDuplas)) {
                //      showModal("Regra da Chave", `A regra atual de mata-mata s√≥ suporta 2, 4, 8, 16 ou 32 duplas. Com ${playerCount} jogadores, voc√™ ter√° ${numDuplas} duplas. Por favor, ajuste o n√∫mero de jogadores (ex: 8 ou 16 jogadores).`);
                //      return;
                // }

                // === NOVA L√ìGICA DE CABE√áA DE CHAVE ===
                if (!confirm(`Iniciar grupos com ${playerCount} jogadores? Os ${numGroups} melhores do ranking ser√£o os "Cabe√ßas de Chave" e o restante ser√° sorteado.`)) {
                    return;
                }

                try {
                    // 1. Mapear pontos do ranking global aos jogadores do torneio
                    const globalPlayersMap = new Map(globalPlayers.map(p => [p.id, p.points || 0]));

                    const tournamentPlayersWithPoints = activeChampionship.players.map(p => ({
                        ...p, // id, name
                        points: globalPlayersMap.get(p.id) || 0 // Pega pontos do ranking, 0 se for jogador novo
                    }));
                  // 2. Ordena os jogadores por pontos (desc)
                    .sort((a, b) => b.points - a.points);

                // 3. Separa os "Cabe√ßas de Chave" (N melhores, onde N = numGroups)
                const seededPlayers = tournamentPlayersWithPoints.slice(0, numGroups);
                const otherPlayers = tournamentPlayersWithPoints.slice(numGroups);

                // 4. Embaralha o resto
                const shuffledOtherPlayers = shuffleArray(otherPlayers);

                // 5. Monta os grupos
                const newGroups = [];
                for (let i = 0; i < numGroups; i++) {
                    const groupPlayers = [];
                    
                    // Adiciona 1 cabe√ßa de chave
                    groupPlayers.push(seededPlayers[i]);
                    
                    // Adiciona 3 jogadores embaralhados
                    // (Ex: Grupo 0 pega [0, 1, 2], Grupo 1 pega [3, 4, 5], etc.)
                    for (let j = 0; j < 3; j++) {
                        groupPlayers.push(shuffledOtherPlayers[i * 3 + j]);
                    }

                    // 6. Cria as partidas para o grupo (Round Robin)
                    const groupMatches = [];
                    for (let p1 = 0; p1 < groupPlayers.length; p1++) {
                        for (let p2 = p1 + 1; p2 < groupPlayers.length; p2++) {
                            groupMatches.push({
                                names: [`[${groupPlayers[p1].name}]`, `[${groupPlayers[p2].name}]`], // Nome da "Dupla" (s√≥ 1)
                                pairs: [
                                    { id: groupPlayers[p1].id, name: groupPlayers[p1].name },
                                    { id: groupPlayers[p2].id, name: groupPlayers[p2].name }
                                ],
                                score: [null, null],
                                winner: null,
                                // Otimiza√ß√£o: N√£o precisamos de nextMatchId para grupos
                            });
                        }
                    }

                    newGroups.push({
                        players: groupPlayers.map(p => ({ id: p.id, name: p.name })), // Salva s√≥ ID e Nome
                        matches: groupMatches
                    });
                } // Fim do loop de cria√ß√£o de grupos

                const newChampData = {
                    ...activeChampionship,
                    groups: newGroups,
                    status: 'groups' // Atualiza o status
                };

                await saveActiveChampionship(newChampData);
            } catch (error) {
                console.error("Erro ao gerar grupos (pode ser o listener de 'globalPlayers'):", error);
                showModal("Erro", "N√£o foi poss√≠vel buscar os pontos do ranking para gerar os grupos. Verifique se o ranking selecionado tem jogadores. (Erro: " + error.message + ")");
            }
        };

        const handleConfirmGroupScore = async (groupIndex, matchIndex) => {
            const idS1 = `g-${groupIndex}-m-${matchIndex}-s0`;
            const idS2 = `g-${groupIndex}-m-${matchIndex}-s1`;
            const score1 = parseInt(document.getElementById(idS1).value);
            const score2 = parseInt(document.getElementById(idS2).value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showModal("Placar Inv√°lido", "Por favor, insira valores num√©ricos v√°lidos (0 ou mais) para o placar.");
                return;
            }

            if (score1 === score2) {
                showModal("Placar Inv√°lido", "O placar n√£o pode ser um empate.");
                return;
            }

            // Confirma√ß√£o para placar "estranho" (ex: 7-6)
            if (score1 > 6 || score2 > 6) {
                if (!confirm(`O placar ${score1} a ${score2} parece incomum. Deseja confirmar mesmo assim?`)) {
                    return;
                }
            }

            const newChampData = { ...activeChampionship };
            const match = newChampData.groups[groupIndex].matches[matchIndex];
            match.score = [score1, score2];
            match.winner = score1 > score2 ? match.pairs[0] : match.pairs[1];

            await saveActiveChampionship(newChampData);
        };

        // =================================================================
        // === NOVA FUN√á√ÉO: Para editar placar de GRUPO j√° confirmado
        // =================================================================
        const handleEditGroupScore = async (groupIndex, matchIndex) => {
             const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
             if (champInfo?.status === 'finished') {
                if (!confirm("PERIGO: Este campeonato est√° FINALIZADO. Alterar este placar N√ÉO ir√° recalcular o mata-mata ou os pontos de ranking. Deseja continuar e alterar o placar (apenas visualmente)?")) {
                    return;
                }
             } else if (activeChampionship.status === 'knockout') {
                if (!confirm("PERIGO: O mata-mata J√Å FOI GERADO. Alterar este placar N√ÉO ir√° alterar as chaves. Deseja continuar e alterar o placar (apenas visualmente)?")) {
                    return;
                }
             }

            const idS1 = `g-${groupIndex}-m-${matchIndex}-s0`;
            const idS2 = `g-${groupIndex}-m-${matchIndex}-s1`;
            const score1 = parseInt(document.getElementById(idS1).value);
            const score2 = parseInt(document.getElementById(idS2).value);

            // Re-valida
            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showModal("Placar Inv√°lido", "Por favor, insira valores num√©ricos v√°lidos (0 ou mais) para o placar.");
                return;
            }
             if (score1 === score2) {
                showModal("Placar Inv√°lido", "O placar n√£o pode ser um empate.");
                return;
            }

            const newChampData = { ...activeChampionship };
            const match = newChampData.groups[groupIndex].matches[matchIndex];
            match.score = [score1, score2];
            match.winner = score1 > score2 ? match.pairs[0] : match.pairs[1];

            await saveActiveChampionship(newChampData);
            // O listener ir√° re-renderizar
        };

        // =================================================================
        // === FUN√á√ÉO REESCRITA (BYE): Gera chaves com ranking e Byes
        // =================================================================
        const handleFinalizeGroups = async () => {
            // 1. Verifica se todos os placares est√£o preenchidos
            let allScoresFilled = true;
            activeChampionship.groups.forEach(group => {
                group.matches.forEach(match => {
                    if (match.score[0] === null || match.score[1] === null) {
                        allScoresFilled = false;
                    }
                });
            });

            if (!allScoresFilled) {
                showModal("Grupos Incompletos", "Ainda existem placares n√£o preenchidos. Verifique todos os grupos.");
                return;
            }
            
            if (!confirm("Tem certeza que deseja finalizar a fase de grupos e gerar o mata-mata? Esta a√ß√£o n√£o pode ser desfeita e ir√° travar os placares dos grupos.")) {
                return;
            }

            // 2. Rankeia as duplas Ouro e Prata
            const rankedGoldPairs = [];
            const rankedSilverPairs = [];

            activeChampionship.groups.forEach(group => {
                const r = getRankings(group); // Retorna os 4 jogadores ordenados

                // 3. Cria a Dupla Ouro (1¬∫ e 2¬∫)
                const goldPair = {
                    id: crypto.randomUUID(),
                    name: `${r[0].name} / ${r[1].name}`,
                    playerIds: [r[0].id, r[1].id], // Armazena IDs para o Coveiro
                    totalGames: r[0].gamesWon + r[1].gamesWon
                };
                rankedGoldPairs.push(goldPair);

                // 4. Cria a Dupla Prata (3¬∫ e 4¬∫)
                const silverPair = {
                    id: crypto.randomUUID(),
                    name: `${r[2].name} / ${r[3].name}`,
                    playerIds: [r[2].id, r[3].id], // Armazena IDs para o Coveiro
                    totalGames: r[2].gamesWon + r[3].gamesWon
                };
                rankedSilverPairs.push(silverPair);
            });

            // 5. Ordena as duplas (maior 'totalGames' fica em primeiro)
            // O 'sort' √© (a, b) => b - a (descendente). O #1 √© o que tem mais games.
            rankedGoldPairs.sort((a, b) => b.totalGames - a.totalGames);
            rankedSilverPairs.sort((a, b) => b.totalGames - a.totalGames);
            
            // 6. Cria os Brackets
            const goldBracket = createBracket(rankedGoldPairs);
            const silverBracket = createBracket(rankedSilverPairs);

            // 7. Salva no Firebase
            const newChampData = {
                ...activeChampionship,
                status: 'knockout',
                goldBracket: goldBracket,
                silverBracket: silverBracket
            };

            await saveActiveChampionship(newChampData);
        };

        // =================================================================
        // === NOVA FUN√á√ÉO (HELPER): Encontra a pr√≥xima pot√™ncia de 2
        // =================================================================
        const getNextPowerOfTwo = (n) => {
            if (n <= 0) return 1;
            let power = 2;
            while (power < n) {
                power *= 2;
            }
            return power;
        };

        // =================================================================
        // === FUN√á√ÉO REESCRITA (BYE): L√≥gica de cria√ß√£o da chave
        // =================================================================
        const createBracket = (rankedPairs) => {
            const numPairs = rankedPairs.length;
            if (numPairs < 2) return []; // N√£o pode criar chave com menos de 2

            // 1. Calcula o tamanho da chave e os Byes
            const bracketSize = getNextPowerOfTwo(numPairs); // Ex: 5 pares -> 8 slots
            const numByes = bracketSize - numPairs;           // Ex: 8 - 5 = 3 Byes
            const numPrelimMatches = numPairs - numByes;     // Ex: 5 - 3 = 2 pares (1 jogo)

            const bracket = [];
            
            // 2. Separa as duplas
            // Os "Byes" s√£o os de melhor ranking
            const byePairs = rankedPairs.slice(0, numByes); // Ex: #1, #2, #3
            // Os "Prelim" s√£o os de pior ranking
            const prelimPairs = rankedPairs.slice(numByes); // Ex: #4, #5

            // 3. Cria os slots da Rodada 1 (a rodada principal, ex: Quartas de Final)
            // Esta lista ter√° os "Byes" e placeholders para os vencedores da preliminar
            const round1Slots = [];
            
            // Adiciona os Byes primeiro (eles s√£o os seeds altos)
            byePairs.forEach(pair => round1Slots.push(pair));

            // 4. Cria os jogos da Rodada 0 (Preliminar)
            let prelimMatchIndex = 0;
            // Pareia o melhor com o pior (ex: #4 vs #5)
            let i = 0;
            let j = prelimPairs.length - 1;

            while (i < j) {
                const pair1 = prelimPairs[i];
                const pair2 = prelimPairs[j];
                const matchId = `r0-m${prelimMatchIndex}`;
                
                const prelimMatch = {
                    id: matchId,
                    round: 0,
                    pairs: [pair1, pair2], // Ex: [#4, #5]
                    score: [null, null],
                    winner: null,
                    nextMatchId: null, // Ser√° preenchido na Etapa 5
                    nextMatchSlot: null, // Ser√° preenchido na Etapa 5
                    isBye: false
                };
                bracket.push(prelimMatch);
                
                // Adiciona um placeholder para o vencedor na Rodada 1
                round1Slots.push({ winnerOf: matchId });
                
                i++;
                j--;
                prelimMatchIndex++;
            }
            
            // 5. Cria a √°rvore de jogos principal (Rodadas 1, 2, ...)
            // 'currentRoundSlots' tem os classificados (Byes + Vencedores da Prelim)
            // Ex: [Pair1, Pair2, Pair3, {winnerOf: 'r0-m0'}] (4 slots = Quartas)
            let currentRoundSlots = round1Slots;
            let roundNum = 1;

            while (currentRoundSlots.length > 1) {
                const nextRoundSlots = [];
                const newMatches = [];
                
                // Implementa o seeding (ex: #1 vs #4, #2 vs #3)
                i = 0;
                j = currentRoundSlots.length - 1;

                while (i < j) {
                    const slot1 = currentRoundSlots[i]; // Ex: Pair1 (Seed #1)
                    const slot2 = currentRoundSlots[j]; // Ex: {winnerOf: 'r0-m0'} (Seed #4)

                    // Se o slot N√ÉO √© um placeholder, √© uma dupla
                    const pair1 = (slot1 && !slot1.winnerOf) ? slot1 : null;
                    const pair2 = (slot2 && !slot2.winnerOf) ? slot2 : null;
                    
                    const matchId = `r${roundNum}-m${i}`;
                    const match = {
                        id: matchId,
                        round: roundNum,
                        pairs: [pair1, pair2],
                        score: [null, null],
                        winner: null,
                        nextMatchId: null, // Ser√° preenchido na pr√≥xima itera√ß√£o
                        nextMatchSlot: null,
                        isBye: false
                    };

                    // Se for um Bye vs Bye (ex: 2 duplas -> final), detecta aqui
                    if (pair1 && pair2 && match.isBye) {
                        // (N√£o deve acontecer com a l√≥gica de preliminar, mas √© uma seguran√ßa)
                    }

                    newMatches.push(match);
                    
                    // Adiciona um placeholder para o vencedor na PR√ìXIMA rodada
                    nextRoundSlots.push({ winnerOf: matchId });

                    // 6. Linka os jogos anteriores (da preliminar ou rodada anterior)
                    if (slot1 && slot1.winnerOf) {
                        const sourceMatch = bracket.find(m => m.id === slot1.winnerOf);
                        if (sourceMatch) {
                            sourceMatch.nextMatchId = match.id;
                            sourceMatch.nextMatchSlot = 0;
                        }
                    }
                    if (slot2 && slot2.winnerOf) {
                        const sourceMatch = bracket.find(m => m.id === slot2.winnerOf);
                        if (sourceMatch) {
                            sourceMatch.nextMatchId = match.id;
                            sourceMatch.nextMatchSlot = 1;
                        }
                    }
                    
                    i++;
                    j--;
                }
                
                bracket.push(...newMatches);
                currentRoundSlots = nextRoundSlots;
                roundNum++;
            }

            return bracket;
        };
        
        // =================================================================
        // === FUN√á√ÉO MODIFICADA (BYE): Alimenta o vencedor na pr√≥xima rodada
        // =================================================================
        const handleConfirmKnockoutScore = async (bracketType, matchId) => {
            const newChampData = { ...activeChampionship };
            const bracket = newChampData[bracketType];
            const match = bracket.find(m => m.id === matchId);

            if (!match) {
                console.error("Match n√£o encontrado:", bracketType, matchId);
                return;
            }

            const idS1 = `k-${match.id}-s0`;
            const idS2 = `k-${match.id}-s1`;
            const score1 = parseInt(document.getElementById(idS1).value);
            const score2 = parseInt(document.getElementById(idS2).value);

            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0) {
                showModal("Placar Inv√°lido", "Por favor, insira valores num√©ricos v√°lidos (0 ou mais).");
                return;
            }

            if (score1 === score2) {
                showModal("Placar Inv√°lido", "O placar n√£o pode ser um empate.");
                return;
            }
            
            if (score1 > 6 || score2 > 6) {
                if (!confirm(`O placar ${score1} a ${score2} parece incomum. Deseja confirmar mesmo assim?`)) {
                    return;
                }
            }

            // Define o vencedor
            match.score = [score1, score2];
            match.winner = score1 > score2 ? match.pairs[0] : match.pairs[1];

            // Avan√ßa o vencedor para a pr√≥xima rodada
            if (match.nextMatchId !== null && match.nextMatchSlot !== null) {
                const nextMatch = bracket.find(m => m.id === match.nextMatchId);
                if (nextMatch) {
                    nextMatch.pairs[match.nextMatchSlot] = match.winner;
                }
            }

            // Verifica se este √© o √∫ltimo jogo
            const maxRound = Math.max(...bracket.map(m => m.round));
            if (match.round === maxRound) {
                // √â a final. Este √© o campe√£o.
                await checkAndFinalizeChampionship(newChampData);
            }

            await saveActiveChampionship(newChampData);
        };
        
        // =================================================================
        // === NOVA FUN√á√ÉO: Para editar placar de MATA-MATA j√° confirmado
        // =================================================================
        const handleEditKnockoutScore = async (bracketType, matchId) => {
             const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
             
             if (champInfo?.status === 'finished') {
                if (!confirm("PERIGO: Este campeonato est√° FINALIZADO. Alterar este placar √© EXTREMAMENTE ARRISCADO e pode quebrar a l√≥gica de pontua√ß√£o. A altera√ß√£o N√ÉO VAI recalcular o ranking ou o vencedor. Deseja continuar (apenas visualmente)?")) {
                    return;
                }
             }

            // 1. Encontra o jogo
            const newChampData = { ...activeChampionship };
            const bracket = newChampData[bracketType];
            const match = bracket.find(m => m.id === matchId);

            if (!match) return;

            // 2. Coleta o NOVO placar
            const idS1 = `k-${match.id}-s0`;
            const idS2 = `k-${match.id}-s1`;
            const score1 = parseInt(document.getElementById(idS1).value);
            const score2 = parseInt(document.getElementById(idS2).value);

            // Re-valida
            if (isNaN(score1) || isNaN(score2) || score1 < 0 || score2 < 0 || score1 === score2) {
                showModal("Placar Inv√°lido", "Placar inv√°lido. N√£o pode ser empate.");
                return;
            }

            // 3. Define o NOVO vencedor
            const oldWinnerId = match.winner ? match.winner.id : null;
            const newWinner = score1 > score2 ? match.pairs[0] : match.pairs[1];

            // 4. VERIFICA SE O VENCEDOR MUDOU
            if (oldWinnerId && oldWinnerId !== newWinner.id) {
                // O vencedor mudou. Isso √© um GRANDE problema.
                
                // Verifica se o jogo seguinte (para onde o vencedor antigo foi) j√° tem placar
                if (match.nextMatchId) {
                    const nextMatch = bracket.find(m => m.id === match.nextMatchId);
                    if (nextMatch && nextMatch.score[0] !== null) {
                        showModal("A√ß√£o Bloqueada", `N√£o √© poss√≠vel alterar o vencedor deste jogo (${match.pairs[0].name} vs ${match.pairs[1].name}) porque o vencedor anterior (${match.winner.name}) J√Å JOGOU a rodada seguinte (vs ${nextMatch.pairs[match.nextMatchSlot === 0 ? 1 : 0].name}).`);
                        // Restaura o placar antigo no input
                        document.getElementById(idS1).value = match.score[0];
                        document.getElementById(idS2).value = match.score[1];
                        return;
                    }
                }
                
                // Se o jogo seguinte n√£o foi jogado, permite a troca
                if (!confirm("AVISO: Voc√™ est√° MUDANDO o vencedor deste jogo. O vencedor antigo ser√° removido da pr√≥xima rodada e o novo vencedor ser√° colocado. Deseja continuar?")) {
                    // Restaura o placar antigo no input
                    document.getElementById(idS1).value = match.score[0];
                    document.getElementById(idS2).value = match.score[1];
                    return;
                }
                
                // Atualiza o vencedor na pr√≥xima rodada
                if (match.nextMatchId !== null) {
                    const nextMatch = bracket.find(m => m.id === match.nextMatchId);
                    if (nextMatch) {
                        nextMatch.pairs[match.nextMatchSlot] = newWinner;
                    }
                }
            }

            // 5. Salva o novo placar e vencedor
            match.score = [score1, score2];
            match.winner = newWinner;

            // 6. Verifica se este √© o √∫ltimo jogo
            const maxRound = Math.max(...bracket.map(m => m.round));
            if (match.round === maxRound) {
                // √â a final. Este √© o campe√£o.
                await checkAndFinalizeChampionship(newChampData);
            }

            await saveActiveChampionship(newChampData);
        };
        
        // (ADMIN) -- Verifica se o torneio acabou e finaliza
        const checkAndFinalizeChampionship = async (champData) => {
            const goldFinal = champData.goldBracket.find(m => m.round === Math.max(...champData.goldBracket.map(m => m.round)));
            const silverFinal = champData.silverBracket.find(m => m.round === Math.max(...champData.silverBracket.map(m => m.round)));

            if (goldFinal && goldFinal.winner && silverFinal && silverFinal.winner) {
                // O CAMPEONATO ACABOU!
                
                // Pega o ID do documento principal do campeonato
                const champId = appState.currentChampionshipId;
                const champRef = doc(db, 'users', appState.userId, 'championships', champId);
                
                // Pega os IDs do Ranking
                const champInfo = championships.find(c => c.id === champId);
                const rankingId = champInfo.rankingId;
                
                // Pega os pontos
                const pointsConfig = champInfo.pointsConfig || DEFAULT_RANKING_POINTS;

                // Calcula a diferen√ßa de pontos para aplicar no ranking
                const pointsDiff = {};

                // Campe√£o Ouro
                const gWinnerP1 = goldFinal.pairs[goldFinal.score[0] > goldFinal.score[1] ? 0 : 1].playerIds[0];
                const gWinnerP2 = goldFinal.pairs[goldFinal.score[0] > goldFinal.score[1] ? 0 : 1].playerIds[1];
                // Vice Ouro
                const gRunnerP1 = goldFinal.pairs[goldFinal.score[0] < goldFinal.score[1] ? 0 : 1].playerIds[0];
                const gRunnerP2 = goldFinal.pairs[goldFinal.score[0] < goldFinal.score[1] ? 0 : 1].playerIds[1];
                // Campe√£o Prata
                const sWinnerP1 = silverFinal.pairs[silverFinal.score[0] > silverFinal.score[1] ? 0 : 1].playerIds[0];
                const sWinnerP2 = silverFinal.pairs[silverFinal.score[0] > silverFinal.score[1] ? 0 : 1].playerIds[1];
                // Vice Prata
                const sRunnerP1 = silverFinal.pairs[silverFinal.score[0] < silverFinal.score[1] ? 0 : 1].playerIds[0];
                const sRunnerP2 = silverFinal.pairs[silverFinal.score[0] < silverFinal.score[1] ? 0 : 1].playerIds[1];
                
                // Calcula Coveiro
                const stats = getGlobalTournamentStats(champData); // Passa os dados locais
                const minGames = stats[0].gamesWon;
                const coveiros = stats.filter(p => p.gamesWon === minGames);
                
                // Inicializa o diff para todos os jogadores do torneio
                champData.players.forEach(p => {
                    pointsDiff[p.id] = {
                        points: pointsConfig.participation, // Todos ganham participa√ß√£o
                        goldWins: 0,
                        silverWins: 0,
                        coveiroWins: 0
                    };
                });
                
                // Adiciona pontos de Campe√£o Ouro
                pointsDiff[gWinnerP1].points += (pointsConfig.goldWinner - pointsConfig.participation);
                pointsDiff[gWinnerP2].points += (pointsConfig.goldWinner - pointsConfig.participation);
                pointsDiff[gWinnerP1].goldWins = 1;
                pointsDiff[gWinnerP2].goldWins = 1;
                
                // Adiciona pontos de Vice Ouro
                pointsDiff[gRunnerP1].points += (pointsConfig.goldRunnerUp - pointsConfig.participation);
                pointsDiff[gRunnerP2].points += (pointsConfig.goldRunnerUp - pointsConfig.participation);
                
                // Adiciona pontos de Campe√£o Prata
                pointsDiff[sWinnerP1].points += (pointsConfig.silverWinner - pointsConfig.participation);
                pointsDiff[sWinnerP2].points += (pointsConfig.silverWinner - pointsConfig.participation);
                pointsDiff[sWinnerP1].silverWins = 1;
                pointsDiff[sWinnerP2].silverWins = 1;

                // Adiciona pontos de Vice Prata
                pointsDiff[sRunnerP1].points += (pointsConfig.silverRunnerUp - pointsConfig.participation);
                pointsDiff[sRunnerP2].points += (pointsConfig.silverRunnerUp - pointsConfig.participation);

                // Adiciona stats de Coveiro
                coveiros.forEach(c => {
                    if (pointsDiff[c.id]) { // Garante que o jogador ainda est√° no diff
                        pointsDiff[c.id].coveiroWins = 1;
                    }
                });

                // Tenta aplicar o diff de pontos no ranking
                try {
                    await applyRankingDiff(rankingId, pointsDiff, 'add');
                    
                    // Se funcionou, marca o campeonato como finalizado NO DOC PRINCIPAL
                    await setDoc(champRef, {
                        status: 'finished',
                        winnerGold: goldFinal.winner.name,
                        winnerSilver: silverFinal.winner.name,
                        finalPointsAwarded: pointsDiff // Salva os pontos que foram dados
                    }, { merge: true });
                    
                    showModal("Campeonato Finalizado!", `Campe√µes Ouro: ${goldFinal.winner.name}\nCampe√µes Prata: ${silverFinal.winner.name}\n\nOs pontos de ranking (Ranking: ${rankingId}) foram distribu√≠dos.`);

                } catch (error) {
                    console.error("Erro ao aplicar pontos no ranking:", error);
                    showModal("Erro Cr√≠tico", "O campeonato terminou, mas houve um erro ao aplicar os pontos no ranking. Os dados do campeonato foram salvos, mas os pontos n√£o foram distribu√≠dos. Erro: " + error.message);
                }
            }
        };

        /* =============================================================================
           L√≥gica do Ranking Global (A√ß√µes de Admin)
           ============================================================================= */

        // =================================================================
        // === NOVA FUN√á√ÉO (Feature Edi√ß√£o): Aplica/Reverte pontos no ranking
        // =================================================================
        const applyRankingDiff = async (rankingId, pointsDiff, operation = 'add') => {
            if (!rankingId) throw new Error("ID do Ranking n√£o fornecido.");
            if (!pointsDiff) throw new Error("Diff de pontos n√£o fornecido.");
            if (Object.keys(pointsDiff).length === 0) {
                 console.log("Nenhum diff de pontos para aplicar.");
                 return;
            }

            const rankingRef = doc(db, 'users', appState.userId, 'rankings', rankingId);

            try {
                await runTransaction(db, async (transaction) => {
                    const rankingDoc = await transaction.get(rankingRef);
                    let players = [];
                    
                    if (rankingDoc.exists()) {
                        players = rankingDoc.data().players || [];
                    }
                    
                    const playersMap = new Map(players.map(p => [p.id, p]));

                    for (const playerId in pointsDiff) {
                        const diff = pointsDiff[playerId];
                        const player = playersMap.get(playerId);
                        
                        const op = (operation === 'add') ? 1 : -1;

                        if (player) {
                            // Jogador existe, atualiza
                            player.points = (player.points || 0) + (diff.points * op);
                            player.goldWins = (player.goldWins || 0) + (diff.goldWins * op);
                            player.silverWins = (player.silverWins || 0) + (diff.silverWins * op);
                            player.coveiroWins = (player.coveiroWins || 0) + (diff.coveiroWins * op);
                            
                            // Garante que n√£o fica negativo
                            if (player.points < 0) player.points = 0;
                            if (player.goldWins < 0) player.goldWins = 0;
                            if (player.silverWins < 0) player.silverWins = 0;
                            if (player.coveiroWins < 0) player.coveiroWins = 0;
                            
                        } else if (operation === 'add') {
                            // Jogador n√£o existe no ranking, adiciona
                            const newPlayer = {
                                id: playerId,
                                // Precisamos do nome...
                                // Busca no torneio atual
                                name: activeChampionship.players.find(p => p.id === playerId)?.name || 'Jogador Desconhecido',
                                points: Math.max(0, diff.points),
                                goldWins: Math.max(0, diff.goldWins),
                                silverWins: Math.max(0, diff.silverWins),
                                coveiroWins: Math.max(0, diff.coveiroWins)
                            };
                            playersMap.set(playerId, newPlayer);
                        }
                    }
                    
                    // Salva a lista atualizada
                    transaction.set(rankingRef, { players: Array.from(playersMap.values()) }, { merge: true });
                });
            } catch (error) {
                console.error("Erro na transa√ß√£o de pontos:", error);
                throw new Error("Falha ao atualizar o ranking. " + error.message);
            }
        };


        /* =============================================================================
           Fun√ß√µes de C√°lculo e Utilit√°rios
           ============================================================================= */

        // (Helper) -- Calcula ranking do grupo
        const getRankings = (group) => {
            const playerStats = group.players.map(p => ({
                id: p.id,
                name: p.name,
                wins: 0,
                gamesWon: 0,
                gamesLost: 0
            }));
            const playerMap = new Map(playerStats.map(p => [p.id, p]));

            group.matches.forEach(match => {
                if (match.score[0] === null) return; // Jogo n√£o jogado

                const p1 = playerMap.get(match.pairs[0].id);
                const p2 = playerMap.get(match.pairs[1].id);
                const s1 = match.score[0];
                const s2 = match.score[1];

                p1.gamesWon += s1;
                p1.gamesLost += s2;
                p2.gamesWon += s2;
                p2.gamesLost += s1;

                if (s1 > s2) {
                    p1.wins++;
                } else {
                    p2.wins++;
                }
            });

            // Ordena por: 1¬∫ Vit√≥rias (desc), 2¬∫ Saldo de Games (desc), 3¬∫ Games Vencidos (desc)
            playerStats.sort((a, b) => {
                if (a.wins !== b.wins) return b.wins - a.wins;
                const saldoA = a.gamesWon - a.gamesLost;
                const saldoB = b.gamesWon - b.gamesLost;
                if (saldoA !== saldoB) return saldoB - saldoA;
                return b.gamesWon - a.gamesWon;
            });

            return playerStats;
        };

        // (Helper) -- Calcula estat√≠sticas globais (para o Coveiro)
        // =================================================================
        // === FUN√á√ÉO MODIFICADA (BYE): Adiciona +6 games para quem passou por Bye
        // =================================================================
        const getGlobalTournamentStats = (champData) => {
            if (!champData || !champData.players) return [];

            const playerStats = champData.players.map(p => ({
                id: p.id,
                name: p.name,
                gamesWon: 0
            }));
            const playerMap = new Map(playerStats.map(p => [p.id, p]));
            
            // 1. Soma games da Fase de Grupos
            champData.groups.forEach(group => {
                const groupRankings = getRankings(group); // Reutiliza a l√≥gica
                groupRankings.forEach(playerRank => {
                    const player = playerMap.get(playerRank.id);
                    if (player) {
                        player.gamesWon += playerRank.gamesWon;
                    }
                });
            });

            // 2. Soma games do Mata-Mata
            const allBrackets = (champData.goldBracket || []).concat(champData.silverBracket || []);
            allBrackets.forEach(match => {
                if (match.score[0] === null) return; // Jogo n√£o jogado

                // Itera sobre as DUAS duplas do jogo
                [0, 1].forEach(pairIndex => {
                    const pair = match.pairs[pairIndex];
                    if (pair && pair.playerIds) {
                        const score = match.score[pairIndex];
                        // Adiciona o placar para ambos os jogadores da dupla
                        pair.playerIds.forEach(playerId => {
                            const player = playerMap.get(playerId);
                            if (player) {
                                player.gamesWon += score;
                            }
                        });
                    }
                });
            });

            // 3. (NOVO) Adiciona 6 games para quem passou por "Bye"
            // "Bye" = Jogou a Rodada 1 sem jogar a Rodada 0
            const bracketRounds = allBrackets.filter(m => m.round === 0 || m.round === 1);
            
            playerMap.forEach(player => {
                const pId = player.id;
                
                // Verifica se o jogador esteve em alguma dupla na Rodada 0
                const playedInRound0 = bracketRounds.some(m => 
                    m.round === 0 && 
                    (m.pairs[0]?.playerIds.includes(pId) || m.pairs[1]?.playerIds.includes(pId))
                );
                
                // Verifica se o jogador esteve em alguma dupla na Rodada 1
                const playedInRound1 = bracketRounds.some(m => 
                    m.round === 1 && 
                    (m.pairs[0]?.playerIds.includes(pId) || m.pairs[1]?.playerIds.includes(pId))
                );

                // Se jogou R1 e n√£o jogou R0, ele teve um "Bye"
                if (playedInRound1 && !playedInRound0) {
                    player.gamesWon += 6; // Adiciona os 6 games (W.O.)
                }
            });


            // Retorna ordenado pelo MENOR n√∫mero de games
            return playerStats.sort((a, b) => a.gamesWon - b.gamesWon);
        };

        // (Helper) -- Embaralha array
        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        /* =============================================================================
           Fun√ß√µes de Impress√£o (PDF)
           ============================================================================= */

        // (HELPER) -- Fun√ß√£o gen√©rica para PDF
        const getJspdfOrShowError = () => {
             if (window.jspdf && window.jspdf.jsPDF) {
                 return new window.jspdf.jsPDF();
             }
             if (window.jsPDF) {
                 return new window.jsPDF();
             }
             showModal("Erro", "A biblioteca de PDF (jsPDF) n√£o foi carregada. Verifique sua conex√£o com a internet.");
             return null;
        };
        
        // (PDF) -- Imprime o Ranking Global
        const handlePrintRankingPDF = () => {
            const doc = getJspdfOrShowError();
            if (!doc) return;
            
            const { autoTable } = window.jspdf;
            if (!autoTable) {
                showModal("Erro", "A biblioteca de Tabela (jsPDF-AutoTable) n√£o foi carregada.");
                return;
            }

            const ranking = allRankings.find(r => r.id === appState.currentRankingId);
            const rankingName = ranking ? ranking.name : "Ranking Geral";
            const head = [['Pos.', 'Jogador', 'Pontos', 'Ouro ü•á', 'Prata ü•à', 'Coveiro üëª']];
            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);
            const body = sortedPlayers.map((player, index) => [
                `${index + 1}¬∫`,
                player.name,
                player.points || 0,
                player.goldWins || 0,
                player.silverWins || 0,
                player.coveiroWins || 0
            ]);

            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text(`üèÜ ${rankingName}`, 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 26);

            autoTable(doc, {
                startY: 32,
                head: head,
                body: body,
                theme: 'striped', // 'striped', 'grid', 'plain'
                headStyles: { fillColor: [8, 145, 178] }, // Cor 'Mar' (cyan-600)
                styles: { fontSize: 10 },
            });

            doc.save(`${rankingName.replace(/\s+/g, '-')}.pdf`);
        };
        
        // (PDF) -- Imprime a S√∫mula do Grupo
        const handlePrintGroup = (groupIndex) => {
            const doc = getJspdfOrShowError();
            if (!doc) return;
            const { autoTable } = window.jspdf;
            
            const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
            const group = activeChampionship.groups[groupIndex];
            const groupName = `Grupo ${groupIndex + 1}`;

            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text(`üéæ ${champInfo.name}`, 14, 20);
            
            doc.setFontSize(16);
            doc.setTextColor(100, 100, 100);
            doc.text(`S√∫mula - ${groupName}`, 14, 28);
            
            // Jogadores do Grupo
            doc.setFontSize(12);
            doc.setTextColor(40, 40, 40);
            doc.text("Jogadores:", 14, 40);
            const playersList = group.players.map((p, i) => `${i+1}. ${p.name}`).join('\n');
            doc.text(playersList, 14, 46);

            // Tabela de Jogos
            doc.setFontSize(12);
            doc.text("Jogos:", 14, 75);
            const head = [['Dupla 1', 'Dupla 2', 'Placar']];
            const body = group.matches.map(m => [
                m.names[0],
                m.names[1],
                "____ x ____" // Espa√ßo para preencher
            ]);

            autoTable(doc, {
                startY: 81,
                head: head,
                body: body,
                theme: 'grid',
                headStyles: { fillColor: [8, 145, 178] },
                styles: { fontSize: 10, cellPadding: 3 },
                didDrawCell: (data) => {
                     // Adiciona linhas de assinatura se for o placar
                     if (data.column.index === 2 && data.cell.section === 'body') {
                        // Deixa a c√©lula de placar maior
                        data.cell.height = 20;
                     }
                }
            });
            
            let finalY = doc.lastAutoTable.finalY;
            
            // Tabela de Ranking (em branco)
            doc.setFontSize(12);
            doc.text("Ranking Final:", 14, finalY + 12);
            const rankingHead = [['Pos.', 'Jogador', 'Vit√≥rias', 'Saldo', 'Games V.']];
            const rankingBody = [
                ['1¬∫', '', '', '', ''],
                ['2¬∫', '', '', '', ''],
                ['3¬∫', '', '', '', ''],
                ['4¬∫', '', '', '', '']
            ];
            
            autoTable(doc, {
                startY: finalY + 18,
                head: rankingHead,
                body: rankingBody,
                theme: 'grid',
                headStyles: { fillColor: [253, 230, 138] }, // bg-amber-300
            });
            
            doc.save(`Sumula-${groupName.replace(/\s+/g, '-')}.pdf`);
        };

        // (PDF) -- Imprime o Relat√≥rio Final do Campeonato
        const handlePrintChampionshipPDF = () => {
             const doc = getJspdfOrShowError();
             if (!doc) return;
             const { autoTable } = window.jspdf;

             const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
             
             doc.setFontSize(22);
             doc.setTextColor(40, 40, 40);
             doc.text(`üèÜ Relat√≥rio Final üèÜ`, 105, 20, { align: 'center' });
             doc.setFontSize(16);
             doc.setTextColor(100, 100, 100);
             doc.text(champInfo.name, 105, 28, { align: 'center' });
             
             let currentY = 40;

             // P√≥dios
             doc.setFontSize(14);
             doc.setTextColor(40, 40, 40);
             doc.text("P√≥dio - S√©rie Ouro ü•á", 14, currentY);
             doc.setFontSize(12);
             doc.text(`Campe√µes: ${champInfo.winnerGold}`, 14, currentY + 7);
             
             const goldFinal = activeChampionship.goldBracket.find(m => m.round === Math.max(...activeChampionship.goldBracket.map(m => m.round)));
             const goldRunnerUp = goldFinal.pairs.find(p => p.id !== goldFinal.winner.id);
             doc.text(`Vice: ${goldRunnerUp.name}`, 14, currentY + 14);

             doc.setFontSize(14);
             doc.text("P√≥dio - S√©rie Prata ü•à", 105, currentY);
             doc.setFontSize(12);
             doc.text(`Campe√µes: ${champInfo.winnerSilver}`, 105, currentY + 7);
             
             const silverFinal = activeChampionship.silverBracket.find(m => m.round === Math.max(...activeChampionship.silverBracket.map(m => m.round)));
             const silverRunnerUp = silverFinal.pairs.find(p => p.id !== silverFinal.winner.id);
             doc.text(`Vice: ${silverRunnerUp.name}`, 105, currentY + 14);
             
             currentY += 28;
             
             // Coveiro
             const stats = getGlobalTournamentStats(activeChampionship);
             const minGames = stats[0].gamesWon;
             const coveiros = stats.filter(p => p.gamesWon === minGames).map(c => c.name).join(' / ');
             
             doc.setFontSize(14);
             doc.text(`Pr√™mio Coveiro üëª`, 14, currentY);
             doc.setFontSize(12);
             doc.text(`${coveiros} (com ${minGames} games)`, 14, currentY + 7);
             
             currentY += 20;
             
             // Pontos
             doc.setFontSize(14);
             doc.text("Pontos de Ranking Distribu√≠dos", 14, currentY);
             
             const head = [['Jogador', 'Pontos']];
             const body = Object.entries(champInfo.finalPointsAwarded).map(([playerId, diff]) => {
                 const player = activeChampionship.players.find(p => p.id === playerId);
                 return [player.name, diff.points];
             }).sort((a,b) => b[1] - a[1]); // Ordena por pontos
             
             autoTable(doc, {
                startY: currentY + 6,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [8, 145, 178] },
            });
            
             currentY = doc.lastAutoTable.finalY + 12;

             // Resultados dos Grupos
             doc.setFontSize(14);
             doc.text("Resultados dos Grupos", 14, currentY);
             
             let groupTables = [];
             activeChampionship.groups.forEach((group, index) => {
                 const rankings = getRankings(group);
                 const groupBody = rankings.map((p, i) => [
                     `${i+1}¬∫`,
                     p.name,
                     p.wins,
                     p.gamesWon - p.gamesLost
                 ]);
                 groupTables.push({
                     title: `Grupo ${index + 1}`,
                     head: [['Pos.', 'Jogador', 'V', 'Saldo']],
                     body: groupBody
                 });
             });
             
             // Desenha as tabelas lado a lado
             let tableY = currentY + 6;
             let tableX = 14;
             const tableWidth = 90; // Largura de cada tabela
             
             groupTables.forEach((table, index) => {
                if (index > 0 && index % 2 === 0) {
                    tableX = 14;
                    tableY = doc.lastAutoTable.finalY + 10;
                } else if (index % 2 === 1) {
                    tableX = 105;
                }
                
                doc.setFontSize(12);
                doc.text(table.title, tableX, tableY);
                
                autoTable(doc, {
                    startY: tableY + 6,
                    head: table.head,
                    body: table.body,
                    theme: 'grid',
                    tableWidth: tableWidth,
                    headStyles: { fillColor: [253, 230, 138], textColor: [50, 50, 50] }, // Amarelo
                    margin: { left: tableX }
                });
             });

             doc.save(`Relatorio-${champInfo.name.replace(/\s+/g, '-')}.pdf`);
        };


        /* =============================================================================
           Inicializa√ß√£o do Firebase e App
           ============================================================================= */

        // (HELPER) -- Fun√ß√£o gen√©rica para "desligar" um listener
        const safelyUnsubscribe = (unsubscribe) => {
            if (unsubscribe && typeof unsubscribe === 'function') {
                unsubscribe();
            }
            return () => {}; // Retorna uma fun√ß√£o vazia
        };

        // LISTENER: Escuta a lista de Rankings (ex: Geral, Temporada 2025)
        const listenToRankingsList = () => {
            unsubscribeRankingsList = safelyUnsubscribe(unsubscribeRankingsList);
            
            const rankingsRef = doc(db, 'users', appState.userId, 'app_data', 'rankings');
            
            unsubscribeRankingsList = onSnapshot(rankingsRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().list) {
                    allRankings = docSnap.data().list;
                } else {
                    // Se n√£o existir, cria o ranking "Geral" padr√£o
                    allRankings = [{ id: 'geral', name: 'Ranking Geral' }];
                    // Salva no DB
                    setDoc(rankingsRef, { list: allRankings }).catch(e => console.error("Erro ao criar ranking 'geral':", e));
                }
                
                // Se o ranking atual n√£o estiver mais na lista, muda para o primeiro
                if (!allRankings.find(r => r.id === appState.currentRankingId)) {
                    appState.currentRankingId = allRankings[0].id;
                }
                
                // (RE-RENDER) Re-renderiza a tela atual (pode ser a lista de camps ou o ranking)
                render();
                
                // (CHAIN) Chama o listener de players com o ranking correto
                listenToGlobalPlayers();
                
            }, (error) => {
                console.error("Erro ao escutar lista de rankings:", error);
                showModal("Erro de Conex√£o", "N√£o foi poss√≠vel carregar a lista de rankings.");
            });
        };
        
        // LISTENER: Escuta a lista de Campeonatos (para o Hist√≥rico)
        const listenToChampionships = () => {
            unsubscribeChampionships = safelyUnsubscribe(unsubscribeChampionships);

            const q = query(collection(db, 'users', appState.userId, 'championships'));
            
            unsubscribeChampionships = onSnapshot(q, (snapshot) => {
                championships = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // (RE-RENDER) Se estivermos na tela de lista, atualiza
                if (appState.currentView === 'championshipList') {
                    render();
                }
                
                // (RE-RENDER) Se estivermos vendo um camp que foi finalizado, atualiza
                const champInfo = championships.find(c => c.id === appState.currentChampionshipId);
                if (appState.currentView === 'championshipView' && champInfo?.status === 'finished' && activeChampionship?.status !== 'finished') {
                     render(); // Atualiza a tela do camp para mostrar o p√≥dio
                }
                
            }, (error) => {
                console.error("Erro ao escutar campeonatos:", error);
                showModal("Erro de Conex√£o", "N√£o foi poss√≠vel carregar o hist√≥rico de campeonatos.");
            });
        };

        // LISTENER: Escuta a lista de Jogadores GLOBAIS (do ranking selecionado)
        const listenToGlobalPlayers = () => {
            unsubscribeGlobalPlayers = safelyUnsubscribe(unsubscribeGlobalPlayers);
            if (!appState.currentRankingId) {
                console.warn("N√£o √© poss√≠vel escutar players, 'currentRankingId' nulo.");
                globalPlayers = [];
                render(); // Renderiza a tela (que mostrar√° "nenhum jogador")
                return;
            }

            // O ID do documento de ranking √© o ID selecionado
            const rankingRef = doc(db, 'users', appState.userId, 'rankings', appState.currentRankingId);
            
            unsubscribeGlobalPlayers = onSnapshot(rankingRef, (docSnap) => {
                globalPlayers = []; // Limpa a lista
                if (docSnap.exists()) {
                    globalPlayers = docSnap.data().players || [];
                }
                // Se o doc n√£o existir (ex: ranking novo), a lista fica vazia.
                
                // (RE-RENDER) Se estivermos na tela do ranking, atualiza
                if (appState.currentView === 'globalRanking') {
                    render();
                }
            }, (error) => {
                console.error("Erro ao escutar players do ranking:", error);
                showModal("Erro de Conex√£o", `N√£o foi poss√≠vel carregar os jogadores do ranking '${appState.currentRankingId}'.`);
            });
        };

        // LISTENER: Escuta os dados DO CAMPEONATO ATIVO
        const listenToActiveChampionship = (champId) => {
            unsubscribeActiveChampionship = safelyUnsubscribe(unsubscribeActiveChampionship);

            const champDataRef = doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main');
            
            unsubscribeActiveChampionship = onSnapshot(champDataRef, (docSnap) => {
                if (docSnap.exists()) {
                    activeChampionship = docSnap.data();
                    
                    // (RE-RENDER) Atualiza a tela (seja admin ou tel√£o)
                    if (appState.currentView === 'championshipView' || appState.currentView === 'telaoView') {
                        render();
                    }
                } else {
                    // O doc 'main' n√£o existe (pode ter sido exclu√≠do)
                    activeChampionship = null;
                    if (!appState.isTelaoMode) {
                        showModal("Erro", "N√£o foi poss√≠vel carregar os dados deste campeonato. Ele pode ter sido exclu√≠do.");
                        navigateTo('championshipList');
                    }
                }
            }, (error) => {
                console.error("Erro ao escutar campeonato ativo:", error);
                 if (!appState.isTelaoMode) {
                    showModal("Erro de Conex√£o", "N√£o foi poss√≠vel carregar os dados deste campeonato.");
                    navigateTo('championshipList');
                 }
            });
        };


        // =================================================================
        // === FUN√á√ÉO DE INICIALIZA√á√ÉO
        // =================================================================
        const init = () => {
            // Verifica se est√° no modo Tel√£o (via URL params)
            const urlParams = new URLSearchParams(window.location.search);
            const telaoChampId = urlParams.get('champId');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Autenticado (an√¥nimo)
                    console.log("Autenticado anonimamente.");
                    appState.isAuthReady = true;
                    
                    // FOR√áA O ADMIN MASTER A TER O ID CORRETO
                    // Isso n√£o √© seguro, mas √© o que o c√≥digo original fazia
                    appState.userId = MESTRE_USER_ID; 
                    userIdFooter.textContent = appState.userId;
                    
                    // 2. Inicia os listeners globais (necess√°rios para ambos os modos)
                    listenToChampionships();
                    listenToRankingsList(); // Esta fun√ß√£o vai chamar listenToGlobalPlayers()

                    if (urlParams.has('telao') && telaoChampId) {
                        // --- MODO TEL√ÉO ---
                        appState.isTelaoMode = true;
                        appState.isAdmin = false; // Tel√£o √© sempre visitante

                        // Adiciona estilos para a view limpa
                        const telaoStyles = document.createElement('style');
                        telaoStyles.innerHTML = `
                            body { background-color: #FFFAF0; } /* Fundo 'Areia' (amber-50) */
                            /* Ajusta o container para telas largas, mantendo um padding */
                            #app-container { max-width: 100%; padding: 1rem 2rem; }
                            header, footer { display: none !important; }
                        `;
                        document.head.appendChild(telaoStyles);

                        // Navega direto para o tel√£o
                        navigateTo('telaoView', telaoChampId);

                    } else {
                        // --- MODO NORMAL ---
                        appState.isTelaoMode = false;
                        navigateTo('login');
                    }
                }
            });

            // Tenta o login an√¥nimo
            signInAnonymously(auth)
                .catch((error) => {
                    console.error("Erro no login an√¥nimo:", error);
                    showModal("Erro Cr√≠tico de Firebase", "N√£o foi poss√≠vel conectar ao banco de dados. Verifique as regras de seguran√ßa do Firestore (Auth).");
                    loadingSpinner.innerHTML = `<p class="text-rose-600">Falha na autentica√ß√£o. Verifique o console.</p>`;
                });
        };

        // Ponto de entrada
        init();

    </script>
</body>
</html>
