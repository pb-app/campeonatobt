<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Beach Tennis üéæ</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0891B2"> <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ranking BT">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #installBanner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0891B2; /* Cor 'Mar' (cyan-600) */
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #installBanner button {
            background-color: white;
            color: #0891B2; /* Cor 'Mar' (cyan-600) */
            border: none;
            padding: 6px 12px;
            margin-left: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        #installBanner button:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-amber-50 min-h-screen"> <div id="installBanner">
        Instale o aplicativo para ter acesso r√°pido na tela inicial!
        <button id="installBtn">Instalar</button>
    </div>

    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js') // Certifique-se que o nome √© 'sw.js'
                .then(() => console.log('‚úÖ Service Worker registrado com sucesso!'))
                .catch(err => console.log('‚ùå Erro ao registrar o Service Worker:', err));
        }

        // Banner de instala√ß√£o PWA
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // impede o prompt autom√°tico
            deferredPrompt = e;
            installBanner.style.display = 'block'; // mostra o banner
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt(); // mostra o prompt
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('‚úÖ Usu√°rio aceitou instalar');
            } else {
                console.log('‚ùå Usu√°rio recusou instalar');
            }
            deferredPrompt = null;
            installBanner.style.display = 'none';
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            /* Cor de fundo agora controlada pelo Tailwind no <body> */
            color: #1F2937; /* Cor do Texto Principal (Gray-800) */
        }

        /* Anima√ß√£o de fade-in */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-fade-in-sm {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Para esconder elementos */
        .hidden {
            display: none;
        }

        /* Melhorias no Scrollbar (Mant√©m escuro para contraste) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FEF3C7; /* bg-amber-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #9CA3AF; /* bg-gray-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="text-gray-900"> <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 sm:mb-8 gap-4 bg-white p-4 rounded-xl shadow-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-600 text-center sm:text-left">
                üèñÔ∏è Ranking Beach Tennis
            </h1>
            <div id="header-buttons" class="flex gap-3">
                </div>
        </header>

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600 mx-auto"></div>
            <p class="mt-4 text-gray-500">Carregando dados...</p>
        </div>

        <main id="main-content" class="hidden">
            </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>ID da Liga: <span id="user-id-footer">Conectando...</span></p>
            <p>App de Ranking v4.0.4 (Final)</p>
        </footer>

    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-sm w-full mx-auto animate-fade-in-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl sm:text-2xl font-bold text-cyan-600"></h3>
                <button id="modal-close-icon" class="text-gray-500 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-message" class="text-gray-700 text-sm sm:text-base mb-6 max-h-60 overflow-y-auto"></div>
            
            <div id="modal-buttons" class="flex gap-3 justify-end">
                <button
                    id="modal-close-btn"
                    class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                    Entendi
                </button>
                </div>
            
        </div>
    </div>
    <script type="module">
        // Importa√ß√µes do Firebase SDK
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            deleteDoc, 
            query,
            Timestamp,
            getDoc,
            writeBatch,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* =============================================================================
           Configura√ß√£o do Firebase (Fornecida pelo usu√°rio)
           ============================================================================= */
        const firebaseConfig = {
          apiKey: "AIzaSyDeS-rk8OJKhghv1djVucmR3-erOa-ppMY",
          authDomain: "campeonato-sortudo.firebaseapp.com",
          projectId: "campeonato-sortudo",
          storageBucket: "campeonato-sortudo.firebasestorage.app",
          messagingSenderId: "706083235199",
          appId: "1:706083235199:web:5eca6041bb817401ee264a"
        };

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); 

        /* =============================================================================
           ID Mestre e Senha de Admin
           ============================================================================= */
        const MESTRE_USER_ID = "campeonato-sortudo-admin";

        // ==========================================
        // === MUDE SUA SENHA DE ADMIN AQUI ===
        // ==========================================
        const ADMIN_PASSWORD = "adm2025"; 

        /* =============================================================================
           Estado Global do Aplicativo
           ============================================================================= */
        let appState = {
            userId: null, // Ser√° preenchido com o MESTRE_USER_ID
            isAuthReady: false,
            isAdmin: false, 
            isTelaoMode: false,
            currentView: 'loading', // 'loading', 'login', 'championshipList', 'championshipView', 'globalRanking', 'telaoView'
            currentChampionshipId: null,
            currentRankingId: null, // ID do ranking sendo visualizado/editado
        };

        let allRankings = []; // Lista de todos os rankings (ex: [{id: 'geral', name: 'Ranking Geral'}])
        let championships = []; // Lista de todos os campeonatos
        let globalPlayers = []; // Lista de jogadores DO RANKING ATUALMENTE SELECIONADO (appState.currentRankingId)
        let activeChampionship = null; // Dados do campeonato selecionado

        // Listeners do Firebase (para poder "desligar" ao trocar de tela)
        let unsubscribeRankingsList = () => {}; 
        let unsubscribeChampionships = () => {}; 
        let unsubscribeGlobalPlayers = () => {}; 
        let unsubscribeActiveChampionship = () => {}; 

        /* =============================================================================
           Refer√™ncias do DOM
           ============================================================================= */
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const headerButtons = document.getElementById('header-buttons');
        const userIdFooter = document.getElementById('user-id-footer');

        // Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        // CORRE√á√ÉO: Refer√™ncia ao novo DIV de bot√µes
        const modalButtons = document.getElementById('modal-buttons');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalCloseIcon = document.getElementById('modal-close-icon');

        /* =============================================================================
           Constantes de Pontua√ß√£o (Padr√£o)
           ============================================================================= */
        // Usado como fallback e valores padr√£o dos inputs
        const DEFAULT_RANKING_POINTS = {
            GOLD_WINNER: 100,
            GOLD_RUNNERUP: 70,
            SILVER_WINNER: 40,
            SILVER_RUNNERUP: 20,
            PARTICIPATION: 5
        };
        
        /* =============================================================================
           √çcones SVG (Reutilizados)
           ============================================================================= */
        const icons = {
            users: '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            trash: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            swords: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"></polyline><line x1="13" y1="19" x2="19" y2="13"></line><line x1="16" y1="16" x2="20" y2="20"></line><line x1="19" y1="21" x2="21" y2="19"></polyline><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"></polyline><line x1="11" y1="5" x2="5" y2="11"></line><line x1="8" y1="8" x2="4" y2="4"></line><line x1="3" y1="5" x2="5" y2="3"></line></svg>',
            trophy: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>',
            shield: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-yellow-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
            shieldOff: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block text-gray-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>',
            // √çcone "medal" removido (n√£o usado)
            award: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>',
            arrowLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
            eye: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
            logIn: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>',
            logOut: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>',
            check: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            settings: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
            shovel: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3 text-red-600"><path d="M2 22v-5l5-5 5 5v5H2z"></path><path d="M9.5 17H14a5 5 0 0 0 5-5V7A2 2 0 0 0 17 5H7a2 2 0 0 0-2 2v5a5 5 0 0 0 5 5z"></path><path d="M9.5 17v5"></path></svg>', 
            shovelSmall: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22v-5l5-5 5 5v5H2z"></path><path d="M9.5 17H14a5 5 0 0 0 5-5V7A2 2 0 0 0 17 5H7a2 2 0 0 0-2 2v5a5 5 0 0 0 5 5z"></path><path d="M9.5 17v5"></path></svg>',
            printer: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>',
            fileDown: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            tv: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>',
            // NOVO √çCONE (PARA EDI√á√ÉO)
            edit: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>'
        };

        /* =============================================================================
           Fun√ß√µes do Modal (ATUALIZADA)
           ============================================================================= */
        
        // ATUALIZADA: Limpa bot√µes extras
        const showModal = (title, message, buttons = null) => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            
            // Limpa bot√µes antigos e mostra o padr√£o
            modalButtons.innerHTML = '';
            modalCloseBtn.style.display = 'block';
            modalButtons.appendChild(modalCloseBtn);

            if (buttons) {
                // Se bot√µes customizados forem passados, esconde o padr√£o
                modalCloseBtn.style.display = 'none';
                buttons.forEach(btn => {
                    const buttonEl = document.createElement('button');
                    buttonEl.id = btn.id;
                    buttonEl.className = btn.className;
                    buttonEl.textContent = btn.text;
                    buttonEl.onclick = btn.handler;
                    modalButtons.appendChild(buttonEl);
                });
            }
            
            modal.classList.remove('hidden');
        };
        const hideModal = () => modal.classList.add('hidden');
        modalCloseBtn.addEventListener('click', hideModal);
        modalCloseIcon.addEventListener('click', hideModal);
        modal.addEventListener('click', hideModal);
        modal.firstElementChild.addEventListener('click', (e) => e.stopPropagation());

        /* =============================================================================
           Fun√ß√µes de Navega√ß√£o e Renderiza√ß√£o Principal
           ============================================================================= */

        // Router Principal
        const render = () => {

            // Esconde o spinner global se n√£o estivermos na tela de loading
            if (appState.currentView !== 'loading') {
                loadingSpinner.classList.add('hidden');
                mainContent.classList.remove('hidden');
            } else {
                loadingSpinner.classList.remove('hidden');
                mainContent.classList.add('hidden');
                return;
            }

            // N√£o renderiza cabe√ßalho no Modo Tel√£o
            if (!appState.isTelaoMode) {
                renderHeaderButtons();
            }

            // Renderiza o conte√∫do principal baseado na view
            switch (appState.currentView) {
                case 'login': 
                    renderLogin();
                    break;
                case 'championshipList':
                    renderChampionshipList();
                    break;
                case 'globalRanking':
                    renderGlobalRanking();
                    break;
                case 'championshipView':
                    renderChampionshipView();
                    break;
                case 'telaoView':
                    renderTelaoView();
                    break;
                default:
                    mainContent.innerHTML = `<p>Estado desconhecido: ${appState.currentView}</p>`;
            }
        };

        const navigateTo = (view, champId = null) => {
            if (view === 'login') {
                appState.isAdmin = false;
            }

            appState.currentView = view;
            appState.currentChampionshipId = champId;

            // Desliga listeners antigos
            unsubscribeActiveChampionship();
            activeChampionship = null;

            // Se estamos abrindo um campeonato OU um tel√£o, precisamos garantir
            // que o listener global de players esteja olhando o ranking *correto*.
            if ((view === 'championshipView' || view === 'telaoView') && champId) {
                const champ = championships.find(c => c.id === champId);
                if (champ && champ.rankingId) {
                    // Se o ranking do app n√£o for o do camp, troca e re-escuta
                    if (appState.currentRankingId !== champ.rankingId) {
                        appState.currentRankingId = champ.rankingId;
                        listenToGlobalPlayers(); // Isso vai carregar globalPlayers com a lista certa
                    }
                } else if (championships.length > 0 && !champ) {
                    // Pode acontecer se os listeners n√£o estiverem prontos
                    console.warn("Navegando para o tel√£o, mas a lista de campeonatos ainda n√£o tem o ID:", champId);
                    // Tentaremos carregar mesmo assim.
                }
                listenToActiveChampionship(champId); // Isso vai carregar o camp e chamar o render()

            } else if (view === 'globalRanking') {
                // Garante que o listener de players est√° ligado ao ranking selecionado
                listenToGlobalPlayers();
                render();
            } else {
                // Para outras telas (login, champList), renderiza imediatamente
                render();
            }
        };

        const renderHeaderButtons = () => {
            let navHtml = ''; // Bot√µes de Navega√ß√£o (Voltar/Ranking)
            let authHtml = ''; // Bot√µes de Autentica√ß√£o (Login/Sair)

            // L√≥gica de Navega√ß√£o
            if (appState.currentView === 'championshipList') {
                navHtml = `
                <button
                    id="nav-to-ranking"
                    class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    üèÜ ${icons.award}
                    Ranking Geral
                </button>
                `;
            } else if (appState.currentView === 'globalRanking' || appState.currentView === 'championshipView') {
                navHtml = `
                <button
                    id="nav-to-list"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                    ${icons.arrowLeft}
                    Voltar
                </button>
                `;
            }

            // L√≥gica de Autentica√ß√£o
            if (appState.currentView !== 'login') {
                if (appState.isAdmin) {
                    authHtml = `
                    <button
                        id="nav-to-login"
                        class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                        ${icons.logOut}
                        Sair (Admin)
                    </button>
                    `;
                } else {
                    authHtml = `
                    <button
                        id="nav-to-login"
                        class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all flex items-center justify-center gap-2 text-sm">
                        ${icons.logIn}
                        Login (Admin)
                    </button>
                    `;
                }
            }

            headerButtons.innerHTML = navHtml + authHtml; // Concatena os bot√µes

            // Adiciona listeners aos bot√µes
            const rankingBtn = document.getElementById('nav-to-ranking');
            if (rankingBtn) rankingBtn.addEventListener('click', () => navigateTo('globalRanking'));

            const listBtn = document.getElementById('nav-to-list');
            if (listBtn) listBtn.addEventListener('click', () => navigateTo('championshipList'));

            const loginBtn = document.getElementById('nav-to-login');
            if (loginBtn) loginBtn.addEventListener('click', () => navigateTo('login'));
        };

        /* =============================================================================
           TELA 0: Login
           ============================================================================= */

        const renderLogin = () => {
            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto animate-fade-in">
                    <h2 class="text-3xl font-bold text-center text-cyan-600 mb-8">Bem-vindo(a) üéæ</h2>
                    
                    <div class="space-y-4">
                        <button
                            id="visitor-login-btn"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 px-6 rounded-lg shadow-sm transition-all flex items-center justify-center gap-3 text-lg">
                            ${icons.eye}
                            Modo Visitante
                        </button>
                        
                        <button
                            id="admin-login-btn"
                            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition-all flex items-center justify-center gap-3 text-lg">
                            ${icons.logIn}
                            Modo Administrador
                        </button>
                    </div>
                </div>
            `;

            // Listeners
            document.getElementById('visitor-login-btn').addEventListener('click', () => {
                appState.isAdmin = false;
                navigateTo('championshipList');
            });

            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const password = prompt("Digite a senha de administrador:");
                if (password === ADMIN_PASSWORD) {
                    appState.isAdmin = true;
                    navigateTo('championshipList');
                } else if (password !== null) { // S√≥ mostra erro se o usu√°rio n√£o clicou em "Cancelar"
                    showModal("Acesso Negado", "Senha incorreta.");
                }
            });
        };

        /* =============================================================================
           TELA 1: Lista de Campeonatos (Hist√≥rico)
           ============================================================================= */

        const renderChampionshipList = () => {
            const sortedChampionships = [...championships].sort((a, b) => b.createdAt - a.createdAt);

            const championshipsListHtml = sortedChampionships.length === 0
                ? `<p class="text-gray-500 text-center py-4">Nenhum campeonato cadastrado.</p>`
                : sortedChampionships.map(champ => {
                    let statusColor = 'text-yellow-600';
                    let statusText = 'Em andamento';
                    if (champ.status === 'registration') { statusColor = 'text-cyan-600'; statusText = 'Em Inscri√ß√£o'; }
                    if (champ.status === 'finished') { statusColor = 'text-emerald-600'; statusText = 'Finalizado üèÖ'; }

                    const ranking = allRankings.find(r => r.id === champ.rankingId);
                    // Cor 'Acento' (orange-500)
                    const rankingHtml = ranking ? `<span class="block text-xs text-orange-600 font-medium">${ranking.name}</span>` : '';

                    const deleteButtonHtml = appState.isAdmin ? `
                    <button
                        class="delete-champ-btn text-rose-600 hover:text-rose-700 transition-colors p-2 rounded-lg bg-gray-100"
                        data-id="${champ.id}">
                        ${icons.trash}
                    </button>` : '';

                    return `
                    <div class="flex flex-col sm:flex-row justify-between items-center bg-white border border-gray-200 p-4 rounded-xl shadow-sm animate-fade-in-sm gap-3">
                        <div>
                            <span class="text-gray-800 font-bold text-lg">${champ.name}</span>
                            <span class="block text-sm ${statusColor}">${statusText}</span>
                            ${rankingHtml}
                            <span class="block text-xs text-gray-500">${new Date(champ.createdAt?.toDate()).toLocaleDateString()}</span>
                        </div>
                        <div class="flex gap-2">
                             <button
                                class="open-champ-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm"
                                data-id="${champ.id}">
                                ${icons.eye} Ver
                            </button>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                    `}).join('');

            const rankingsOptions = allRankings.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            const newChampionshipFormHtml = appState.isAdmin ? `
            <form id="add-championship-form">
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mb-8 border border-gray-200">
                    <h2 class="text-2xl font-bold text-cyan-600 mb-4">üéæ Novo Campeonato</h2>
                    
                    <div class="mb-4">
                        <label for="championship-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nome do Campeonato</label>
                        <input
                            type="text"
                            id="championship-name-input"
                            placeholder="ex: Torneio de Ver√£o"
                            class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            required
                        />
                    </div>
                    
                    <div class="mb-4">
                        <label for="ranking-select" class="block text-sm font-medium text-gray-700 mb-1">Vincular ao Ranking</label>
                        <div class="flex gap-2">
                            <select id="ranking-select" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                                ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking encontrado...</option>'}
                            </select>
                            <button type="button" id="add-new-ranking-btn" class="flex-shrink-0 bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-lg shadow-md transition-all">
                                ${icons.plus}
                            </button>
                        </div>
                    </div>


                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Configura√ß√£o de Pontos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div>
                            <label for="points-gold-winner" class="block text-xs font-medium text-emerald-600 mb-1">Campe√£o Ouro ü•á</label>
                            <input type="number" id="points-gold-winner" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_WINNER}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-gold-runnerup" class="block text-xs font-medium text-emerald-700 mb-1">Vice Ouro</label>
                            <input type="number" id="points-gold-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.GOLD_RUNNERUP}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-silver-winner" class="block text-xs font-medium text-gray-600 mb-1">Campe√£o Prata ü•à</label>
                            <input type="number" id="points-silver-winner" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_WINNER}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-silver-runnerup" class="block text-xs font-medium text-gray-700 mb-1">Vice Prata</label>
                            <input type="number" id="points-silver-runnerup" min="0" value="${DEFAULT_RANKING_POINTS.SILVER_RUNNERUP}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                        <div>
                            <label for="points-participation" class="block text-xs font-medium text-gray-500 mb-1">Participa√ß√£o</label>
                            <input type="number" id="points-participation" min="0" value="${DEFAULT_RANKING_POINTS.PARTICIPATION}"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-center text-gray-800">
                        </div>
                    </div>

                    <button
                        type="submit"
                        id="add-championship-btn"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                        ${icons.plus}
                        <span>Criar Campeonato</span>
                    </button>
                </div>
            </form>
            ` : ''; // Se n√£o for admin, n√£o mostra nada

            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    ${newChampionshipFormHtml}

                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 border border-gray-200">
                        <h3 class="text-2xl font-bold mb-5 text-cyan-600">Hist√≥rico de Campeonatos</h3>
                        <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-3">
                            ${championshipsListHtml}
                        </div>
                    </div>
                </div>
            `;

            // Listeners (s√≥ adiciona se o elemento existir)
            if (appState.isAdmin) {
                const addForm = document.getElementById('add-championship-form');
                if (addForm) addForm.addEventListener('submit', handleAddChampionship);

                // NOVO: Listener para criar ranking
                const addRankingBtn = document.getElementById('add-new-ranking-btn');
                if (addRankingBtn) addRankingBtn.addEventListener('click', handleAddNewRanking);

                document.querySelectorAll('.delete-champ-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeleteChampionship(btn.dataset.id));
                });
            }

            document.querySelectorAll('.open-champ-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo('championshipView', btn.dataset.id));
            });
        };

        const handleAddChampionship = async (e) => {
            e.preventDefault();
            // Esta fun√ß√£o s√≥ √© chamada se o formul√°rio existir (isAdmin = true)
            const input = document.getElementById('championship-name-input');
            const button = document.getElementById('add-championship-btn');
            const champName = input.value.trim();
            if (!champName) return;

            // =================================================================
            // === MUDAN√áA (REQUEST 3): Pega o ID do ranking selecionado ===
            // =================================================================
            const rankingId = document.getElementById('ranking-select').value;
            if (!rankingId) {
                showModal("Erro", "Nenhum ranking foi selecionado. Crie um ranking primeiro.");
                return;
            }

            button.disabled = true;
            button.lastChild.textContent = "Criando...";

            // Coleta os pontos personalizados
            const pointsConfig = {
                goldWinner: parseInt(document.getElementById('points-gold-winner').value) || 0,
                goldRunnerUp: parseInt(document.getElementById('points-gold-runnerup').value) || 0,
                silverWinner: parseInt(document.getElementById('points-silver-winner').value) || 0,
                silverRunnerUp: parseInt(document.getElementById('points-silver-runnerup').value) || 0,
                participation: parseInt(document.getElementById('points-participation').value) || 0
            };

            try {
                const batch = writeBatch(db);

                // 1. Cria a refer√™ncia para o NOVO doc de campeonato
                const champCollectionRef = collection(db, 'users', appState.userId, 'championships');
                const newChampRef = doc(champCollectionRef);

                // 2. Cria a refer√™ncia para o doc de dados aninhado
                const champDataRef = doc(db, 'users', appState.userId, 'championships', newChampRef.id, 'data', 'main');

                // 3. Adiciona os dados ao batch
                batch.set(newChampRef, {
                    name: champName,
                    createdAt: Timestamp.now(),
                    status: 'registration',
                    winnerGold: null,
                    winnerSilver: null,
                    pointsConfig: pointsConfig, // Salva os pontos personalizados
                    rankingId: rankingId, // NOVO: Salva o ID do ranking
                    finalPointsAwarded: null // NOVO (Feature Edi√ß√£o): Inicia como nulo
                });

                batch.set(champDataRef, {
                    players: [],
                    groups: [],
                    goldBracket: [],
                    silverBracket: [],
                    status: 'registration'
                });

                // 4. Executa o batch
                await batch.commit();

                input.value = '';
                showModal("Sucesso!", `Campeonato "${champName}" criado e vinculado ao ranking.`);
            } catch (error) {
                console.error("Erro ao criar campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel criar o campeonato.");
            }

            button.disabled = false;
            button.lastChild.textContent = "Criar Campeonato";
        };

        const handleDeleteChampionship = async (champId) => {
            // Esta fun√ß√£o s√≥ √© chamada se o bot√£o existir (isAdmin = true)
            const champ = championships.find(c => c.id === champId);
            if (window.prompt(`Para confirmar, digite o nome do campeonato: "${champ.name}"`) !== champ.name) {
                showModal("Cancelado", "A exclus√£o foi cancelada.");
                return;
            }
            
            // PERIGO: Esta exclus√£o n√£o remove os pontos do ranking global.
            // A funcionalidade de "recalcular" (Feature 2) ajudar√° a corrigir isso
            // se um admin excluir e recriar um camp, mas por enquanto √© uma exclus√£o simples.
            // Idealmente, dever√≠amos rodar um "applyRankingDiff" reverso aqui.

            try {
                // Deleta o documento de dados
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main'));
                // Deleta o documento principal
                await deleteDoc(doc(db, 'users', appState.userId, 'championships', champId));
            } catch (error) {
                console.error("Erro ao excluir campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel excluir o campeonato.");
            }
        };

        // =================================================================
        // === NOVA FUN√á√ÉO: Para criar um novo ranking (temporada, etc)
        // =================================================================
        const handleAddNewRanking = async () => {
            const name = prompt("Nome do novo ranking (ex: Temporada 2025):");
            if (!name || name.trim() === '') return;

            // Cria um ID seguro para o banco de dados
            const id = name.trim().toLowerCase()
                .replace(/\s+/g, '-') // substitui espa√ßos por -
                .replace(/[^a-z0-9-]/g, ''); // remove caracteres n√£o-alfanum√©ricos (exceto -)

            if (!id) {
                showModal("Erro", "Nome inv√°lido. Use letras e n√∫meros.");
                return;
            }

            // Verifica se o ID ou Nome j√° existem
            if (allRankings.find(r => r.id === id || r.name.toLowerCase() === name.trim().toLowerCase())) {
                showModal("Erro", "Um ranking com esse nome ou ID j√° existe.");
                return;
            }

            const newRanking = { id, name: name.trim() };
            const newList = [...allRankings, newRanking];

            try {
                // Salva a lista atualizada no documento 'rankings'
                await setDoc(doc(db, 'users', appState.userId, 'app_data', 'rankings'), { list: newList });
                showModal("Sucesso!", `Ranking "${name.trim()}" foi criado.`);
                // O listener 'listenToRankingsList' vai atualizar a UI automaticamente
            } catch (error) {
                console.error("Erro ao criar ranking:", error);
                showModal("Erro", "N√£o foi poss√≠vel salvar o novo ranking.");
            }
        };

        /* =============================================================================
           TELA 2: Ranking Global
           ============================================================================= */

        const renderGlobalRanking = () => {
            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);

            const rankingsHtml = sortedPlayers.length === 0
                ? `<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum jogador neste ranking.</td></tr>`
                : sortedPlayers.map((player, index) => `
                    <tr class="border-b border-amber-100 animate-fade-in-sm">
                        <td class="p-3 sm:p-4 font-bold text-lg text-cyan-600">${index + 1}¬∫</td>
                        <td class="p-3 sm:p-4 font-medium text-gray-800">${player.name}</td>
                        <td class="p-3 sm:p-4 font-bold text-xl text-orange-600">${player.points || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-emerald-600">${player.goldWins || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-gray-600">${player.silverWins || 0}</td>
                        <td class="p-3 sm:p-4 text-center text-rose-600">${player.coveiroWins || 0}</td>
                    </tr>
                `).join('');

            const rankingsOptions = allRankings.map(r => 
                `<option value="${r.id}" ${r.id === appState.currentRankingId ? 'selected' : ''}>
                    ${r.name}
                </option>`
            ).join('');

            const manageButtonHtml = appState.isAdmin ? `
                <button id="manage-rankings-btn" class="flex-shrink-0 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerenciar Rankings">
                    ${icons.settings}
                </button>
            ` : '';

            // Bot√£o Gerar PDF
            const printButtonHtml = `
                <button id="print-ranking-pdf-btn" class="flex-shrink-0 bg-rose-600 hover:bg-rose-700 text-white font-bold p-3 rounded-lg shadow-sm transition-all" title="Gerar PDF do Ranking">
                    ${icons.fileDown}
                </button>
            `;

            const rankingSelectorHtml = `
                <div class="mb-6">
                    <label for="ranking-view-select" class="block text-sm font-medium text-gray-700 mb-1">Visualizando Ranking:</label>
                    <div class="flex gap-2">
                        <select id="ranking-view-select" class="w-full bg-white border border-gray-300 text-gray-800 rounded-lg p-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            ${rankingsOptions.length > 0 ? rankingsOptions : '<option disabled>Nenhum ranking...</option>'}
                        </select>
                        ${manageButtonHtml}
                        ${printButtonHtml}
                    </div>
                </div>
            `;

            mainContent.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 animate-fade-in border border-gray-200">
                    <h2 class="text-3xl font-bold mb-6 text-cyan-600 flex items-center gap-3">
                        üèÜ ${icons.award} Ranking Geral
                    </h2>
                    
                    ${rankingSelectorHtml}

                    <div class="overflow-x-auto">
                        <table class="w-full min-w-max text-left">
                            <thead>
                                <tr class="bg-amber-100"> <th class="p-3 sm:p-4 rounded-tl-lg text-gray-600">Pos.</th>
                                    <th class="p-3 sm:p-4 text-gray-600">Jogador</th>
                                    <th class="p-3 sm:p-4 text-gray-600">Pontos</th>
                                    <th class="p-3 sm:p-4 text-center text-gray-600">ü•á Ouro</th>
                                    <th class="p-3 sm:p-4 text-center text-gray-600">ü•à Prata</th>
                                    <th class="p-3 sm:p-4 text-center rounded-tr-lg text-gray-600">üëª ${icons.shovelSmall}</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-amber-100"> ${rankingsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            const rankingViewSelect = document.getElementById('ranking-view-select');
            if (rankingViewSelect) rankingViewSelect.addEventListener('change', handleViewRankingChange);
            
            const manageRankingsBtn = document.getElementById('manage-rankings-btn');
            if (manageRankingsBtn) manageRankingsBtn.addEventListener('click', renderRankingManagementModal);

            const printRankingBtn = document.getElementById('print-ranking-pdf-btn');
            if (printRankingBtn) printRankingBtn.addEventListener('click', handlePrintRankingPDF);
        };// =================================================================
        // === MUDAN√áA (REQUEST 3): Handler para trocar o ranking
        // =================================================================
        const handleViewRankingChange = (e) => {
            const newRankingId = e.target.value;
            if (newRankingId && newRankingId !== appState.currentRankingId) {
                appState.currentRankingId = newRankingId;
                // O render() √© chamado dentro de listenToGlobalPlayers
                listenToGlobalPlayers(); // Troca o listener e recarrega a tela
            }
        };

        // =================================================================
        // === MUDAN√áA (REQUEST 3): Modal de Gerenciamento de Rankings
        // =================================================================
        const renderRankingManagementModal = () => {
            let rankingsListHtml = allRankings.map(r => `
                <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg" data-ranking-id="${r.id}">
                    <span class="font-medium text-gray-800">${r.name}</span>
                    <div class="flex gap-2">
                        <button class="rename-ranking-btn text-cyan-600 hover:text-cyan-800 p-1" title="Renomear">
                            ${icons.edit}
                        </button>
                        <button class="delete-ranking-btn text-rose-600 hover:text-rose-800 p-1" title="Excluir">
                            ${icons.trash}
                        </button>
                    </div>
                </div>
            `).join('');

            showModal(
                "Gerenciar Rankings",
                ` <p class="mb-4 text-sm text-gray-600">
                        CUIDADO: Excluir um ranking √© permanente e remover√° todos os dados de pontos
                        daquela temporada. Os campeonatos vinculados N√ÉO ser√£o exclu√≠dos.
                    </p>
                    <div class="space-y-2 max-h-48 overflow-y-auto">${rankingsListHtml}</div>`,
                [
                    {
                        id: 'modal-cancel-btn',
                        text: 'Fechar',
                        className: 'w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-5 rounded-lg shadow-sm transition-all',
                        handler: hideModal
                    }
                ]
            );

            // Adiciona listeners aos bot√µes no modal
            document.querySelectorAll('.rename-ranking-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const rankingId = e.currentTarget.closest('[data-ranking-id]').dataset.rankingId;
                    handleRenameRanking(rankingId);
                });
            });

            document.querySelectorAll('.delete-ranking-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const rankingId = e.currentTarget.closest('[data-ranking-id]').dataset.rankingId;
                    handleDeleteRanking(rankingId);
                });
            });
        };

        const handleDeleteRanking = async (rankingId) => {
            const ranking = allRankings.find(r => r.id === rankingId);
            if (!ranking) return;

            // Pede confirma√ß√£o
            if (prompt(`Tem certeza? Isso √© irrevers√≠vel. Digite o nome do ranking para excluir: "${ranking.name}"`) !== ranking.name) {
                showModal("Cancelado", "A exclus√£o foi cancelada.");
                return;
            }

            // 1. Filtra a lista de rankings
            const newList = allRankings.filter(r => r.id !== rankingId);

            // 2. Define o ranking ativo para o primeiro da lista ou nulo
            const newActiveRankingId = (newList.length > 0) ? newList[0].id : null;

            try {
                const batch = writeBatch(db);

                // 3. Atualiza a lista de rankings no 'app_data'
                const rankingsDocRef = doc(db, 'users', appState.userId, 'app_data', 'rankings');
                batch.set(rankingsDocRef, { list: newList });

                // 4. Exclui a cole√ß√£o de jogadores desse ranking
                const playersDocRef = doc(db, 'users', appState.userId, 'rankings', rankingId);
                // NOTA: Isso N√ÉO exclui subcole√ß√µes no client-side.
                // Mas n√≥s estamos usando um doc 'players' que guarda um array, ent√£o podemos delet√°-lo.
                batch.delete(playersDocRef);

                await batch.commit();

                // 5. Atualiza o estado local
                appState.currentRankingId = newActiveRankingId;
                // O listener 'listenToRankingsList' vai recarregar a lista 'allRankings'
                // E 'listenToGlobalPlayers' (chamado abaixo) vai recarregar os players
                
                hideModal(); // Fecha o modal de gerenciamento
                
                // Recarrega os dados da view
                if (newActiveRankingId) {
                    listenToGlobalPlayers(); // Vai recarregar os players e chamar render()
                } else {
                    globalPlayers = [];
                    render(); // Renderiza a tela de ranking vazia
                }
                
                showModal("Sucesso", `Ranking "${ranking.name}" e todos os seus jogadores foram exclu√≠dos.`);

            } catch (error) {
                console.error("Erro ao excluir ranking:", error);
                showModal("Erro", "N√£o foi poss√≠vel excluir o ranking. " + error.message);
            }
        };

        const handleRenameRanking = async (rankingId) => {
            const ranking = allRankings.find(r => r.id === rankingId);
            if (!ranking) return;

            const newName = prompt("Digite o novo nome para o ranking:", ranking.name);
            if (!newName || newName.trim() === '' || newName.trim() === ranking.name) return;

            // Atualiza o nome na lista local
            const newList = allRankings.map(r => 
                r.id === rankingId ? { ...r, name: newName.trim() } : r
            );

            try {
                // Salva a lista inteira atualizada no 'app_data'
                await setDoc(doc(db, 'users', appState.userId, 'app_data', 'rankings'), { list: newList });
                
                // O listener 'listenToRankingsList' vai atualizar a UI.
                // Atualiza o modal de gerenciamento se estiver aberto
                hideModal();
                renderRankingManagementModal();
                showModal("Sucesso", "Ranking renomeado.");

            } catch (error)
 {
                console.error("Erro ao renomear ranking:", error);
                showModal("Erro", "N√£o foi poss√≠vel renomear o ranking.");
            }
        };

        // =================================================================
        // === MUDAN√áA (REQUEST 4): Fun√ß√£o para Gerar PDF do Ranking
        // =================================================================
        const handlePrintRankingPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const currentRanking = allRankings.find(r => r.id === appState.currentRankingId);
            const title = currentRanking ? currentRanking.name : "Ranking Geral";
            const date = new Date().toLocaleDateString();

            doc.setFontSize(18);
            doc.text(`üéæ ${title}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Gerado em: ${date}`, 14, 28);

            const sortedPlayers = [...globalPlayers].sort((a, b) => b.points - a.points);
            
            const tableData = sortedPlayers.map((player, index) => [
                `${index + 1}¬∫`,
                player.name,
                player.points || 0,
                player.goldWins || 0,
                player.silverWins || 0,
                player.coveiroWins || 0
            ]);

            doc.autoTable({
                startY: 35,
                head: [['Pos.', 'Jogador', 'Pontos', 'Ouro ü•á', 'Prata ü•à', 'Coveiro üëª']],
                body: tableData,
                theme: 'striped',
                headStyles: {
                    fillColor: [8, 145, 178] // 'Cor Mar' (cyan-600)
                },
                styles: {
                    fontSize: 10
                },
                columnStyles: {
                    2: { halign: 'center' },
                    3: { halign: 'center' },
                    4: { halign: 'center' },
                    5: { halign: 'center' }
                }
            });

            doc.save(`Ranking_${currentRanking.id}_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        /* =============================================================================
           Fun√ß√£o Utilit√°ria (Aplica√ß√£o de Pontos de Ranking)
           ============================================================================= */

        /**
         * Aplica (ou reverte) os pontos de um campeonato no Ranking Global.
         * Esta √© uma transa√ß√£o complexa para garantir consist√™ncia.
         * @param {string} rankingId - O ID do ranking a ser modificado.
         * @param {object} pointsDiff - Um objeto { 'playerId': { points: X, goldWins: X, ... } }
         */
        const applyRankingDiff = async (rankingId, pointsDiff) => {
            if (!rankingId) {
                throw new Error("ID do Ranking n√£o fornecido para aplicar os pontos.");
            }
            // A "cole√ß√£o" de rankings agora √© um documento por ranking
            const rankingDocRef = doc(db, 'users', appState.userId, 'rankings', rankingId);

            try {
                await runTransaction(db, async (transaction) => {
                    const rankingDoc = await transaction.get(rankingDocRef);
                    
                    let currentPlayers = [];
                    if (rankingDoc.exists()) {
                        // O documento 'players' agora √© a pr√≥pria lista
                        currentPlayers = rankingDoc.data().players || [];
                    }

                    // Converte array para Map para f√°cil acesso
                    const playerMap = new Map(currentPlayers.map(p => [p.id, p]));

                    // Aplica as diferen√ßas
                    for (const playerId in pointsDiff) {
                        const diff = pointsDiff[playerId];
                        const currentPlayer = playerMap.get(playerId) || { id: playerId, name: diff.name, points: 0, goldWins: 0, silverWins: 0, coveiroWins: 0 };
                        
                        // Atualiza o nome, caso tenha mudado
                        if (diff.name) {
                            currentPlayer.name = diff.name;
                        }

                        // Aplica a diferen√ßa
                        currentPlayer.points = (currentPlayer.points || 0) + (diff.points || 0);
                        currentPlayer.goldWins = (currentPlayer.goldWins || 0) + (diff.goldWins || 0);
                        currentPlayer.silverWins = (currentPlayer.silverWins || 0) + (diff.silverWins || 0);
                        currentPlayer.coveiroWins = (currentPlayer.coveiroWins || 0) + (diff.coveiroWins || 0);
                        
                        // Garante que n√£o fiquem pontos negativos
                        currentPlayer.points = Math.max(0, currentPlayer.points);
                        currentPlayer.goldWins = Math.max(0, currentPlayer.goldWins);
                        currentPlayer.silverWins = Math.max(0, currentPlayer.silverWins);
                        currentPlayer.coveiroWins = Math.max(0, currentPlayer.coveiroWins);

                        playerMap.set(playerId, currentPlayer);
                    }

                    // Converte o Map de volta para um array
                    const updatedPlayers = Array.from(playerMap.values());
                    
                    // Salva a lista de jogadores atualizada
                    transaction.set(rankingDocRef, { players: updatedPlayers });
                });
                console.log("Transa√ß√£o de pontos de ranking conclu√≠da com sucesso.");
            } catch (error) {
                console.error("Erro na transa√ß√£o de pontos de ranking: ", error);
                throw new Error("Falha ao atualizar o ranking global. " + error.message);
            }
        };

        /* =============================================================================
           Fun√ß√µes Utilit√°rias (C√°lculos de Grupos e Chaves)
           ============================================================================= */

        /**
         * NOVO HELPER (Refatora√ß√£o Bye)
         * Ordena as duplas pela for√ßa (gamesWon) e desempata por sorteio.
         * @param {Array} pairs - A lista de duplas (com { id, name, players })
         * @returns {Array} - A lista de duplas ordenada e desempatada.
         */
        const sortPairsWithTiebreaking = (pairs) => {
            // 1. Calcula a "for√ßa" (gamesWon) de cada dupla
            for (const pair of pairs) {
                // O objeto 'pair' j√° tem os players com 'gamesWon' da fase de grupos
                pair.strength = pair.players.reduce((total, p) => total + p.gamesWon, 0);
            }

            // 2. Agrupa duplas por for√ßa
            const groups = new Map();
            for (const pair of pairs) {
                if (!groups.has(pair.strength)) {
                    groups.set(pair.strength, []);
                }
                groups.get(pair.strength).push(pair);
            }

            // 3. Ordena as chaves do grupo (pontua√ß√µes) em ordem decrescente
            const sortedStrengths = [...groups.keys()].sort((a, b) => b - a);

            // 4. Monta a lista final
            const finalSortedList = [];
            for (const strength of sortedStrengths) {
                const tiedPairs = groups.get(strength);
                
                // 5. Se houver empate (mais de 1 dupla com a mesma for√ßa), SORTEIA.
                if (tiedPairs.length > 1) {
                    tiedPairs.sort(() => 0.5 - Math.random());
                }
                
                // Adiciona as duplas (sorteadas ou n√£o) √† lista final
                finalSortedList.push(...tiedPairs);
            }

            return finalSortedList;
        };
        
        /**
         * NOVA FUN√á√ÉO DE CHAVEAMENTO (Refatora√ß√£o Bye)
         * Substitui 'createBracket'.
         * Cria uma chave semeada, dando Byes aos melhores seeds.
         * @param {Array} sortedPairs - A lista de duplas J√Å ORDENADA (pelo sortPairsWithTiebreaking).
         * @returns {Array} - A lista de partidas (bracket)
         */
        const createSeededBracket = (sortedPairs) => {
            const numPairs = sortedPairs.length;
            if (numPairs < 2) return [];

            // 1. Descobrir o tamanho da chave (pr√≥xima pot√™ncia de 2)
            const bracketSize = Math.pow(2, Math.ceil(Math.log2(numPairs)));
            const numByes = bracketSize - numPairs;
            const numTeamsInR1 = numPairs - numByes; // Times que JOGAM R1

            // 2. Separar as duplas
            // Os melhores seeds (ex: 5 times -> 3 byes)
            const teamsWithByes = sortedPairs.slice(0, numByes);
            // Os piores seeds (ex: 5 times -> 2 jogam)
            const teamsToPlayR1 = sortedPairs.slice(numByes);

            const bracket = [];
            const numRounds = Math.log2(bracketSize); // ex: 8 times = 3 rodadas
            let matchesForNextRound = []; // Armazena os IDs das partidas que avan√ßam
            let matchIdCounter = 1;

            // 3. Gerar a Rodada 1 ("Play-in")
            // Embaralha os times que v√£o jogar para a R1 ser aleat√≥ria
            const shuffledTeamsToPlayR1 = [...teamsToPlayR1].sort(() => 0.5 - Math.random());
            
            for (let i = 0; i < numTeamsInR1; i += 2) {
                const matchId = `M${matchIdCounter++}`;
                
                const match = {
                    id: matchId,
                    round: 1,
                    pairs: [shuffledTeamsToPlayR1[i], shuffledTeamsToPlayR1[i + 1]],
                    score: [null, null],
                    winner: null,
                    nextMatchId: null, // Ser√° definido na R2
                    nextMatchSlot: null
                };
                bracket.push(match);
                matchesForNextRound.push(match.id); // Vencedor avan√ßa
            }
            
            // 4. Juntar os times que tiveram 'Bye'
            // Os times com Bye s√£o tratados como "vencedores" de uma rodada 0
            let teamsForThisRound = [
                ...teamsWithByes.map(team => ({ type: 'team', data: team })), // Times que tiveram Bye
                ...matchesForNextRound.map(matchId => ({ type: 'winner', fromMatchId: matchId })) // Vagas para vencedores da R1
            ];

            // 5. Gerar as rodadas seguintes (R2 em diante)
            for (let r = 2; r <= numRounds; r++) {
                // Embaralha as vagas da R2 (times com bye + vencedores R1)
                if (r === 2) {
                    teamsForThisRound.sort(() => 0.5 - Math.random());
                }

                const matchesInThisRound = [];
                let winnersForNextRound = [];

                for (let i = 0; i < teamsForThisRound.length; i += 2) {
                    const matchId = `M${matchIdCounter++}`;
                    
                    const pair1Slot = teamsForThisRound[i];
                    const pair2Slot = teamsForThisRound[i + 1];

                    const match = {
                        id: matchId,
                        round: r,
                        pairs: [null, null],
                        score: [null, null],
                        winner: null,
                        nextMatchId: null, // Ser√° definido na pr√≥xima itera√ß√£o (se houver)
                        nextMatchSlot: null
                    };

                    // Preenche o Slot 1
                    if (pair1Slot.type === 'team') {
                        match.pairs[0] = pair1Slot.data;
                    } else { // type === 'winner'
                        const prevMatch = bracket.find(m => m.id === pair1Slot.fromMatchId);
                        if (prevMatch) {
                            prevMatch.nextMatchId = match.id;
                            prevMatch.nextMatchSlot = 0;
                        }
                    }
                    
                    // Preenche o Slot 2
                    if (pair2Slot.type === 'team') {
                        match.pairs[1] = pair2Slot.data;
                    } else { // type === 'winner'
                        const prevMatch = bracket.find(m => m.id === pair2Slot.fromMatchId);
                        if (prevMatch) {
                            prevMatch.nextMatchId = match.id;
                            prevMatch.nextMatchSlot = 1;
                        }
                    }

                    bracket.push(match);
                    matchesInThisRound.push(match);
                    winnersForNextRound.push({ type: 'winner', fromMatchId: match.id });
                }
                teamsForThisRound = winnersForNextRound;
            }

            return bracket;
        };

        // Calcula o ranking DENTRO de um grupo
        const getRankings = (group) => {
            const players = group.players.map(p => ({ ...p, gamesWon: 0, gamesLost: 0 }));
            
            group.matches.forEach(match => {
                const [p1, p2, p3, p4] = match.p;
                const [s1, s2] = match.score;

                if (s1 === null || s2 === null) return; // Ignora jogos n√£o finalizados

                // Encontra os jogadores no array 'players'
                const player1 = players.find(p => p.id === p1);
                const player2 = players.find(p => p.id === p2);
                const player3 = players.find(p => p.id === p3);
                const player4 = players.find(p => p.id === p4);

                if (player1) { player1.gamesWon += s1; player1.gamesLost += s2; }
                if (player2) { player2.gamesWon += s1; player2.gamesLost += s2; }
                if (player3) { player3.gamesWon += s2; player3.gamesLost += s1; }
                if (player4) { player4.gamesWon += s2; player4.gamesLost += s1; }
            });

            // Sorteia por 'gamesWon'. Em caso de empate, sorteia aleatoriamente.
            players.sort((a, b) => {
                if (a.gamesWon !== b.gamesWon) {
                    return b.gamesWon - a.gamesWon; // Mais games ganhos primeiro
                }
                return 0.5 - Math.random(); // Sorteio
            });

            return players; // [1¬∫, 2¬∫, 3¬∫, 4¬∫]
        };

        // Finaliza os grupos e GERA O MATA-MATA (ATUALIZADO)
        const handleFinalizeGroups = async () => {
            if (!confirm("Finalizar Fase de Grupos? Isso ir√° gerar as chaves Ouro e Prata e bloquear os grupos.")) return;

            let goldSeriesPairs = [];
            let silverSeriesPairs = [];

            // 1. Gera as duplas Ouro/Prata a partir dos rankings
            activeChampionship.groups.forEach(group => {
                const rankings = getRankings(group); // [p1, p2, p3, p4]

                // Adiciona 'gamesWon' aos players (necess√°rio para o 'sortPairsWithTiebreaking')
                const goldPair = {
                    id: `${rankings[0].id}_${rankings[1].id}`,
                    name: `${rankings[0].name} / ${rankings[1].name}`,
                    players: [rankings[0], rankings[1]] 
                };
                goldSeriesPairs.push(goldPair);

                const silverPair = {
                    id: `${rankings[2].id}_${rankings[3].id}`,
                    name: `${rankings[2].name} / ${rankings[3].name}`,
                    players: [rankings[2], rankings[3]]
                };
                silverSeriesPairs.push(silverPair);
            });

            // 2. ORDENA as duplas (com desempate por sorteio)
            // (Esta √© a Fase 1 da Refatora√ß√£o 'Bye')
            const sortedGoldPairs = sortPairsWithTiebreaking(goldSeriesPairs);
            const sortedSilverPairs = sortPairsWithTiebreaking(silverSeriesPairs);

            try {
                // 3. GERA as chaves (elas agora suportam 'Byes' e 'Seeding')
                // (Esta √© a Fase 2 da Refatora√ß√£o 'Bye')
                const goldBracket = createSeededBracket(sortedGoldPairs);
                const silverBracket = createSeededBracket(sortedSilverPairs);

                const newChampData = {
                    ...activeChampionship,
                    status: 'knockout',
                    goldBracket: goldBracket,
                    silverBracket: silverBracket,
                };

                await saveActiveChampionship(newChampData);

                // Atualiza o doc 'resumo'
                const champRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                await setDoc(champRef, { status: 'knockout' }, { merge: true });

            } catch (error) {
                console.error("Erro ao finalizar grupos:", error);
                showModal("Erro", "Ocorreu um erro ao gerar as chaves." + error.message);
            }
        };

        // Calcula o total de games do TORNEIO (Grupos + Mata-Mata) (ATUALIZADO)
        const getGlobalTournamentStats = (champData) => {
            const playerStats = {};

            // 1. Inicializa todos os jogadores do torneio
            champData.players.forEach(p => {
                playerStats[p.id] = { id: p.id, name: p.name, gamesWon: 0 };
            });

            // 2. Soma os games da Fase de Grupos
            if (champData.groups) {
                champData.groups.forEach(group => {
                    group.matches.forEach(match => {
                        const [p1, p2, p3, p4] = match.p;
                        const [s1, s2] = match.score;

                        if (s1 !== null && !isNaN(s1)) {
                            if (playerStats[p1]) playerStats[p1].gamesWon += s1;
                            if (playerStats[p2]) playerStats[p2].gamesWon += s1;
                        }
                        if (s2 !== null && !isNaN(s2)) {
                            if (playerStats[p3]) playerStats[p3].gamesWon += s2;
                            if (playerStats[p4]) playerStats[p4].gamesWon += s2;
                        }
                    });
                });
            }

            // === IN√çCIO DA NOVA L√ìGICA (Refatora√ß√£o Bye) ===

            // 3. Define a pontua√ß√£o do Bye e prepara os rastreadores
            const GAME_POINTS_FOR_BYE = 6;
            const playersWhoPlayedR1 = new Set();
            const playersWhoPlayedR2 = new Set();

            const allKnockoutMatches = (champData.goldBracket || []).concat(champData.silverBracket || []);
            
            // 4. Soma os games do Mata-Mata E identifica quem jogou R1 e R2
            allKnockoutMatches.forEach(match => {
                const [pair1, pair2] = match.pairs;
                const [s0, s1] = match.score;

                // A. Identifica quem jogou em qual rodada
                if (match.round === 1) {
                    if (pair1?.players) pair1.players.forEach(p => playersWhoPlayedR1.add(p.id));
                    if (pair2?.players) pair2.players.forEach(p => playersWhoPlayedR1.add(p.id));
                }
                if (match.round === 2) {
                    if (pair1?.players) pair1.players.forEach(p => playersWhoPlayedR2.add(p.id));
                    if (pair2?.players) pair2.players.forEach(p => playersWhoPlayedR2.add(p.id));
                }

                // B. Soma os games (l√≥gica existente)
                if (s0 !== null && !isNaN(s0) && pair1 && pair1.players) {
                    pair1.players.forEach(player => {
                        if (playerStats[player.id]) {
                            playerStats[player.id].gamesWon += s0;
                        }
                    });
                }

                if (s1 !== null && !isNaN(s1) && pair2 && pair2.players) {
                    pair2.players.forEach(player => {
                        if (playerStats[player.id]) {
                            playerStats[player.id].gamesWon += s1;
                        }
                    });
                }
            });

            // 5. ADICIONA PONTOS DE BYE (NOVO)
            // Para cada jogador no torneio:
            champData.players.forEach(player => {
                // Se o jogador jogou na R2, mas N√ÉO jogou na R1... ele teve um Bye.
                if (playersWhoPlayedR2.has(player.id) && !playersWhoPlayedR1.has(player.id)) {
                    
                    // Adiciona os 6 games
                    if (playerStats[player.id]) {
                        playerStats[player.id].gamesWon += GAME_POINTS_FOR_BYE;
                    }
                }
            });

            // === FIM DA NOVA L√ìGICA ===

            // 6. Retorna a lista ordenada por games (do menor para o maior)
            return Object.values(playerStats).sort((a, b) => a.gamesWon - b.gamesWon);
        };/* =============================================================================
           TELA 3: Visualiza√ß√£o de Campeonato (Core)
           ============================================================================= */

        const renderChampionshipView = () => {
            if (!activeChampionship) {
                mainContent.innerHTML = `<p class="text-gray-500 text-center py-10">Carregando dados do campeonato...</p>`;
                return;
            }

            const champ = activeChampionship;
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);
            const currentRanking = allRankings.find(r => r.id === champSummary?.rankingId);

            let statusColor = 'text-yellow-600';
            let statusText = 'Em andamento';
            if (champ.status === 'registration') { statusColor = 'text-cyan-600'; statusText = 'Inscri√ß√µes Abertas'; }
            if (champ.status === 'groups') { statusColor = 'text-blue-600'; statusText = 'Fase de Grupos'; }
            if (champ.status === 'knockout') { statusColor = 'text-orange-600'; statusText = 'Mata-Mata ‚öîÔ∏è'; }
            if (champ.status === 'finished') { statusColor = 'text-emerald-600'; statusText = 'Finalizado üèÖ'; }
            
            // Bot√µes de Admin (Cabe√ßalho do Campeonato)
            let adminButtons = '';
            if (appState.isAdmin && champ.status !== 'finished') {
                if (champ.status === 'registration') {
                    adminButtons += `<button id="generate-groups-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2">${icons.swords} Gerar Grupos</button>`;
                }
                if (champ.status === 'groups') {
                    // Verifica se todos os jogos dos grupos foram preenchidos
                    const allGamesPlayed = champ.groups.every(g => g.matches.every(m => m.score[0] !== null && m.score[1] !== null));
                    adminButtons += `<button id="finalize-groups-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2" ${!allGamesPlayed ? 'disabled' : ''}>${icons.trophy} Gerar Mata-Mata</button>`;
                }
                if (champ.status === 'knockout') {
                    adminButtons += `<button id="finalize-champ-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2">${icons.award} Finalizar Campeonato</button>`;
                }
            } else if (appState.isAdmin && champ.status === 'finished') {
                // =================================================================
                // === MUDAN√áA (REQUEST 2): Bot√£o de Reverter Pontos
                // =================================================================
                adminButtons += `<button id="revert-points-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2" title="Reverter pontos do ranking global">${icons.arrowLeft} Reverter Pontos</button>`;
            }

            // Bot√£o "Gerar PDF do Campeonato"
            adminButtons += `
                <button id="print-champ-pdf-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2" title="Gerar PDF do Campeonato">
                    ${icons.fileDown}
                </button>
            `;

            // Bot√£o "Tel√£o"
            const telaoUrl = `${window.location.origin}${window.location.pathname}?telao=true&champ=${appState.currentChampionshipId}`;
            adminButtons += `
                <a href="${telaoUrl}" target="_blank" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2" title="Abrir Modo Tel√£o">
                    ${icons.tv}
                </a>
            `;

            // Conte√∫do principal (Inscri√ß√µes, Grupos, Mata-Mata)
            let contentHtml = '';
            if (champ.status === 'registration') {
                contentHtml = renderRegistrationTab(champ.players);
            } else if (champ.status === 'groups') {
                contentHtml = renderGroupsTab(champ.groups);
            } else if (champ.status === 'knockout' || champ.status === 'finished') {
                contentHtml = renderKnockoutTab(champ.goldBracket, champ.silverBracket, champSummary);
            }

            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8 border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                            <div>
                                <h2 class="text-3xl font-bold text-cyan-600">${champSummary?.name || 'Campeonato'}</h2>
                                <p class="text-lg font-medium ${statusColor}">${statusText}</p>
                                ${currentRanking ? `<p class="text-sm text-orange-600 font-medium">üèÜ Vinculado ao: ${currentRanking.name}</p>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-2 justify-start sm:justify-end">
                                ${adminButtons}
                            </div>
                        </div>
                    </div>
                    ${contentHtml}
                </div>
            `;

            // Adiciona listeners
            addChampionshipViewListeners(champ.status);
        };

        // Renderiza a Aba de Inscri√ß√µes
        const renderRegistrationTab = (players) => {
            const playersListHtml = players.length === 0
                ? `<p class="text-gray-500 text-center py-4">Nenhum jogador inscrito.</p>`
                : players.map(player => `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg animate-fade-in-sm">
                        <span class="text-gray-800 font-medium">${player.name}</span>
                        ${appState.isAdmin ? `<button class="remove-player-btn text-rose-600 hover:text-rose-700 p-1" data-id="${player.id}">${icons.trash}</button>` : ''}
                    </div>
                `).join('');

            // =================================================================
            // === MUDAN√áA (REQUEST 1): Sele√ß√£o de Jogadores do Ranking
            // =================================================================
            const globalPlayersOptions = globalPlayers
                .filter(gp => !players.find(p => p.id === gp.id)) // Filtra quem j√° est√° inscrito
                .map(gp => `<option value="${gp.id}">${gp.name}</option>`)
                .join('');
            
            const addPlayerFormHtml = appState.isAdmin ? `
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 mb-8 border border-gray-200">
                    <h3 class="text-2xl font-bold text-cyan-600 mb-4">Inscrever Jogadores</h3>
                    
                    <form id="add-player-form-global" class="mb-6">
                        <label for="global-player-select" class="block text-sm font-medium text-gray-700 mb-1">Inscri√ß√£o R√°pida (do Ranking)</label>
                        <div class="flex gap-2">
                            <select id="global-player-select" class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="">Selecione um jogador...</option>
                                ${globalPlayersOptions}
                            </select>
                            <button type="submit" class="flex-shrink-0 bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-3 rounded-lg shadow-md transition-all">
                                ${icons.plus}
                            </button>
                        </div>
                    </form>
                    
                    <form id="add-player-form-manual">
                        <label for="player-name-input" class="block text-sm font-medium text-gray-700 mb-1">Inscri√ß√£o Manual (Novo Jogador)</label>
                        <div class="flex gap-2">
                            <input
                                type="text"
                                id="player-name-input"
                                placeholder="Nome do novo jogador"
                                class="w-full bg-gray-50 border border-gray-300 text-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                            />
                            <button type="submit" class="flex-shrink-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-lg shadow-sm transition-all">
                                ${icons.plus}
                            </button>
                        </div>
                    </form>
                </div>
            ` : '';

            return `
                ${addPlayerFormHtml}
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 lg:p-8 border border-gray-200">
                    <h3 class="text-2xl font-bold mb-5 text-cyan-600 flex items-center gap-3">
                        ${icons.users} Lista de Inscritos (${players.length})
                    </h3>
                    <div class="max-h-[60vh] overflow-y-auto pr-2 space-y-2">
                        ${playersListHtml}
                    </div>
                </div>
            `;
        };

        // Renderiza a Aba de Fase de Grupos
        const renderGroupsTab = (groups) => {
            if (groups.length === 0) return `<p class="text-gray-500 text-center py-10">Grupos ainda n√£o gerados.</p>`;

            const groupsHtml = groups.map((group, index) => {
                const playersHtml = group.players.map(p => `
                    <div class="flex items-center gap-2 p-2 bg-amber-50 rounded-lg">
                        <span class="font-bold text-cyan-600">${p.name}</span>
                    </div>
                `).join('');

                const matchesHtml = group.matches.map((match, m_idx) => {
                    const [p1_id, p2_id, p3_id, p4_id] = match.p;
                    const p1 = group.players.find(p => p.id === p1_id)?.name.split(' ')[0];
                    const p2 = group.players.find(p => p.id === p2_id)?.name.split(' ')[0];
                    const p3 = group.players.find(p => p.id === p3_id)?.name.split(' ')[0];
                    const p4 = group.players.find(p => p.id === p4_id)?.name.split(' ')[0];

                    const [s1, s2] = match.score;

                    const inputClass = "w-12 sm:w-16 bg-gray-50 border border-gray-300 text-center text-lg font-bold rounded-md py-1 px-2 focus:outline-none focus:ring-2 focus:ring-cyan-500";
                    const scoreInputs = appState.isAdmin ? `
                        <input type="number" min="0" max="99" class="score-input ${inputClass}" data-group="${index}" data-match="${m_idx}" data-team="0" value="${s1 ?? ''}" ${s1 !== null ? 'readonly' : ''}>
                        <input type="number" min="0" max="99" class="score-input ${inputClass}" data-group="${index}" data-match="${m_idx}" data-team="1" value="${s2 ?? ''}" ${s2 !== null ? 'readonly' : ''}>
                    ` : `
                        <span class="w-12 sm:w-16 text-center text-lg font-bold p-1">${s1 ?? '-'}</span>
                        <span class="w-12 sm:w-16 text-center text-lg font-bold p-1">${s2 ?? '-'}</span>
                    `;

                    return `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex flex-col text-right pr-2">
                            <span class="text-sm font-medium">${p1} / ${p2}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${scoreInputs}
                        </div>
                        <div class="flex flex-col text-left pl-2">
                            <span class="text-sm font-medium">${p3} / ${p4}</span>
                        </div>
                    </div>
                    `;
                }).join('');

                const rankings = getRankings(group);
                const rankingsHtml = rankings.map((p, r_idx) => `
                    <li class="flex justify-between items-center text-sm ${r_idx === 0 || r_idx === 1 ? 'text-emerald-600 font-bold' : 'text-gray-600'}">
                        <span>${r_idx + 1}¬∫ - ${p.name}</span>
                        <span>${p.gamesWon} games</span>
                    </li>
                `).join('');

                return `
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 border border-gray-200">
                    <h4 class="text-2xl font-bold mb-4 text-cyan-600">Grupo ${index + 1}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div>
                            <h5 class="text-lg font-semibold mb-3 text-gray-700">Jogos</h5>
                            <div class="space-y-2">${matchesHtml}</div>
                        </div>

                        <div>
                            <h5 class="text-lg font-semibold mb-3 text-gray-700">Ranking do Grupo</h5>
                            <div class="p-4 bg-amber-50 rounded-lg">
                                <ul class="space-y-2">
                                    ${rankingsHtml}
                                </ul>
                            </div>
                        </div>

                    </div>
                </div>
                `;
            }).join('');

            return `<div class="space-y-6">${groupsHtml}</div>`;
        };

        // Renderiza a Aba de Mata-Mata
        const renderKnockoutTab = (goldBracket, silverBracket, champSummary) => {
            const goldWinnerHtml = champSummary?.winnerGold 
                ? `<div class="text-center py-6 bg-yellow-50 rounded-lg border border-yellow-200">
                     <span class="block text-xl font-bold text-yellow-600">ü•á CAMPE√ïES S√âRIE OURO ü•á</span>
                     <span class="block text-2xl font-bold text-gray-800">${champSummary.winnerGold}</span>
                   </div>`
                : '';
            
            const silverWinnerHtml = champSummary?.winnerSilver
                ? `<div class="text-center py-6 bg-gray-50 rounded-lg border border-gray-200">
                     <span class="block text-xl font-bold text-gray-600">ü•à CAMPE√ïES S√âRIE PRATA ü•à</span>
                     <span class="block text-2xl font-bold text-gray-800">${champSummary.winnerSilver}</span>
                   </div>`
                : '';
            
            // =================================================================
            // === MUDAN√áA (REQUEST 5): Bot√£o de Reabrir Campeonato
            // =================================================================
            const reopenButtonHtml = (appState.isAdmin && champSummary?.status === 'finished') ? `
                <button id="reopen-champ-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-all flex items-center gap-2 text-sm">
                    ${icons.edit} Reabrir Mata-Mata
                </button>
            ` : '';
            
            return `
                ${goldWinnerHtml ? `<div class="mb-6 animate-fade-in">${goldWinnerHtml}</div>` : ''}
                ${silverWinnerHtml ? `<div class="mb-6 animate-fade-in">${silverWinnerHtml}</div>` : ''}

                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-6 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-yellow-500">S√©rie Ouro ü•á</h3>
                        ${reopenButtonHtml}
                    </div>
                    ${renderBracket(goldBracket, 'gold')}
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 border border-gray-200">
                    <h3 class="text-2xl font-bold mb-4 text-gray-500">S√©rie Prata ü•à</h3>
                    ${renderBracket(silverBracket, 'silver')}
                </div>
            `;
        };
        
        // Renderiza uma chave de mata-mata
        const renderBracket = (bracket, bracketType) => {
            if (!bracket || bracket.length === 0) return '<p class="text-gray-500">Chave n√£o gerada.</p>';

            const maxRound = Math.max(...bracket.map(m => m.round));
            const roundsHtml = [];

            for (let r = 1; r <= maxRound; r++) {
                const matches = bracket.filter(m => m.round === r);
                // Ordena as partidas pela ordem visual (usando o ID da pr√≥xima partida)
                matches.sort((a, b) => {
                    const nextA = bracket.find(m => m.id === a.nextMatchId);
                    const nextB = bracket.find(m => m.id === b.nextMatchId);
                    
                    if (!nextA || !nextB) return 0; // Final
                    if (nextA.id !== nextB.id) {
                        // Compara os IDs das pr√≥ximas partidas (ex: M5 vem antes de M6)
                        return parseInt(nextA.id.slice(1)) - parseInt(nextB.id.slice(1));
                    }
                    // Se for a mesma pr√≥xima partida, compara os slots
                    return a.nextMatchSlot - b.nextMatchSlot;
                });

                const matchesHtml = matches.map(match => renderBracketMatch(match, bracketType)).join('');
                roundsHtml.push(`
                    <div class="flex flex-col justify-around gap-6 py-4">
                        <h4 class="text-center font-bold text-cyan-600 mb-2">
                            ${(r === maxRound) ? 'Final' : `Rodada ${r}`}
                        </h4>
                        <div class="space-y-6">${matchesHtml}</div>
                    </div>
                `);
            }

            return `<div class="grid grid-cols-1 md:grid-cols-${maxRound} gap-4 overflow-x-auto">${roundsHtml.join('')}</div>`;
        };

        // Renderiza uma partida do mata-mata (ATUALIZADO PARA BYE)
        const renderBracketMatch = (match, bracketType) => {
            const [pair1, pair2] = match.pairs;
            const [s1, s2] = match.score;

            const isFinished = match.winner !== null;
            const isEditable = appState.isAdmin && activeChampionship.status !== 'finished';
            
            // L√≥gica para 'BYE'
            const p1_isBye = pair1 && pair1.id === 'BYE';
            const p2_isBye = pair2 && pair2.id === 'BYE';
            
            // Se for um 'bye', o jogo j√° nasce finalizado
            const isByeMatch = (p1_isBye || p2_isBye);
            
            // Helper para renderizar uma dupla
            const renderPair = (pair, score, isWinner, isBye) => {
                let name = 'Aguardando...';
                let id = null;
                if (pair) {
                    name = pair.name;
                    id = pair.id;
                }
                if (isBye) name = '--- BYE ---'; // Nome do Bye

                const scoreClass = "w-10 sm:w-12 bg-gray-50 border border-gray-300 text-center text-lg font-bold rounded-md py-1 px-1 focus:outline-none focus:ring-2 focus:ring-cyan-500";
                
                let scoreInput;
                // N√£o mostra input se: 
                // 1. N√£o for admin
                // 2. Jogo estiver finalizado
                // 3. For um Bye
                // 4. Campeonato estiver finalizado
                if (!isEditable || isFinished || isByeMatch) {
                    scoreInput = `<span class="w-10 sm:w-12 text-center text-lg font-bold p-1">${score ?? ''}</span>`;
                } else {
                    scoreInput = `<input type="number" min="0" max="99" class="knockout-score-input ${scoreClass}" data-match-id="${match.id}" data-bracket="${bracketType}" data-pair-id="${id}" value="${score ?? ''}">`;
                }
                
                let winnerClass = '';
                if (isFinished && isWinner) winnerClass = 'font-bold text-emerald-600';
                if (isFinished && !isWinner && !isBye) winnerClass = 'font-normal text-gray-500 line-through';
                if (isBye) winnerClass = 'font-normal text-gray-400 italic';

                return `
                <div class="flex justify-between items-center ${winnerClass}">
                    <span class="truncate pr-2" title="${name}">${name}</span>
                    ${scoreInput}
                </div>
                `;
            };

            const p1_winner = isFinished && match.winner?.id === pair1?.id;
            const p2_winner = isFinished && match.winner?.id === pair2?.id;

            return `
            <div class="bg-white p-3 rounded-lg shadow-md border border-gray-200 animate-fade-in-sm min-h-[100px] flex flex-col justify-center">
                <div class="space-y-2">
                    ${renderPair(pair1, s1, p1_winner, p1_isBye)}
                    ${renderPair(pair2, s2, p2_winner, p2_isBye)}
                </div>
            </div>
            `;
        };
        
        // Adiciona Listeners da Tela de Campeonato
        const addChampionshipViewListeners = (status) => {
            if (appState.isAdmin) {
                // Aba Inscri√ß√£o
                if (status === 'registration') {
                    document.getElementById('add-player-form-global')?.addEventListener('submit', handleAddPlayerFromGlobal);
                    document.getElementById('add-player-form-manual')?.addEventListener('submit', handleAddPlayerManually);
                    document.querySelectorAll('.remove-player-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleRemovePlayer(btn.dataset.id));
                    });
                    document.getElementById('generate-groups-btn')?.addEventListener('click', handleGenerateGroups);
                }
                // Aba Grupos
                if (status === 'groups') {
                    document.querySelectorAll('.score-input').forEach(input => {
                        input.addEventListener('change', handleGroupScoreChange);
                    });
                    document.getElementById('finalize-groups-btn')?.addEventListener('click', handleFinalizeGroups);
                }
                // Aba Mata-Mata
                if (status === 'knockout') {
                    document.querySelectorAll('.knockout-score-input').forEach(input => {
                        input.addEventListener('change', handleKnockoutScoreChange);
                    });
                    document.getElementById('finalize-champ-btn')?.addEventListener('click', handleFinalizeChampionship);
                }
                // Aba Finalizado
                if (status === 'finished') {
                    document.getElementById('revert-points-btn')?.addEventListener('click', handleRevertPoints);
                    document.getElementById('reopen-champ-btn')?.addEventListener('click', handleReopenChampionship);
                }
            }
            
            // Bot√£o de Gerar PDF (sempre dispon√≠vel)
            document.getElementById('print-champ-pdf-btn')?.addEventListener('click', handlePrintChampionshipPDF);
        };
        
        /* =============================================================================
           TELA 4: Tel√£o (View-Only)
           ============================================================================= */
        
        const renderTelaoView = () => {
            if (!activeChampionship) {
                mainContent.innerHTML = `<p class="text-gray-500 text-center py-10">Carregando dados do campeonato...</p>`;
                return;
            }

            const champ = activeChampionship;
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);

            let statusText = '';
            if (champ.status === 'registration') statusText = 'Inscri√ß√µes Abertas';
            if (champ.status === 'groups') statusText = 'Fase de Grupos';
            if (champ.status === 'knockout') statusText = 'Mata-Mata ‚öîÔ∏è';
            if (champ.status === 'finished') statusText = 'Campeonato Finalizado üèÖ';

            let contentHtml = '';

            if (champ.status === 'groups') {
                // No Tel√£o, a Fase de Grupos mostra apenas os Rankings
                const groupsHtml = champ.groups.map((group, index) => {
                    const rankings = getRankings(group);
                    const rankingsHtml = rankings.map((p, r_idx) => `
                        <li class="flex justify-between items-center p-3 rounded-md
                            ${r_idx === 0 || r_idx === 1 ? 'bg-yellow-100 text-emerald-800 font-bold' : 'bg-gray-100 text-gray-700'}">
                            <span>${r_idx + 1}¬∫ - ${p.name}</span>
                            <span class="text-lg">${p.gamesWon} games</span>
                        </li>
                    `).join('');

                    return `
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                        <h4 class="text-3xl font-bold mb-5 text-cyan-600">Grupo ${index + 1}</h4>
                        <ul class="space-y-3">${rankingsHtml}</ul>
                    </div>
                    `;
                }).join('');
                contentHtml = `<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">${groupsHtml}</div>`;

            } else if (champ.status === 'knockout' || champ.status === 'finished') {
                // No Tel√£o, o Mata-Mata mostra as chaves
                const goldWinnerHtml = champSummary?.winnerGold 
                    ? `<div class="text-center py-8 bg-yellow-50 rounded-lg border-2 border-yellow-200">
                         <span class="block text-2xl font-bold text-yellow-600">ü•á CAMPE√ïES S√âRIE OURO ü•á</span>
                         <span class="block text-4xl font-bold text-gray-800 mt-2">${champSummary.winnerGold}</span>
                       </div>`
                    : '';
                
                const silverWinnerHtml = champSummary?.winnerSilver
                    ? `<div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-gray-200">
                         <span class="block text-2xl font-bold text-gray-600">ü•à CAMPE√ïES S√âRIE PRATA ü•à</span>
                         <span class="block text-4xl font-bold text-gray-800 mt-2">${champSummary.winnerSilver}</span>
                       </div>`
                    : '';

                contentHtml = `
                    ${goldWinnerHtml ? `<div class="mb-8 animate-fade-in">${goldWinnerHtml}</div>` : ''}
                    ${silverWinnerHtml ? `<div class="mb-8 animate-fade-in">${silverWinnerHtml}</div>` : ''}
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
                        <h3 class="text-4xl font-bold mb-6 text-yellow-500">S√©rie Ouro ü•á</h3>
                        ${renderBracket(champ.goldBracket, 'gold')}
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                        <h3 class="text-4xl font-bold mb-6 text-gray-500">S√©rie Prata ü•à</h3>
                        ${renderBracket(champ.silverBracket, 'silver')}
                    </div>
                `;
            } else {
                // Tel√£o para Inscri√ß√µes
                const playersListHtml = champ.players.length === 0
                    ? `<p class="text-gray-500 text-center py-4 text-xl">Nenhum jogador inscrito.</p>`
                    : champ.players.map(player => `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <span class="text-gray-800 font-medium text-xl">${player.name}</span>
                        </div>
                    `).join('');

                contentHtml = `
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                        <h3 class="text-4xl font-bold mb-6 text-cyan-600">
                            Inscritos (${champ.players.length})
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${playersListHtml}
                        </div>
                    </div>
                `;
            }
            
            mainContent.innerHTML = `
                <div class="animate-fade-in">
                    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-gray-200">
                        <h2 class="text-5xl font-bold text-cyan-600 text-center">${champSummary?.name || 'Campeonato'}</h2>
                        <p class="text-3xl font-medium text-center text-orange-600 mt-2">${statusText}</p>
                    </div>
                    ${contentHtml}
                </div>
            `;
            
            // O Tel√£o n√£o tem listeners de admin
        };


        /* =============================================================================
           A√ß√µes do Campeonato (Handlers)
           ============================================================================= */

        // Salva o objeto INTEIRO do campeonato (A√ß√£o Pesada)
        const saveActiveChampionship = async (data) => {
            if (!appState.isAdmin) return;
            const docRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId, 'data', 'main');
            try {
                // Sobrescreve o documento 'main' com os novos dados
                await setDoc(docRef, data);
            } catch (error) {
                console.error("Erro ao salvar dados do campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel salvar os dados. Tente novamente.");
            }
            // O listener onSnapshot vai atualizar a UI
        };

        // Adiciona jogador do Ranking
        const handleAddPlayerFromGlobal = (e) => {
            e.preventDefault();
            const select = document.getElementById('global-player-select');
            const playerId = select.value;
            if (!playerId) return;

            const player = globalPlayers.find(p => p.id === playerId);
            if (!player) return;

            // Evita duplicados (embora o <select> j√° deva fazer isso)
            if (activeChampionship.players.find(p => p.id === player.id)) {
                showModal("Erro", "Este jogador j√° est√° inscrito.");
                return;
            }

            const updatedPlayers = [...activeChampionship.players, { id: player.id, name: player.name }];
            saveActiveChampionship({ ...activeChampionship, players: updatedPlayers });
            
            select.value = ""; // Reseta o select
        };

        // Adiciona jogador Manualmente
        const handleAddPlayerManually = async (e) => {
            e.preventDefault();
            const input = document.getElementById('player-name-input');
            const name = input.value.trim();
            if (!name) return;

            // 1. Verifica se o jogador j√° existe no Ranking Global
            let existingPlayer = globalPlayers.find(p => p.name.toLowerCase() === name.toLowerCase());
            let playerId = existingPlayer ? existingPlayer.id : `manual_${Date.now()}`;
            
            // 2. Se n√£o existir, adiciona ao Ranking Global E ao campeonato
            if (!existingPlayer) {
                const newPlayer = { id: playerId, name: name, points: 0, goldWins: 0, silverWins: 0, coveiroWins: 0 };
                
                // Adiciona ao ranking global
                const rankingId = championships.find(c => c.id === appState.currentChampionshipId)?.rankingId;
                if (!rankingId) {
                    showModal("Erro", "N√£o foi poss√≠vel identificar o ranking deste campeonato.");
                    return;
                }
                
                // Pega o documento do ranking e adiciona o novo jogador
                const rankingDocRef = doc(db, 'users', appState.userId, 'rankings', rankingId);
                const rankingDoc = await getDoc(rankingDocRef);
                const currentPlayers = rankingDoc.exists() ? rankingDoc.data().players : [];
                
                await setDoc(rankingDocRef, { players: [...currentPlayers, newPlayer] });
                // O listener 'listenToGlobalPlayers' vai pegar essa mudan√ßa e atualizar 'globalPlayers'
            }

            // 3. Adiciona ao campeonato
            if (activeChampionship.players.find(p => p.id === playerId)) {
                showModal("Erro", "Este jogador j√° est√° inscrito.");
                return;
            }
            
            const updatedPlayers = [...activeChampionship.players, { id: playerId, name: name }];
            saveActiveChampionship({ ...activeChampionship, players: updatedPlayers });

            input.value = '';
        };

        // Remove Jogador
        const handleRemovePlayer = (playerId) => {
            if (!confirm("Tem certeza que deseja remover este jogador?")) return;
            const updatedPlayers = activeChampionship.players.filter(p => p.id !== playerId);
            saveActiveChampionship({ ...activeChampionship, players: updatedPlayers });
        };
        
        // Gera Grupos
        const handleGenerateGroups = () => {
            const players = [...activeChampionship.players];
            const numPlayers = players.length;
            
            if (numPlayers < 4 || numPlayers % 4 !== 0) {
                showModal("Erro", "O n√∫mero de jogadores deve ser um m√∫ltiplo de 4 (4, 8, 12, 16, etc).");
                return;
            }
            if (!confirm(`Gerar ${numPlayers / 4} grupos com ${numPlayers} jogadores? (A lista de jogadores ser√° bloqueada)`)) return;

            // Sorteio
            const shuffledPlayers = players.sort(() => 0.5 - Math.random());
            const numGroups = numPlayers / 4;
            const newGroups = [];

            for (let i = 0; i < numGroups; i++) {
                const groupPlayers = shuffledPlayers.slice(i * 4, (i * 4) + 4); // Pega 4 jogadores
                
                // Gera os 3 jogos (p1/p2 vs p3/p4), (p1/p3 vs p2/p4), (p1/p4 vs p2/p3)
                const matches = [
                    { p: [groupPlayers[0].id, groupPlayers[1].id, groupPlayers[2].id, groupPlayers[3].id], score: [null, null] },
                    { p: [groupPlayers[0].id, groupPlayers[2].id, groupPlayers[1].id, groupPlayers[3].id], score: [null, null] },
                    { p: [groupPlayers[0].id, groupPlayers[3].id, groupPlayers[1].id, groupPlayers[2].id], score: [null, null] },
                ];

                newGroups.push({
                    players: groupPlayers,
                    matches: matches
                });
            }

            // Salva no banco
            const newChampData = {
                ...activeChampionship,
                status: 'groups',
                groups: newGroups
            };
            saveActiveChampionship(newChampData);
            
            // Atualiza o doc 'resumo'
            const champRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
            setDoc(champRef, { status: 'groups' }, { merge: true });
        };

        // Salva Placar (Grupo)
        const handleGroupScoreChange = (e) => {
            const input = e.target;
            const g_idx = parseInt(input.dataset.group);
            const m_idx = parseInt(input.dataset.match);
            const t_idx = parseInt(input.dataset.team);
            const value = parseInt(input.value);

            if (isNaN(value) || value < 0) return;

            // Pega o placar do "oponente"
            const otherInput = (t_idx === 0)
                ? input.parentElement.querySelector(`input[data-team="1"]`)
                : input.parentElement.querySelector(`input[data-team="0"]`);
            
            const score1 = (t_idx === 0) ? value : parseInt(otherInput.value);
            const score2 = (t_idx === 1) ? value : parseInt(otherInput.value);

            // S√≥ salva se ambos os placares estiverem preenchidos
            if (isNaN(score1) || isNaN(score2)) return;

            // Bloqueia os inputs
            input.readOnly = true;
            otherInput.readOnly = true;

            // Atualiza o estado local (para evitar recarga)
            activeChampionship.groups[g_idx].matches[m_idx].score = [score1, score2];
            
            // Salva no banco
            saveActiveChampionship(activeChampionship);
        };
        
        // Salva Placar (Mata-Mata)
        const handleKnockoutScoreChange = (e) => {
            const input = e.target;
            const matchId = input.dataset.matchId;
            const bracketType = input.dataset.bracket;
            const pairId = input.dataset.pairId;
            const value = parseInt(input.value);

            if (isNaN(value) || value < 0) return;

            const bracket = activeChampionship[bracketType === 'gold' ? 'goldBracket' : 'silverBracket'];
            const match = bracket.find(m => m.id === matchId);
            if (!match) return;

            const [pair1, pair2] = match.pairs;
            const isTeam1 = pair1?.id === pairId;
            
            // Pega o placar do "oponente"
            const otherInput = isTeam1
                ? input.parentElement.parentElement.querySelector(`input[data-pair-id="${pair2?.id}"]`)
                : input.parentElement.parentElement.querySelector(`input[data-pair-id="${pair1?.id}"]`);
            
            const score1 = isTeam1 ? value : parseInt(otherInput.value);
            const score2 = !isTeam1 ? value : parseInt(otherInput.value);

            // S√≥ avan√ßa se ambos os placares estiverem preenchidos
            if (isNaN(score1) || isNaN(score2)) return;
            
            // Define o vencedor
            if (score1 === score2) {
                showModal("Empate", "O placar do mata-mata n√£o pode ser um empate.");
                input.value = '';
                otherInput.value = '';
                return;
            }
            
            const winner = (score1 > score2) ? pair1 : pair2;

            // Atualiza o estado local (para evitar recarga)
            match.score = [score1, score2];
            match.winner = winner;

            // Avan√ßa o vencedor para a pr√≥xima chave
            if (match.nextMatchId) {
                const nextMatch = bracket.find(m => m.id === match.nextMatchId);
                if (nextMatch) {
                    nextMatch.pairs[match.nextMatchSlot] = winner;
                }
            }
            
            // Salva no banco
            saveActiveChampionship(activeChampionship);
        };

        // Finaliza o Campeonato e Distribui os Pontos
        const handleFinalizeChampionship = async () => {
            if (!confirm("Finalizar o Campeonato? Isso ir√° calcular os pontos e pr√™mios e bloquear o mata-mata.")) return;

            const champSummaryRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);
            
            if (!champSummary || !champSummary.rankingId) {
                showModal("Erro Cr√≠tico", "N√£o foi poss√≠vel encontrar o ID do ranking vinculado a este campeonato.");
                return;
            }

            // 1. Encontra os vencedores
            const goldFinal = activeChampionship.goldBracket.find(m => m.nextMatchId === null);
            const silverFinal = activeChampionship.silverBracket.find(m => m.nextMatchId === null);

            if (!goldFinal?.winner || !silverFinal?.winner) {
                showModal("Erro", "A final Ouro e a final Prata precisam estar conclu√≠das.");
                return;
            }

            const winnerGoldPair = goldFinal.winner;
            const runnerUpGoldPair = goldFinal.pairs.find(p => p.id !== winnerGoldPair.id);
            
            const winnerSilverPair = silverFinal.winner;
            const runnerUpSilverPair = silverFinal.pairs.find(p => p.id !== winnerSilverPair.id);

            // 2. Calcula o Coveiro
            const globalStats = getGlobalTournamentStats(activeChampionship);
            const coveiroWinner = globalStats[0]; // O primeiro da lista (menor pontua√ß√£o)
            
            // 3. Monta o 'diff' de pontos para o ranking
            const pointsConfig = champSummary.pointsConfig;
            const pointsDiff = {};

            // Helper para adicionar pontos
            const addDiff = (player, points, gold = 0, silver = 0, coveiro = 0) => {
                if (!player) return;
                if (!pointsDiff[player.id]) {
                    pointsDiff[player.id] = { name: player.name, points: 0, goldWins: 0, silverWins: 0, coveiroWins: 0 };
                }
                pointsDiff[player.id].points += points;
                pointsDiff[player.id].goldWins += gold;
                pointsDiff[player.id].silverWins += silver;
                pointsDiff[player.id].coveiroWins += coveiro;
            };

            // Adiciona pontos de participa√ß√£o
            activeChampionship.players.forEach(p => {
                addDiff(p, pointsConfig.participation);
            });

            // Adiciona pontos Ouro
            winnerGoldPair.players.forEach(p => addDiff(p, pointsConfig.goldWinner, 1));
            runnerUpGoldPair?.players.forEach(p => addDiff(p, pointsConfig.goldRunnerUp));
            
            // Adiciona pontos Prata
            winnerSilverPair.players.forEach(p => addDiff(p, pointsConfig.silverWinner, 0, 1));
            runnerUpSilverPair?.players.forEach(p => addDiff(p, pointsConfig.silverRunnerUp));
            
            // Adiciona pr√™mio Coveiro
            addDiff(coveiroWinner, 0, 0, 0, 1);
            
            try {
                // 4. Aplica a transa√ß√£o no Ranking Global
                await applyRankingDiff(champSummary.rankingId, pointsDiff);

                // 5. Salva o status e os vencedores no documento 'resumo'
                await setDoc(champSummaryRef, {
                    status: 'finished',
                    winnerGold: winnerGoldPair.name,
                    winnerSilver: winnerSilverPair.name,
                    coveiro: coveiroWinner.name,
                    finalPointsAwarded: pointsDiff // Salva o diff para 'revers√£o'
                }, { merge: true });

                // 6. Salva o status no documento 'main' (para bloquear a UI)
                await saveActiveChampionship({ ...activeChampionship, status: 'finished' });
                
                showModal("Campeonato Finalizado!", `
                    <p>Pontos distribu√≠dos com sucesso!</p>
                    <p class="mt-2">ü•á Ouro: ${winnerGoldPair.name}</p>
                    <p>ü•à Prata: ${winnerSilverPair.name}</p>
                    <p class="mt-2">üëª Coveiro: ${coveiroWinner.name} (${coveiroWinner.gamesWon} games)</p>
                `);

            } catch (error) {
                console.error("Erro ao finalizar campeonato:", error);
                showModal("Erro", "N√£o foi poss√≠vel aplicar os pontos ao ranking global. " + error.message);
            }
        };

        // =================================================================
        // === MUDAN√áA (REQUEST 2): Reverter Pontos
        // =================================================================
        const handleRevertPoints = async () => {
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);
            if (!champSummary || champSummary.status !== 'finished') {
                showModal("Erro", "Este campeonato n√£o est√° finalizado.");
                return;
            }

            const pointsDiff = champSummary.finalPointsAwarded;
            if (!pointsDiff) {
                showModal("Erro", "N√£o foram encontrados dados de pontos para reverter. (Campeonato antigo?)");
                return;
            }
            
            if (!confirm("Tem certeza que deseja REVERTER os pontos deste campeonato? Os pontos ser√£o SUBTRA√çDOS do ranking global. (Use isso para corrigir um erro).")) return;
            
            // Inverte o 'diff' (multiplica por -1)
            const reverseDiff = {};
            for (const playerId in pointsDiff) {
                reverseDiff[playerId] = {};
                for (const key in pointsDiff[playerId]) {
                    if (key === 'name') {
                        reverseDiff[playerId][key] = pointsDiff[playerId][key];
                    } else {
                        reverseDiff[playerId][key] = (pointsDiff[playerId][key] || 0) * -1;
                    }
                }
            }

            try {
                // 1. Aplica o diff reverso
                await applyRankingDiff(champSummary.rankingId, reverseDiff);
                
                // 2. Limpa os dados de 'final' no doc resumo
                const champSummaryRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                await setDoc(champSummaryRef, {
                    status: 'knockout', // Volta o status
                    winnerGold: null,
                    winnerSilver: null,
                    coveiro: null,
                    finalPointsAwarded: null // LIMPA o diff
                }, { merge: true });

                // 3. Atualiza o doc 'main'
                await saveActiveChampionship({ ...activeChampionship, status: 'knockout' });

                showModal("Pontos Revertidos!", "Os pontos deste campeonato foram removidos do ranking. O campeonato foi reaberto no Mata-Mata.");

            } catch (error) {
                console.error("Erro ao reverter pontos:", error);
                showModal("Erro", "N√£o foi poss√≠vel reverter os pontos. " + error.message);
            }
        };

        // =================================================================
        // === MUDAN√áA (REQUEST 5): Reabrir Campeonato
        // =================================================================
        const handleReopenChampionship = async () => {
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);
            
            if (!champSummary || champSummary.status !== 'finished') {
                showModal("Erro", "Este campeonato n√£o est√° finalizado.");
                return;
            }

            if (champSummary.finalPointsAwarded) {
                showModal(
                    "A√ß√£o Necess√°ria",
                    "Este campeonato j√° distribuiu pontos ao ranking. Voc√™ DEVE 'Reverter Pontos' antes de reabri-lo para evitar contagem duplicada."
                );
                return;
            }
            
            if (!confirm("Reabrir o mata-mata? (Use isso apenas se voc√™ finalizou sem aplicar pontos e precisa corrigir uma chave).")) return;

            try {
                // 1. Atualiza o doc resumo
                const champSummaryRef = doc(db, 'users', appState.userId, 'championships', appState.currentChampionshipId);
                await setDoc(champSummaryRef, { status: 'knockout' }, { merge: true });

                // 2. Atualiza o doc 'main'
                await saveActiveChampionship({ ...activeChampionship, status: 'knockout' });

                showModal("Campeonato Reaberto", "O mata-mata foi desbloqueado.");

            } catch (error) {
                console.error("Erro ao reabrir:", error);
                showModal("Erro", "N√£o foi poss√≠vel reabrir o campeonato.");
            }
        };

        // =================================================================
        // === MUDAN√áA (REQUEST 4): Gerar PDF do Campeonato
        // =================================================================
        const handlePrintChampionshipPDF = () => {
            if (!activeChampionship) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const champSummary = championships.find(c => c.id === appState.currentChampionshipId);
            const title = champSummary?.name || "Campeonato";
            const date = new Date(champSummary?.createdAt.toDate()).toLocaleDateString();

            doc.setFontSize(18);
            doc.text(`üéæ ${title}`, 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Data: ${date}`, 14, 28);
            
            let yPos = 40;

            // 1. Pr√™mios (Se finalizado)
            if (activeChampionship.status === 'finished') {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("üèÜ Vencedores", 14, yPos);
                yPos += 8;
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.autoTable({
                    startY: yPos,
                    theme: 'plain',
                    body: [
                        ['ü•á Ouro', champSummary.winnerGold || 'N/A'],
                        ['ü•à Prata', champSummary.winnerSilver || 'N/A'],
                        ['üëª Coveiro', champSummary.coveiro || 'N/A'],
                    ],
                    styles: { fontSize: 11 }
                });
                yPos = doc.autoTable.previous.finalY + 15;
            }

            // 2. Ranking Coveiro (Todos os jogadores)
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("üëª Ranking Coveiro (Total de Games)", 14, yPos);
            yPos += 8;
            
            const globalStats = getGlobalTournamentStats(activeChampionship);
            const coveiroData = globalStats.map((p, index) => [
                `${index + 1}¬∫`,
                p.name,
                `${p.gamesWon} games`
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Pos.', 'Jogador', 'Games Ganhos (Grupos + Mata-Mata)']],
                body: coveiroData,
                theme: 'striped',
                headStyles: { fillColor: [203, 213, 225] }, // bg-gray-300
                styles: { fontSize: 10 }
            });
            yPos = doc.autoTable.previous.finalY + 15;

            // 3. Fase de Grupos
            if (activeChampionship.groups.length > 0) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("üé≤ Fase de Grupos", 14, yPos);
                yPos += 8;

                activeChampionship.groups.forEach((group, index) => {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Grupo ${index + 1}`, 14, yPos);
                    yPos += 6;

                    const rankings = getRankings(group);
                    const groupData = rankings.map((p, r_idx) => [
                        `${r_idx + 1}¬∫`,
                        p.name,
                        `${p.gamesWon} games`
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Pos.', 'Jogador', 'Games']],
                        body: groupData,
                        theme: 'grid',
                        headStyles: { fillColor: [254, 243, 199] }, // bg-amber-100
                        styles: { fontSize: 10 },
                        didDrawPage: (data) => { yPos = data.cursor.y; }
                    });
                    yPos = doc.autoTable.previous.finalY + 8;
                });
            }
            
            // 4. Mata-Mata (Em nova p√°gina)
            if (activeChampionship.goldBracket.length > 0) {
                doc.addPage();
                yPos = 22;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("‚öîÔ∏è Chaves Mata-Mata", 14, yPos);
                yPos += 10;
                
                doc.setFontSize(12);
                doc.text("S√©rie Ouro ü•á", 14, yPos);
                yPos += 7;
                
                const goldData = activeChampionship.goldBracket.map(match => [
                    `Rodada ${match.round}`,
                    `${match.pairs[0]?.name || 'N/D'} (${match.score[0] ?? '-'})`,
                    `${match.pairs[1]?.name || 'N/D'} (${match.score[1] ?? '-'})`,
                    match.winner?.name || 'Aguardando...'
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['Rodada', 'Dupla 1 (Placar)', 'Dupla 2 (Placar)', 'Vencedor']],
                    body: goldData,
                    theme: 'striped',
                    headStyles: { fillColor: [254, 236, 166] }, // Cor Ouro
                    styles: { fontSize: 9 }
                });
                yPos = doc.autoTable.previous.finalY + 10;
                
                doc.setFontSize(12);
                doc.text("S√©rie Prata ü•à", 14, yPos);
                yPos += 7;

                const silverData = activeChampionship.silverBracket.map(match => [
                    `Rodada ${match.round}`,
                    `${match.pairs[0]?.name || 'N/D'} (${match.score[0] ?? '-'})`,
                    `${match.pairs[1]?.name || 'N/D'} (${match.score[1] ?? '-'})`,
                    match.winner?.name || 'Aguardando...'
                ]);

                doc.autoTable({
                    startY: yPos,
                    head: [['Rodada', 'Dupla 1 (Placar)', 'Dupla 2 (Placar)', 'Vencedor']],
                    body: silverData,
                    theme: 'striped',
                    headStyles: { fillColor: [209, 213, 219] }, // Cor Prata
                    styles: { fontSize: 9 }
                });
            }

            doc.save(`Campeonato_${champSummary.name.replace(/ /g, '_')}.pdf`);
        };


        /* =============================================================================
           Inicializa√ß√£o e Listeners do Firebase
           ============================================================================= */

        const initApp = () => {
            console.log("App inicializado.");
            loadingSpinner.classList.remove('hidden');
            
            // 1. Autentica√ß√£o An√¥nima
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Auth State: Usu√°rio conectado (UID)", user.uid);
                    
                    // =================================================================
                    // === MUDAN√áA (REQUEST 1): For√ßa o ID Mestre
                    // =================================================================
                    appState.userId = MESTRE_USER_ID; 
                    appState.isAuthReady = true;
                    console.log("Auth State: For√ßando ID Mestre:", appState.userId);
                    userIdFooter.textContent = appState.userId; // Mostra o ID Mestre no rodap√©

                    // Pega par√¢metros da URL (para Modo Tel√£o)
                    const urlParams = new URLSearchParams(window.location.search);
                    const telaoChampId = urlParams.get('champ');
                    
                    // 2. Inicia os listeners globais (necess√°rios para ambos os modos)
                    listenToChampionships();
                    listenToRankingsList(); // Esta fun√ß√£o vai chamar listenToGlobalPlayers()

                    if (urlParams.has('telao') && telaoChampId) {
                        // --- MODO TEL√ÉO ---
                        appState.isTelaoMode = true;
                        appState.isAdmin = false; // Tel√£o √© sempre visitante

                        // Adiciona estilos para a view limpa
                        const telaoStyles = document.createElement('style');
                        telaoStyles.innerHTML = `
                            body { background-color: #FFFAF0; } /* Fundo 'Areia' (amber-50) */
                            /* Ajusta o container para telas largas, mantendo um padding */
                            #app-container { max-width: 100%; padding: 1rem 2rem; }
                            header, footer { display: none !important; }
                        `;
                        document.head.appendChild(telaoStyles);

                        // Navega direto para o tel√£o
                        navigateTo('telaoView', telaoChampId);

                    } else {
                        // --- MODO NORMAL ---
                        appState.isTelaoMode = false;
                        navigateTo('login');
                    }
                }
            });

            // Tenta o login an√¥nimo (agora for√ßar√° o ID Mestre)
            signInAnonymously(auth).catch((error) => {
                console.error("Erro no login an√¥nimo:", error);
                showModal("Erro de Conex√£o", "N√£o foi poss√≠vel conectar ao servidor. Verifique sua internet.");
            });
        };
        
        // Listener: Lista de Rankings (Temporadas)
        const listenToRankingsList = () => {
            if (!appState.userId) return;
            unsubscribeRankingsList(); // Desliga o listener antigo

            const docRef = doc(db, 'users', appState.userId, 'app_data', 'rankings');
            unsubscribeRankingsList = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().list.length > 0) {
                    allRankings = docSnap.data().list;
                    // Se nenhum ranking estiver selecionado, seleciona o primeiro
                    if (!appState.currentRankingId) {
                        appState.currentRankingId = allRankings[0].id;
                    }
                } else {
                    // Se n√£o existir, cria o ranking "Geral"
                    allRankings = [{ id: 'geral-2024', name: 'Ranking Geral 2024' }];
                    appState.currentRankingId = allRankings[0].id;
                    // Salva o ranking padr√£o
                    setDoc(docRef, { list: allRankings }).catch(e => console.error("Erro ao criar ranking padr√£o:", e));
                }
                
                // Dispara o listener de players (agora que sabemos o rankingId)
                listenToGlobalPlayers();
                
                // Re-renderiza se a lista de campeonatos j√° estiver na tela
                if (appState.currentView === 'championshipList') {
                    render();
                }

            }, (error) => {
                console.error("Erro ao escutar lista de rankings:", error);
                showModal("Erro de Leitura", "N√£o foi poss√≠vel carregar a lista de rankings (temporadas).");
            });
        };
        
        // Listener: Jogadores do Ranking Global (ATUALIZADO)
        const listenToGlobalPlayers = () => {
            if (!appState.userId || !appState.currentRankingId) return;
            unsubscribeGlobalPlayers(); // Desliga o listener antigo

            // A "cole√ß√£o" de rankings agora √© um documento por ranking
            const rankingDocRef = doc(db, 'users', appState.userId, 'rankings', appState.currentRankingId);
            
            unsubscribeGlobalPlayers = onSnapshot(rankingDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    // O documento 'players' agora √© a pr√≥pria lista
                    globalPlayers = docSnap.data().players || [];
                } else {
                    globalPlayers = []; // Ranking existe mas n√£o tem jogadores
                }
                
                // Re-renderiza a view atual se ela depender dessa lista
                if (appState.currentView === 'globalRanking' || appState.currentView === 'registration') {
                    render();
                }

            }, (error) => {
                console.error("Erro ao escutar jogadores do ranking:", error);
                showModal("Erro de Leitura", "N√£o foi poss√≠vel carregar os jogadores do ranking.");
                globalPlayers = [];
                render();
            });
        };

        // Listener: Lista de Campeonatos (Resumo)
        const listenToChampionships = () => {
            if (!appState.userId) return;
            unsubscribeChampionships(); // Desliga o listener antigo

            const q = query(collection(db, 'users', appState.userId, 'championships'));
            
            unsubscribeChampionships = onSnapshot(q, (querySnapshot) => {
                championships = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Re-renderiza a lista de campeonatos se estivermos nela
                if (appState.currentView === 'championshipList') {
                    render();
                }
            }, (error) => {
                console.error("Erro ao escutar campeonatos:", error);
                showModal("Erro de Leitura", "N√£o foi poss√≠vel carregar o hist√≥rico de campeonatos.");
            });
        };

        // Listener: Campeonato Ativo (Dados Detalhados)
        const listenToActiveChampionship = (champId) => {
            if (!appState.userId || !champId) return;
            unsubscribeActiveChampionship(); // Desliga o listener antigo

            const docRef = doc(db, 'users', appState.userId, 'championships', champId, 'data', 'main');
            
            unsubscribeActiveChampionship = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    activeChampionship = docSnap.data();
                } else {
                    console.warn("Documento 'main' do campeonato n√£o encontrado. (Pode ter sido exclu√≠do)");
                    activeChampionship = null;
                    if (appState.currentView === 'championshipView' || appState.currentView === 'telaoView') {
                        navigateTo('championshipList'); // Volta para a lista
                        showModal("Erro", "Os dados deste campeonato n√£o foram encontrados.");
                    }
                }
                
                // Renderiza a view (agora temos os dados)
                if (appState.currentView === 'championshipView' || appState.currentView === 'telaoView') {
                    render();
                }
            }, (error) => {
                console.error("Erro ao escutar campeonato ativo:", error);
                showModal("Erro de Leitura", "N√£o foi poss√≠vel carregar os dados deste campeonato.");
            });
        };

        // Inicia o Aplicativo
        initApp();

    </script>
</body>
</html>
